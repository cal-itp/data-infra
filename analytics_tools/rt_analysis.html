
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RT Analysis Module &#8212; Cal-ITP Data Services</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Saving Code" href="saving_code.html" />
    <link rel="prev" title="Scripts" href="scripts.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SZB618VNBZ"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-SZB618VNBZ');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/calitp_logo_MAIN.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Cal-ITP Data Services</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Data Services Documentation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Analysts
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_welcome/overview.html">
   Welcome!
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_welcome/what_is_calitp.html">
     Cal-ITP Project Information
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_welcome/how_we_work.html">
     How We Work
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analytics_onboarding/overview.html">
   Technical Onboarding
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="overview.html">
   Introduction to Analytics Tools
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="github_setup.html">
     GitHub Setup
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tools_quick_links.html">
     Tools Quick Links
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="bi_dashboards.html">
     Business Insights &amp; Dashboards
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="jupyterhub.html">
     JupyterHub
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="local_oracle_db_connections.html">
     Local Oracle Database Connections
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="python_libraries.html">
     Useful Python Libraries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="scripts.html">
     Scripts
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     RT Analysis Module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="saving_code.html">
     Saving Code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="storing_data.html">
     Storing Data During Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="data_catalogs.html">
     Using Data Catalogs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="knowledge_sharing.html">
     Helpful Links
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_new_analysts/overview.html">
   Tutorials for New Python Users
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/01-data-analysis-intro.html">
     Data Analysis: Intro
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/02-data-analysis-intermediate.html">
     Data Analysis: Intermediate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/03-data-management.html">
     Data Management
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/04-notebooks.html">
     Working with Jupyter notebooks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/05-spatial-analysis-basics.html">
     Working with Geospatial Data: Basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/06-spatial-analysis-intro.html">
     Working with Geospatial Data: Intro
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/07-spatial-analysis-intermediate.html">
     Working with Geospatial Data: Intermediate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/08-spatial-analysis-advanced.html">
     Working with Geospatial Data: Advanced
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../warehouse/overview.html">
   Introduction to the Warehouse
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/warehouse_starter_kit.html">
     Warehouse: Where to Begin
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/navigating_dbt_docs.html">
     Navigating the dbt Docs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/what_is_agency.html">
     What is an
     <code class="docutils literal notranslate">
      <span class="pre">
       agency
      </span>
     </code>
     ?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/developing_dbt_models.html">
     Developing models in dbt
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/adding_oneoff_data.html">
     Adding Ad-Hoc Data to the Warehouse
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/what_is_gtfs.html">
     What is GTFS, anyway?
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../publishing/overview.html">
   Where can I publish data?
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/1_publishing_principles.html">
     Data Publishing Principles
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/2_static_files.html">
     Static Visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/3_github_pages.html">
     HTML Visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/4_analytics_portfolio_site.html">
     The Cal-ITP Analytics Portfolio
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/5_notebooks_styling.html">
     Getting Notebooks Ready for the Portfolio
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/6_metabase.html">
     Metabase
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/7_gcs.html">
     GCS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/8_ckan.html">
     Publishing data to California Open Data aka CKAN
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/9_geoportal.html">
     Publishing data to California State Geoportal
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Developers
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../architecture/architecture_overview.html">
   Architecture Overview
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../architecture/services.html">
     Deployed Services and Sites
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../architecture/images_and_packages.html">
     Published Images and Packages
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../architecture/data.html">
     Data pipelines
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../airflow/dags-maintenance.html">
   Airflow Operational Considerations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../transit_database/transitdatabase.html">
   Transit Database (Airtable)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contribute to the Docs!
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../contribute/overview.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/contribute-best-practices.html">
     Best Practices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/submitting_changes.html">
     Submitting Changes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/content_types.html">
     Common Content
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/analytics_tools/rt_analysis.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/cal-itp/data-infra/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/cal-itp/data-infra//issues/new?title=Issue%20on%20page%20%2Fanalytics_tools/rt_analysis.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/cal-itp/data-infra/edit/main/docs/analytics_tools/rt_analysis.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#start-here">
   Start Here
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#which-analyses-does-it-currently-support">
     Which analyses does it currently support?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-does-it-work">
   How does it work?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#which-data-does-it-require">
     Which data does it require?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-is-it-structured">
     How is it structured?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rt-parser-making-sense-of-vehicle-positions">
     <code class="docutils literal notranslate">
      <span class="pre">
       rt_parser
      </span>
     </code>
     : making sense of Vehicle Positions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#what-happens-at-the-operatordayanalysis-stage">
       <strong>
        What happens at the OperatorDayAnalysis stage?
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#gathering-data">
       Gathering Data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#asserts-data-checks">
       Asserts/Data Checks
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generate-position-interpolators">
       Generate Position Interpolators
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generate-stop-delay-view">
       Generate Stop Delay View
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#vehiclepositionsinterpolator-a-foundational-building-block">
       <strong>
        VehiclePositionsInterpolator: a foundational building block
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#constructor">
       Constructor
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#basic-logging">
       Basic Logging
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#projection">
       Projection
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#interpolating-quickly">
       Interpolating, quickly
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#saving-intermediate-data-largely-automatically">
       Saving Intermediate Data (largely automatically)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-do-i-use-it">
   How do I use it?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#viewing-data-availability-or-starting-from-scratch">
     Viewing Data Availability (or starting from scratch)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rt-filter-map-plot-your-flexible-analytics-and-mapping-interface">
     <code class="docutils literal notranslate">
      <span class="pre">
       rt_filter_map_plot
      </span>
     </code>
     : your flexible analytics and mapping interface
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#loading-intermediate-data-largely-automatically">
       Loading Intermediate Data (largely automatically)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#filtering">
       Filtering
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#mapping">
       Mapping
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#more-performant-maps-via-embedded-app">
       More performant maps via embedded app
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#stop-segment-speed-view">
       <code class="docutils literal notranslate">
        <span class="pre">
         stop_segment_speed_view
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#other-charts-and-metrics">
       Other Charts and Metrics
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#corridor-analysis">
       Corridor Analysis
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-workflow-california-transit-speed-maps">
   Example Workflow: California Transit Speed Maps
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-workflow-sccp">
   Example Workflow: SCCP
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>RT Analysis Module</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#start-here">
   Start Here
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#which-analyses-does-it-currently-support">
     Which analyses does it currently support?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-does-it-work">
   How does it work?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#which-data-does-it-require">
     Which data does it require?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-is-it-structured">
     How is it structured?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rt-parser-making-sense-of-vehicle-positions">
     <code class="docutils literal notranslate">
      <span class="pre">
       rt_parser
      </span>
     </code>
     : making sense of Vehicle Positions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#what-happens-at-the-operatordayanalysis-stage">
       <strong>
        What happens at the OperatorDayAnalysis stage?
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#gathering-data">
       Gathering Data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#asserts-data-checks">
       Asserts/Data Checks
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generate-position-interpolators">
       Generate Position Interpolators
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generate-stop-delay-view">
       Generate Stop Delay View
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#vehiclepositionsinterpolator-a-foundational-building-block">
       <strong>
        VehiclePositionsInterpolator: a foundational building block
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#constructor">
       Constructor
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#basic-logging">
       Basic Logging
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#projection">
       Projection
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#interpolating-quickly">
       Interpolating, quickly
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#saving-intermediate-data-largely-automatically">
       Saving Intermediate Data (largely automatically)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-do-i-use-it">
   How do I use it?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#viewing-data-availability-or-starting-from-scratch">
     Viewing Data Availability (or starting from scratch)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rt-filter-map-plot-your-flexible-analytics-and-mapping-interface">
     <code class="docutils literal notranslate">
      <span class="pre">
       rt_filter_map_plot
      </span>
     </code>
     : your flexible analytics and mapping interface
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#loading-intermediate-data-largely-automatically">
       Loading Intermediate Data (largely automatically)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#filtering">
       Filtering
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#mapping">
       Mapping
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#more-performant-maps-via-embedded-app">
       More performant maps via embedded app
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#stop-segment-speed-view">
       <code class="docutils literal notranslate">
        <span class="pre">
         stop_segment_speed_view
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#other-charts-and-metrics">
       Other Charts and Metrics
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#corridor-analysis">
       Corridor Analysis
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-workflow-california-transit-speed-maps">
   Example Workflow: California Transit Speed Maps
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-workflow-sccp">
   Example Workflow: SCCP
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="rt-analysis-module">
<h1>RT Analysis Module<a class="headerlink" href="#rt-analysis-module" title="Permalink to this headline">¶</a></h1>
<div class="section" id="start-here">
<h2>Start Here<a class="headerlink" href="#start-here" title="Permalink to this headline">¶</a></h2>
<p>This module, rt_analysis, applies various spatial processing, interpolation, and aggregation techniques in order to transform GTFS and GTFS-Realtime data into intermediate data products and production-ready visualizations. It can be found on GitHub at <a class="reference external" href="https://github.com/cal-itp/data-analyses/tree/main/rt_delay/rt_analysis">https://github.com/cal-itp/data-analyses/tree/main/rt_delay/rt_analysis</a></p>
<p>It includes its own interface and data model. Some functionality may shift to a more automated part of the pipeline in the future.</p>
<div class="section" id="which-analyses-does-it-currently-support">
<h3>Which analyses does it currently support?<a class="headerlink" href="#which-analyses-does-it-currently-support" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://analysis.calitp.org/rt/README.html">California Transit Speed Maps</a></p></li>
<li><p>Technical Metric Generation for Solutions for Congested Corridors Program, Local Partnership Program</p></li>
<li><p>Various prioritization exercises from intermediate data, such as using aggregated speed data as an input for identifying bus route improvements as part of a broader model</p></li>
<li><p>Various ad-hoc speed and delay analyses, such as highlighting relevant examples for presentations to stakeholders, or providing a shapefile of bus speeds on certain routes to support a district’s grant application</p></li>
</ul>
</div>
</div>
<div class="section" id="how-does-it-work">
<h2>How does it work?<a class="headerlink" href="#how-does-it-work" title="Permalink to this headline">¶</a></h2>
<p>This section includes detailed information about the data model and processing steps. Feel free to skip ahead to “How do I use it?” if you need a quicker start.</p>
<div class="section" id="which-data-does-it-require">
<h3>Which data does it require?<a class="headerlink" href="#which-data-does-it-require" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>GTFS-RT Vehicle Positions</p></li>
<li><p>GTFS Schedule Trips</p></li>
<li><p>GTFS Schedule Stops</p></li>
<li><p>GTFS Schedule Routes</p></li>
<li><p>GTFS Schedule Stop Times</p></li>
<li><p>GTFS Schedule Shapes</p></li>
</ul>
<p>All of the above are sourced from the v2 warehouse. Note that all components must be present and consistently keyed in order to successfully analyze. This module works at the organization level in order to match the reports site and maintain the structure of the speedmap site.</p>
<p>For each organization, this module will combine and analyze all related GTFS Schedule and GTFS Realtime datasets that are <code class="docutils literal notranslate"><span class="pre">public_customer_facing_or_regional_subfeed_fixed_route</span></code> in <a class="reference external" href="https://dbt-docs.calitp.org/#%21/model/model.calitp_warehouse.dim_provider_gtfs_data"><code class="docutils literal notranslate"><span class="pre">dim_provider_gtfs_data</span></code></a>. Some organizations share GTFS datasets (Sacramento RT and City of Rancho Cordova, San Diego Airport and San Diego MTS…), in those cases the module can generate separate analysis for each organization but they might duplicate each other. These are based on the underlying organization/dataset relationships in the Transit Database (Airtable).</p>
</div>
<div class="section" id="how-is-it-structured">
<h3>How is it structured?<a class="headerlink" href="#how-is-it-structured" title="Permalink to this headline">¶</a></h3>
<p>The module is split into two major components, <code class="docutils literal notranslate"><span class="pre">rt_parser</span></code>, which generates intermediate data for detailed analysis, and <code class="docutils literal notranslate"><span class="pre">rt_filter_map_plot</span></code>, which provides a rich interface to analyze and generate products like speed maps.</p>
</div>
<div class="section" id="rt-parser-making-sense-of-vehicle-positions">
<h3><code class="docutils literal notranslate"><span class="pre">rt_parser</span></code>: making sense of Vehicle Positions<a class="headerlink" href="#rt-parser-making-sense-of-vehicle-positions" title="Permalink to this headline">¶</a></h3>
<div class="mermaid">
            flowchart TD
    subgraph warehouse[&quot;Warehouse Data&quot;]
        vp{{GTFS-RT Vehicle Positions}}
        routes[GTFS Routes] --&gt;|id, names| trips[GTFS Trips]
        stops[GTFS Stops]
        st[GTFS Stop Times]
        shapes[GTFS Shapes]
    end
    %% OperatorDayAnalysis processing step
    subgraph op_day[&quot;OperatorDayAnalysis&quot;]
        subgraph per_shp[process per shape:]
            add_1k(add 1km segments if stops far apart)
        end
        subgraph per_trp[process per trip:]
            gen_int(generate interpolator object)
            store_int(self.position_interpolators) --&gt;
            gen_sdv(generate stop_delay_view)
        end
        subgraph int_data[finished intermediate data]
            stop_delay[&quot;self.stop_delay_view (all trips)&quot;]
            rt_trips[&quot;self.rt_trips (trip-level info)&quot;]
        end
        %% local links
        gen_int --&gt; vp_int --&gt; store_int
        per_shp --&gt; per_trp --&gt;|combine all trips| int_data
        --&gt;|self.export_views_gcs| gcs[(&quot;GCS (calitp-analytics-data/data_analyses/rt_delay)&quot;)]
    end
    %% VehiclePositionsInterpolator
    subgraph vp_int[&quot;VehiclePositionsInterpolator&quot;]
        ck_data[check data quality] --&gt;
        proj[project vehicle positions to shape] --&gt;
        cast[cast to monotonic increasing] ---
        interface(&quot;interpolation interface: self.time_at_position&quot;)
    end
    %% top level links
    warehouse --&gt;|single day of data| op_day
        </div><div class="section" id="what-happens-at-the-operatordayanalysis-stage">
<h4><strong>What happens at the OperatorDayAnalysis stage?</strong><a class="headerlink" href="#what-happens-at-the-operatordayanalysis-stage" title="Permalink to this headline">¶</a></h4>
<p>The OperatorDayAnalysis class is the top-level class for processing a day’s worth of data and outputting intermediate data to be used later for mapping and analysis through the RtFilterMapper interface. It’s useful to understand how it works when analyzing an organization’s RT data on a date for the first time, though once this is accomplished nearly any analysis need can be fulfilled without regenerating OperatorDayAnalysis.</p>
<p>An OperatorDayAnalysis is generated for a specific organization on a specific date.</p>
</div>
<div class="section" id="gathering-data">
<h4>Gathering Data<a class="headerlink" href="#gathering-data" title="Permalink to this headline">¶</a></h4>
<p>First, OperatorDayAnalysis gathers GTFS and GTFS Realtime Vehicle Positions data for the feed and date selected (for a complete list of source data, see above).</p>
</div>
<div class="section" id="asserts-data-checks">
<h4>Asserts/Data Checks<a class="headerlink" href="#asserts-data-checks" title="Permalink to this headline">¶</a></h4>
<p>This step checks for the presence of Vehicle Positions data, with trip_ids matching schedule data, as well as the presence of GTFS Shapes data describing at least 90% of scheduled trips.</p>
</div>
<div class="section" id="generate-position-interpolators">
<h4>Generate Position Interpolators<a class="headerlink" href="#generate-position-interpolators" title="Permalink to this headline">¶</a></h4>
<p>This step attempts to generate VehiclePositionInterpolator objects for all trips for which data is present. For a detailed description, see below.</p>
</div>
<div class="section" id="generate-stop-delay-view">
<h4>Generate Stop Delay View<a class="headerlink" href="#generate-stop-delay-view" title="Permalink to this headline">¶</a></h4>
<p>This step uses the generated interpolator objects to estimate and store speed and delay information for every trip at each stop. Where stops are less frequent we add “virtual stops” every kilometer to support granular analysis of express and rural transit routes.</p>
<p>The results of this step are saved in OperatorDayAnalysis.stop_delay_view, a geodataframe.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p></p></th>
<th class="head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Column</p></td>
<td><p>Source</p></td>
<td><p>Type</p></td>
</tr>
<tr class="row-odd"><td><p>shape_meters</p></td>
<td><p>Projection of GTFS Stop along GTFS Shape (with 0 being start of shape), additionally 1km segments generated where stops are infrequent</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>stop_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string*</p></td>
</tr>
<tr class="row-odd"><td><p>stop_name</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string*</p></td>
</tr>
<tr class="row-even"><td><p>geometry</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>geometry</p></td>
</tr>
<tr class="row-odd"><td><p>shape_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>trip_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>stop_sequence</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>float64**</p></td>
</tr>
<tr class="row-even"><td><p>arrival_time</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>np.datetime64[ns]*</p></td>
</tr>
<tr class="row-odd"><td><p>route_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>route_short_name</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>direction_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>actual_time</p></td>
<td><p>VehiclePositionInterpolator</p></td>
<td><p>np.datetime64[ns]</p></td>
</tr>
<tr class="row-odd"><td><p>delay_seconds</p></td>
<td><p>Calculated here (actual_time-arrival_time)***</p></td>
<td><p>float64*</p></td>
</tr>
</tbody>
</table>
<p>*null if location is an added 1km segment</p>
<p>**integer values from GTFS, but added 1km segments are inserted in between the nearest 2 stops with a decimal</p>
<p>***early arrivals currently represented as zero delay</p>
</div>
<div class="section" id="vehiclepositionsinterpolator-a-foundational-building-block">
<h4><strong>VehiclePositionsInterpolator: a foundational building block</strong><a class="headerlink" href="#vehiclepositionsinterpolator-a-foundational-building-block" title="Permalink to this headline">¶</a></h4>
<p>Analyzing speed and position from GTFS-RT Vehicle Positions data requires somewhat complex algorithms for each trip. In this module, these are implemented in the VehiclePositionsInterpolator class. When analyzing a day’s worth of data, the module generates an instance of VehiclePositionsInterpolator for each trip with Vehicle Positions data. There’s little need to interact with VehiclePositionsInterpolator directly for most uses.</p>
</div>
<div class="section" id="constructor">
<h4>Constructor<a class="headerlink" href="#constructor" title="Permalink to this headline">¶</a></h4>
<p>The constructor takes two arguments: a geodataframe of Vehicle Positions data, filtered to a single trip and joined with trip identifier information from GTFS Schedule, and a geodataframe of GTFS Shapes as line geometries, which must include the shape of the trip of interest. When constructed, it runs several data checks, enforcing that: Vehicle Positions and Shapes data are provided, both geodataframes have the same coordinate reference system (CA_NAD83Albers), and that Vehicle Positions data is only provided for a single trip and contains the required identifier information.</p>
</div>
<div class="section" id="basic-logging">
<h4>Basic Logging<a class="headerlink" href="#basic-logging" title="Permalink to this headline">¶</a></h4>
<p>VehiclePositionsInterpolator has simple logging functionality built in through the VehiclePositionsInterpolator.logassert method. This method is a simple wrapper to Python’s assert keyword that also uses Python’s built in logging module to log which error occurred before raising an AssertionError. By default, the logfile will be <code class="docutils literal notranslate"><span class="pre">./rt_log</span></code>.</p>
</div>
<div class="section" id="projection">
<h4>Projection<a class="headerlink" href="#projection" title="Permalink to this headline">¶</a></h4>
<p>Vehicle Positions data includes a series of positions for a single trip at different points in time. Since we’re interested in tracking speed and delay along the transit route, we need to project those lat/long positions to a linear reference along the actual transit route (GTFS Shape). This is accomplished by the constructor calling VehiclePositionsInterpolator._attach_shape, which first does a naive projection of each position using shapely.LineString.project. This linearly referenced value is stored in the shape_meters column.</p>
<p>Since later stages will have to interpolate these times and positions, it’s necessary to undertake some additional data cleaning. This happens by calling VehiclePositionsInterpolator._linear_reference, which casts shape_meters to be monotonically increasing with respect to time. This removes multiple position reports at the same location, as well as any positions that suggest the vehicle traveled backwards along the route. While this introduces the assumption that the GPS-derived Vehicle Positions data is fairly accurate, our experience is that this process produces good results in most cases. Future updates will better accommodate <a class="reference external" href="https://gtfs.org/schedule/best-practices/#shapestxt">looping and inlining</a>; these currently get dropped in certain cases, which is undesirable.</p>
</div>
<div class="section" id="interpolating-quickly">
<h4>Interpolating, quickly<a class="headerlink" href="#interpolating-quickly" title="Permalink to this headline">¶</a></h4>
<p>As you might expect, the main purpose of VehiclePositionsInterpolator is to provide a fast interface to estimate when a trip arrived at a point of interest (generally a transit stop or segment boundary) based on the two known nearest positions.</p>
<p>VehiclePositionsInterpolator.time_at_position(self, desired_position) provides this interface. Desired position is given in meters, with zero being the start of the GTFS Shape. If the position requested is within the spatial bounds of Vehicle Position data for the trip, this method will quickly return the estimated timestamp using a fast numpy array function, further sped up with <a class="reference external" href="https://numba.pydata.org/">numba</a>.</p>
</div>
<div class="section" id="saving-intermediate-data-largely-automatically">
<h4>Saving Intermediate Data (largely automatically)<a class="headerlink" href="#saving-intermediate-data-largely-automatically" title="Permalink to this headline">¶</a></h4>
<p>Intermediate data is saved using OperatorDayAnalysis.export_views_gcs()</p>
<p>This method saves 2 artifacts: a geoparquet of OperatorDayAnalysis.stop_delay_view and a parquet of OperatorDayAnalysis.rt_trips. These are saved in Google Cloud Storage at calitp-analytics-data/data-analyses/rt_delay/stop_delay_views and calitp-analytics-data/data-analyses/rt_delay/rt_trips respectively.</p>
<p>rt_trips is a dataframe of trip-level information for every trip for which a VehiclePositionsInterpolator was successfully generated. It supports filtering by various attributes and provides useful contextual information for maps and analyses.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p></p></th>
<th class="head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Column</p></td>
<td><p>Source</p></td>
<td><p>Type</p></td>
</tr>
<tr class="row-odd"><td><p>feed_key*</p></td>
<td><p>v2 warehouse (gtfs mart)</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>trip_key</p></td>
<td><p>Key from v2 warehouse</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>gtfs_dataset_key*</p></td>
<td><p>v2 warehouse (gtfs mart)</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>activity_date</p></td>
<td><p>v2 warehouse</p></td>
<td><p>datetime.date</p></td>
</tr>
<tr class="row-odd"><td><p>trip_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>route_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>route_short_name</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>shape_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>direction_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>route_type</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>route_long_name</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>route_desc</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>route_long_name</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>calitp_itp_id</p></td>
<td><p>v2 warehouse (transit database)</p></td>
<td><p>int64</p></td>
</tr>
<tr class="row-odd"><td><p>median_time</p></td>
<td><p>VehiclePositionsInterpolator</p></td>
<td><p>datetime.time</p></td>
</tr>
<tr class="row-even"><td><p>direction</p></td>
<td><p>VehiclePositionsInterpolator</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>mean_speed_mph</p></td>
<td><p>VehiclePositionsInterpolator</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>organization_name</p></td>
<td><p>v2 warehouse (transit database)</p></td>
<td><p>string</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>keys and IDs in this table refer to GTFS Schedule datasets</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="how-do-i-use-it">
<h2>How do I use it?<a class="headerlink" href="#how-do-i-use-it" title="Permalink to this headline">¶</a></h2>
<div class="section" id="viewing-data-availability-or-starting-from-scratch">
<h3>Viewing Data Availability (or starting from scratch)<a class="headerlink" href="#viewing-data-availability-or-starting-from-scratch" title="Permalink to this headline">¶</a></h3>
<p>Use shared_utils.rt_utils.get_operators to see dates and feeds with the core analysis already run and intermediate data available. With the v2 warehouse transition, this module is currently set to only generate new data from Jan 1, 2023 onward. If necessary, we can run older dates from v2 data after confirming that the organization/dataset mapping is as-desired. Intermediate data available from this utility from before 2023 is currently based off of prior v1 warehouse results, which may include different underlying datasets from current results.</p>
<p>To support commonality with other analyses, this module now generates the core analysis for dates recorded in <a class="reference external" href="https://github.com/cal-itp/data-analyses/blob/main/_shared_utils/shared_utils/rt_dates.py">data_analyses/shared_utils/rt_dates.py</a>.</p>
<p>Intermediate data for those selected dates will usually be already generated as part of the speedmap deployment process. For reference, if not already ran, use the OperatorDayAnalysis constructor to generate the core analysis and save intermediate data for the dates and feeds of interest. Note that this process can be time-consuming, especially for larger feeds like LA Metro.</p>
<p>This function supports an optional progress bar argument to show analysis progress. First make sure tqdm is installed, then create a blank progress bar and provide that as an argument to the function (see example notebook). Note that you may have to <a class="reference external" href="https://github.com/tqdm/tqdm/issues/394#issuecomment-384743637">enable the jupyter extension</a>.</p>
<p>For example, to generate data for Big Blue Bus on April 12, 2023:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rt_analysis</span> <span class="kn">import</span> <span class="n">rt_parser</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">()</span>
<span class="n">rt_day</span> <span class="o">=</span> <span class="n">rt_parser</span><span class="o">.</span><span class="n">OperatorDayAnalysis</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">pbar</span><span class="p">)</span>
<span class="n">rt_day</span><span class="o">.</span><span class="n">export_views_gcs</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="rt-filter-map-plot-your-flexible-analytics-and-mapping-interface">
<h3><code class="docutils literal notranslate"><span class="pre">rt_filter_map_plot</span></code>: your flexible analytics and mapping interface<a class="headerlink" href="#rt-filter-map-plot-your-flexible-analytics-and-mapping-interface" title="Permalink to this headline">¶</a></h3>
<div class="mermaid">
            flowchart TD
    gcs[(&quot;GCS (calitp-analytics-data/data_analyses/rt_delay)&quot;)]
    map_gcs[(&quot;Public GCS (calitp-map-tiles/)&quot;)]
    subgraph rt_fil_map[RtFilterMapper]
        st_flt[self.set_filter] --&gt;
        flt[self._filter]
        rs_flt[self.reset_filter] --&gt;
        flt
        subgraph stv[static views]
            self.organization_name
            self.rt_trips
            self.stop_delay_view
            self.endpoint_delay_summary
            self.endpoint_delay_view
        end
        subgraph dyn[dynamic tools]
            ssm[self.segment_speed_map] --&gt;|optionally renders map| dmv
            dmv[self.detailed_map_view] --&gt;
            gis[/Manual GIS Format Exports/]
            dmv --&gt; mgz[self.map_gz_export]
            self.chart_variability
            mpv[self.map_variance]
            mpv --&gt; |optionally renders map| mgz
            mgz -.-&gt; map_gcs
            map_gcs -.-&gt; spa
            mgz -.-&gt; |self.spa_map_state| spa
            mgz --&gt;|self.display_spa_map| spa([render maps via external app + IFrame])
            self.chart_delays
            self.chart_speeds
            self.describe_slow_routes
            ssm --&gt; ssv[self.stop_segment_speed_view]
            subgraph cor[corridor tools]
                acor[self.autocorridor] -.-&gt;
                add_cor[self.add_corridor] --&gt;
                qmc[self.quick_map_corridor]
                c_met[self.corridor_metrics]
                add_cor --&gt; c_met
                ext[/external corridor/] -.-&gt; add_cor
            end
            ssv -.-&gt; acor
        end
        %% add_cor -.-&gt;|corridor= True| ssm
        flt --&gt; dyn
        stv --&gt; dyn
    end
    %% top level links
    gcs --&gt;|rt_trips| fm_gcs
    gcs --&gt;|stop_delay_view| fm_gcs
    fm_gcs[rt_filter_map_plot.from_gcs] --&gt; rt_fil_map
    rt_fil_map --&gt; speedmaps[/CA Transit Speed Maps/]
    rt_fil_map --&gt; bb[/Better Buses Analysis/]
    rt_fil_map --&gt; sccp[/SCCP/LPP Transit Delay/]
    rt_fil_map --&gt; other[/Other Exposures/]
        </div><p><code class="docutils literal notranslate"><span class="pre">rt_filter_map_plot</span></code> exists to provide robust analytics functionality separately from the compute-intensive raw data processing steps. It includes the RtFilterMapper class, which provides an interface for loading and filtering a day of data, plus tools to generate various maps, charts, and metrics.</p>
<p><em>Check out the <a class="reference external" href="https://github.com/cal-itp/data-analyses/blob/main/rt_delay/31_tutorial.ipynb">walkthrough notebook</a> for further explanation/demo of these steps</em></p>
<div class="section" id="loading-intermediate-data-largely-automatically">
<h4>Loading Intermediate Data (largely automatically)<a class="headerlink" href="#loading-intermediate-data-largely-automatically" title="Permalink to this headline">¶</a></h4>
<p>To load intermediate data, use <code class="docutils literal notranslate"><span class="pre">rt_filter_map_plot.from_gcs</span></code> to create an RtFilterMapper instance for the itp_id and date of interest.</p>
</div>
<div class="section" id="filtering">
<h4>Filtering<a class="headerlink" href="#filtering" title="Permalink to this headline">¶</a></h4>
<p>Using the <code class="docutils literal notranslate"><span class="pre">set_filter</span></code> method, RtFilterMapper supports filtering based on at least one of these attributes at a time:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Attribute</p></td>
<td><p>Type</p></td>
</tr>
<tr class="row-odd"><td><p>start_time</p></td>
<td><p>str (%H:%M, i.e. 11:00)</p></td>
</tr>
<tr class="row-even"><td><p>end_time</p></td>
<td><p>str (%H:%M, i.e. 19:00)</p></td>
</tr>
<tr class="row-odd"><td><p>route_names</p></td>
<td><p>list, pd.Series</p></td>
</tr>
<tr class="row-even"><td><p>shape_ids</p></td>
<td><p>list, pd.Series</p></td>
</tr>
<tr class="row-odd"><td><p>direction_id</p></td>
<td><p>str, ‘0’ or ‘1’</p></td>
</tr>
<tr class="row-even"><td><p>direction</p></td>
<td><p>str, “Northbound”, etc, <em>experimental</em></p></td>
</tr>
<tr class="row-odd"><td><p>trip_ids</p></td>
<td><p>list, pd.Series</p></td>
</tr>
<tr class="row-even"><td><p>route_types</p></td>
<td><p>list, pd.Series</p></td>
</tr>
</tbody>
</table>
<p>Mapping, charting, and metric generation methods, listed under “dynamic tools” in the chart above, will respect the current filter. After generating your desired output, you can call <code class="docutils literal notranslate"><span class="pre">set_filter</span></code> again to set a new filter, or use <code class="docutils literal notranslate"><span class="pre">reset_filter</span></code> to remove the filter entirely. Then you can continue to analyze, without needing to create a new RtFilterMapper instance.</p>
</div>
<div class="section" id="mapping">
<h4>Mapping<a class="headerlink" href="#mapping" title="Permalink to this headline">¶</a></h4>
<p>Use the <code class="docutils literal notranslate"><span class="pre">segment_speed_map</span></code> method to generate a speed map. Depending on parameters, the speeds visualized will either be the 20th percentile or average speeds for all trips in each segment matching the current filter, if any. See function docstring for additional information.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">map_variance</span></code> method, currently under development, offers a spatial view of variation in speeds for all trips in each segment matching the current filter, if any. This is now quantified as the ratio between 80th percentile and 20th percentile speeds, and used on the CA Transit Speed Maps tool.</p>
</div>
<div class="section" id="more-performant-maps-via-embedded-app">
<h4>More performant maps via embedded app<a class="headerlink" href="#more-performant-maps-via-embedded-app" title="Permalink to this headline">¶</a></h4>
<p>Rather than render the maps directly in the notebook via geopandas and folium, we now have the capability to save them as compressed GeoJSON to GCS and render them in an IFrame using a <a class="reference external" href="https://github.com/cal-itp/data-infra/tree/main/apps/maps">minimal web app</a>.</p>
<p>This method is much more efficient, and we rely on it to maintain the quantity and quality of maps on the <a class="reference external" href="https://analysis.calitp.org/rt/README.html">CA Transit Speed Maps</a> site.</p>
<p><code class="docutils literal notranslate"><span class="pre">display_spa_map</span></code> will always show the most recent map generated with either <code class="docutils literal notranslate"><span class="pre">segment_speed_map</span></code> or <code class="docutils literal notranslate"><span class="pre">map_variance</span></code>, then saved via <code class="docutils literal notranslate"><span class="pre">map_gz_export</span></code>.</p>
</div>
<div class="section" id="stop-segment-speed-view">
<h4><code class="docutils literal notranslate"><span class="pre">stop_segment_speed_view</span></code><a class="headerlink" href="#stop-segment-speed-view" title="Permalink to this headline">¶</a></h4>
<p>After generating a speed map, the underlying data is available at RtFilterMapper.stop_segment_speed_view, a geodataframe. This data can be easily exported into a geoparquet, geojson, shapefile, or spreadsheet with the appropriate geopandas method.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p></p></th>
<th class="head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Column</p></td>
<td><p>Source</p></td>
<td><p>Type</p></td>
</tr>
<tr class="row-odd"><td><p>shape_meters</p></td>
<td><p>Projection of GTFS Stop along GTFS Shape (with 0 being start of shape), additionally 1km segments generated where stops are infrequent</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>stop_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>stop_name</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>geometry</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>geometry</p></td>
</tr>
<tr class="row-odd"><td><p>shape_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>trip_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>stop_sequence</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>route_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-odd"><td><p>route_short_name</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>string</p></td>
</tr>
<tr class="row-even"><td><p>direction_id</p></td>
<td><p>GTFS Schedule</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-odd"><td><p>delay_seconds*</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">stop_delay_view</span></code></p></td>
<td><p>np.datetime64[ns]</p></td>
</tr>
<tr class="row-even"><td><p>seconds_from_last*</p></td>
<td><p>time for trip to travel to this stop from last stop</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-odd"><td><p>last_loc*</p></td>
<td><p>previous stop <code class="docutils literal notranslate"><span class="pre">shape_meters</span></code></p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>meters_from_last*</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">shape_meters</span></code> - <code class="docutils literal notranslate"><span class="pre">last_loc</span></code></p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-odd"><td><p>speed_from_last*</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">meters_from_last</span></code> / <code class="docutils literal notranslate"><span class="pre">seconds_from_last</span></code></p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>delay_chg_sec*</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">delay_seconds</span></code> - delay at last stop</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-odd"><td><p>speed_mph*</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">speed_from_last</span></code> converted to miles per hour</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>n_trips_shp**</p></td>
<td><p>number of unique trips on this GTFS shape in filter</p></td>
<td><p>int64</p></td>
</tr>
<tr class="row-odd"><td><p>avg_mph**</p></td>
<td><p>average speed for all trips on this segment</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>_20p_mph**</p></td>
<td><p>20th percentile speed for all trips on this segment</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-odd"><td><p>_80p_mph**</p></td>
<td><p>80th percentile speed for all trips on this segment</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-even"><td><p>fast_slow_ratio**</p></td>
<td><p>ratio between p80 speed and p20 speed for all trips on this segment</p></td>
<td><p>float64</p></td>
</tr>
<tr class="row-odd"><td><p>trips_per_hour</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">n_trips_shp</span></code> / hours in filter</p></td>
<td><p>float64</p></td>
</tr>
</tbody>
</table>
<p>*disaggregate value – applies to this trip only</p>
<p>**aggregated value – based on all trips in filter</p>
</div>
<div class="section" id="other-charts-and-metrics">
<h4>Other Charts and Metrics<a class="headerlink" href="#other-charts-and-metrics" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">chart_variability</span></code> method provides a descriptitive view of the speeds experienced by each trip in each segments. It requires that a filter first be set to only one shape_id.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">chart_speeds</span></code> and <code class="docutils literal notranslate"><span class="pre">chart_delays</span></code> methods provide aggregate charts showing speed and delay patterns throughout the day.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">describe_slow_routes</span></code> method lists out the routes in the current filter experiencing the lowest speeds. It is mainly used on the California Transit Speed Maps site.</p>
</div>
<div class="section" id="corridor-analysis">
<h4>Corridor Analysis<a class="headerlink" href="#corridor-analysis" title="Permalink to this headline">¶</a></h4>
<p>It’s often useful to measure transit delay on a specific corridor to support technical metric generation for the Solutions for Congested Corridors Program, Local Partnership Program, and other analyses.</p>
<p>If you’ve received a corridor from an SCCP/LPP applicant or elsewhere, load it as a geodataframe and add it using the <code class="docutils literal notranslate"><span class="pre">add_corridor</span></code> method. If you’re already looking at a speed map and want to measure delay for a portion of the map, you can use the <code class="docutils literal notranslate"><span class="pre">autocorridor</span></code> method to specify a corridor using a shape_id and two stop_sequences. This saves time by avoiding the need to generate the polygon elsewhere.</p>
<p>The corridor must be a single polygon, and in order to generate metrics it must include at least one transit stop.</p>
<p>Once the corridor is attached, the <code class="docutils literal notranslate"><span class="pre">quick_map_corridor</span></code> method is available to generate an overview map of the corridor, including the transit stops just before, within, and just after the corridor. The <code class="docutils literal notranslate"><span class="pre">corridor_metrics</span></code> method will generate both a speed-based and schedule-based transit delay metric.</p>
<p>The speed-based metric is a daily average of the sum of delays for each trip traversing the corridor as compared to a reference speed of 16 miles per hour. To further explain, we take each corridor trip that we have data for and calculate the hypothetical time it would take for that trip to traverse the corridor at a speed of 16 mph. The difference between the actual time it took for the trip to traverse the corridor and that hypothetical time is the speed-based delay for that trip, and we sum those delays to create the metric. This metric is intended to provide a more consistent basis for comparison independent of scheduling practices.</p>
<p>In other words, if we expect a hypothetical bus lane/signal priority/payment system etc to increase corridor speeds to 16mph, this is how much time we could save per day.</p>
<p>The schedule-based metric is a daily average of the sum of median trip stop delays along the corridor. To further explain, we take each corridor trip that we have data for and look at the delay in comparison to the schedule at each stop, after subtracting off any delay present as the trip entered the corridor. For each trip we then take the median delay of all stops along the corridor, and sum these medians to create the metric.</p>
<p>Finally, you can use the <code class="docutils literal notranslate"><span class="pre">corridor</span> <span class="pre">=</span> <span class="pre">True</span></code> argument in the <code class="docutils literal notranslate"><span class="pre">segment_speed_map</span></code> method to generate a speed map for only corridor segments.</p>
<p>While all of these methods respect any filter you may have set with <code class="docutils literal notranslate"><span class="pre">set_filter</span></code>, don’t set a filter for SCCP/LPP metric generation.</p>
</div>
</div>
</div>
<div class="section" id="example-workflow-california-transit-speed-maps">
<h2>Example Workflow: California Transit Speed Maps<a class="headerlink" href="#example-workflow-california-transit-speed-maps" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference external" href="https://github.com/cal-itp/data-analyses/blob/main/ca_transit_speed_maps/technical_notes.md"><code class="docutils literal notranslate"><span class="pre">data_analyses/ca_transit_speed_maps/technical_notes.md</span></code></a> !</p>
</div>
<div class="section" id="example-workflow-sccp">
<h2>Example Workflow: SCCP<a class="headerlink" href="#example-workflow-sccp" title="Permalink to this headline">¶</a></h2>
<div class="mermaid">
            flowchart TD
    rcv_corr[/receive corridor from applicant/] --&gt;
    ver_corr[/verify corridor is polygon/] --&gt;
    gen_data[generate analysis data for timeframe*]
    subgraph fm[RtFilterMapper]
        atc_corr[&quot;attach corridor (self.add_corridor)&quot;]
        atc_corr --&gt; metrics[self.corridor_metrics]
        atc_corr -.-&gt; self.quick_map_corridor
        atc_corr -.-&gt; map_corr[&quot;corridor = True on speedmaps&quot;]
    end
    gen_data --&gt; fm
    metrics --&gt; pub&gt;&quot;share both speed and schedule metrics (appropriately averaged for SCCP/LPP)&quot;]
        </div><p>Note that these steps are substantially automated using the <code class="docutils literal notranslate"><span class="pre">rt_analysis.sccp_tools.sccp_average_metrics</span></code> function.</p>
<ul class="simple">
<li><p>2022 SCCP/LPP default timeframe is Apr 30 - May 9 2022.</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./analytics_tools"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="scripts.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Scripts</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="saving_code.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Saving Code</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Cal-ITP<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>