main:
  params: [args]
  steps:
    - init:
        assign:
          - projectId: $${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - location: $${sys.get_env("GOOGLE_CLOUD_LOCATION")}
          - topic: $${sys.get_env("GTFS_RT_ARCHIVER__TOPIC")}
          - dataset: staging
          - table: int_transit_database__gtfs_datasets_dim
          - limit: $${int(default(map.get(args, "limit"), "-1"))}
          - startTime: $${sys.now()}
          - startAt: $${time.format(startTime)}
    - runQuery:
        call: googleapis.bigquery.v2.jobs.query
        args:
          projectId: $${projectId}
          body:
            useLegacySql: false
            useQueryCache: true
            timeoutMs: 30000
            query: $${
              "SELECT type, pipeline_url, authorization_header_parameter_name, header_secret_key_name, authorization_url_parameter_name, url_secret_key_name, base64_url " +
              "FROM `" + projectId + "." + dataset + "." + table + "` " +
              "WHERE _is_current = true " +
              "AND type IN ('service_alerts', 'trip_updates', 'vehicle_positions') " +
              if(limit < 0, "", "LIMIT " + limit)
              }
        result: queryResult
    - publishMessages:
        parallel:
          for:
            value: delay
            in: [0, 20, 40]
            steps:
              - sleep:
                  call: sys.sleep
                  args:
                    seconds: $${delay}
              - prepareArgs:
                  assign:
                    - messages: []
              - prepareMessages:
                  for:
                    value: row
                    in: $${queryResult.rows}
                    steps:
                      - prepareChildArgs:
                          assign:
                            - data: {}
                            - data.startAt: $${startAt}
                            - data.fetchSecond: $${delay}
                            - data.type: $${row.f[0].v}
                            - data.pipelineUrl: $${row.f[1].v}
                            - data.authorizationHeaderParameterName: $${row.f[2].v}
                            - data.headerSecretKeyName: $${row.f[3].v}
                            - data.authorizationUrlParameterName: $${row.f[4].v}
                            - data.urlSecretKeyName: $${row.f[5].v}
                            - data.base64Url: $${row.f[6].v}
                            - message: {}
                            - message.data: $${base64.encode(json.encode(data))}
                            - messages: $${list.concat(messages, message)}
              - publish:
                  call: googleapis.pubsub.v1.projects.topics.publish
                  args:
                    topic: $${topic}
                    body:
                      messages: $${messages}
