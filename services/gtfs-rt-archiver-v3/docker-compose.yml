version: '3.8'
x-gtfs-rt-archiver-v3-common:
  &gtfs-rt-archiver-v3-common
  build: .
  environment:
    AIRFLOW_ENV: development
    CALITP_AUTH_KEYS: "AC_TRANSIT_API_KEY,AMTRAK_GTFS_URL,BEAR_TRANSIT_KEY,CULVER_CITY_API_KEY,ESCALON_RT_KEY,TORRANCE_TRANSIT_API_KEY,MTC_511_API_KEY,SD_MTS_SA_API_KEY,SD_MTS_VP_TU_API_KEY,SWIFTLY_AUTHORIZATION_KEY_CALITP,WEHO_RT_KEY"
    CALITP_BUCKET__AIRTABLE: "gs://test-calitp-airtable"
    CALITP_BUCKET__GTFS_DOWNLOAD_CONFIG: "gs://test-calitp-gtfs-download-config"
    CALITP_BUCKET__GTFS_RT_RAW: "gs://dev-calitp-gtfs-rt-raw"
    CALITP_HUEY_REDIS_HOST: redis
    GOOGLE_APPLICATION_CREDENTIALS: /tmp/secret.json
    HUEY_CONSUMER_WORKERS: 4
    SENTRY_DSN: $SENTRY_DSN
    SENTRY_ENVIRONMENT: "development"
services:
  redis:
    image: redis:5.0.4
    ports:
      - 6379
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 30s
      retries: 50
    restart: always

  gtfs-rt-archiver-v3-ticker:
    <<: *gtfs-rt-archiver-v3-common
    command: python -m gtfs_rt_archiver_v3.ticker --load-env-secrets
    volumes:
      - $CALITP_ARCHIVER_V3_SERVICE_ACCOUNT:/tmp/secret.json:ro

  gtfs-rt-archiver-v3-consumer:
    <<: *gtfs-rt-archiver-v3-common
    command: python -m gtfs_rt_archiver_v3.consumer --load-env-secrets
    volumes:
      - $CALITP_ARCHIVER_V3_SERVICE_ACCOUNT:/tmp/secret.json:ro
