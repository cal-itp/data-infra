apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sftp-server
spec:
  selector:
    matchLabels:
      component: sftp-server
  serviceName: sftp-intranet
  replicas: 1
  template:
    metadata:
      labels:
        component: sftp-server
    spec:
      containers:
        - name: server
          image: fedora:latest
          envFrom:
            - configMapRef:
                name: sftp-user
          ports:
            - containerPort: 22
              name: sftp
          volumeMounts:
            - name: data
              mountPath: /sftp/data
            - name: user-config
              mountPath: /config/user
            - name: server-config
              mountPath: /config/server
          command: [ /bin/bash ]
          args:
            - -c
            - |
              test "$SFTP_USER" || { echo "fatal: SFTP_USER not defined "; exit 1; }
              dnf install -y openssh-server
              groupadd -g 1000 $SFTP_USER
              useradd  -g 1000 -md /home/$SFTP_USER -s /bin/bash $SFTP_USER
              mkdir -m 0700 /home/$SFTP_USER/.ssh
              if [[ -e /config/user/authorized_keys ]]; then
                (umask 077; cp /config/user/authorized_keys /home/$SFTP_USER/.ssh/authorized_keys)
              else
                echo "warn: no /config/user/authorized_keys file; user $SFTP_USER may not be able to login"
              fi
              chown -R $SFTP_USER:$SFTP_USER /home/$SFTP_USER/.ssh
              cp /config/server/sshd_config /etc/ssh/sshd_config
              ssh-keygen -A
              exec /usr/sbin/sshd -e -D
          readinessProbe:
            tcpSocket:
              port: 22
            initialDelaySeconds: 5
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
      volumes:
        - name: user-config
          configMap:
            name: sftp-user-config
        - name: server-config
          configMap:
            name: sftp-sshd
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ 'ReadWriteOnce' ]
        resources:
          requests:
            storage: 1Gi
