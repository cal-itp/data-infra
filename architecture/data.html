
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data pipelines &#8212; Cal-ITP Data Services</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Airflow Operational Considerations" href="../airflow/dags-maintenance.html" />
    <link rel="prev" title="Published Images and Packages" href="images_and_packages.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SZB618VNBZ"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-SZB618VNBZ');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/calitp_logo_MAIN.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Cal-ITP Data Services</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Data Services Documentation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Analysts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_welcome/overview.html">
   Welcome!
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_welcome/what_is_calitp.html">
     Cal-ITP Project Information
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_welcome/how_we_work.html">
     How We Work
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analytics_onboarding/overview.html">
   Technical Onboarding
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_tools/overview.html">
   Introduction to Analytics Tools
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/github_setup.html">
     GitHub Setup
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/tools_quick_links.html">
     Tools Quick Links
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/bi_dashboards.html">
     Business Insights &amp; Dashboards
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/jupyterhub.html">
     JupyterHub
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/local_oracle_db_connections.html">
     Local Oracle Database Connections
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/python_libraries.html">
     Useful Python Libraries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/scripts.html">
     Scripts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/rt_analysis.html">
     RT Analysis Module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/saving_code.html">
     Saving Code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/storing_data.html">
     Storing Data During Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/data_catalogs.html">
     Using Data Catalogs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/knowledge_sharing.html">
     Helpful Links
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_new_analysts/overview.html">
   Tutorials for New Python Users
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/01-data-analysis-intro.html">
     Data Analysis: Intro
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/02-data-analysis-intermediate.html">
     Data Analysis: Intermediate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/03-data-management.html">
     Data Management
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/04-notebooks.html">
     Working with Jupyter notebooks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/05-spatial-analysis-basics.html">
     Working with Geospatial Data: Basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/06-spatial-analysis-intro.html">
     Working with Geospatial Data: Intro
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/07-spatial-analysis-intermediate.html">
     Working with Geospatial Data: Intermediate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/08-spatial-analysis-advanced.html">
     Working with Geospatial Data: Advanced
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../warehouse/overview.html">
   Introduction to the Warehouse
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/warehouse_starter_kit.html">
     Warehouse: Where to Begin
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/navigating_dbt_docs.html">
     Navigating the dbt Docs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/what_is_agency.html">
     What is an
     <code class="docutils literal notranslate">
      <span class="pre">
       agency
      </span>
     </code>
     ?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/developing_dbt_models.html">
     Developing models in dbt
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/adding_oneoff_data.html">
     Adding Ad-Hoc Data to the Warehouse
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/what_is_gtfs.html">
     What is GTFS, anyway?
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../publishing/overview.html">
   Where can I publish data?
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/1_publishing_principles.html">
     Data Publishing Principles
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/2_static_files.html">
     Static Visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/3_github_pages.html">
     HTML Visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/4_analytics_portfolio_site.html">
     The Cal-ITP Analytics Portfolio
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/5_notebooks_styling.html">
     Getting Notebooks Ready for the Portfolio
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/6_metabase.html">
     Metabase
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/7_gcs.html">
     GCS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/8_ckan.html">
     Publishing data to California Open Data aka CKAN
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/9_geoportal.html">
     Publishing data to California State Geoportal
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Developers
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="architecture_overview.html">
   Architecture Overview
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="services.html">
     Deployed Services and Sites
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="images_and_packages.html">
     Published Images and Packages
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Data pipelines
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../airflow/dags-maintenance.html">
   Airflow Operational Considerations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../transit_database/transitdatabase.html">
   Transit Database (Airtable)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contribute to the Docs!
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../contribute/overview.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/contribute-best-practices.html">
     Best Practices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/submitting_changes.html">
     Submitting Changes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/content_types.html">
     Common Content
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/architecture/data.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/cal-itp/data-infra/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/cal-itp/data-infra//issues/new?title=Issue%20on%20page%20%2Farchitecture/data.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/cal-itp/data-infra/edit/main/docs/architecture/data.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-ingest-diagram">
   Data ingest diagram
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adding-a-new-data-source">
   Adding a new data source
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#determine-upstream-source-type">
     Determine upstream source type
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#bring-data-into-google-cloud-storage">
     Bring data into Google Cloud Storage
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-external-tables">
     Create external tables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dbt-modeling">
     dbt modeling
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Data pipelines</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-ingest-diagram">
   Data ingest diagram
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adding-a-new-data-source">
   Adding a new data source
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#determine-upstream-source-type">
     Determine upstream source type
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#bring-data-into-google-cloud-storage">
     Bring data into Google Cloud Storage
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-external-tables">
     Create external tables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dbt-modeling">
     dbt modeling
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="data-pipelines">
<span id="architecture-data"></span><h1>Data pipelines<a class="headerlink" href="#data-pipelines" title="Permalink to this headline">¶</a></h1>
<p>In general, our data ingest follows versions of the pattern diagrammed below. For an example PR that ingests a brand new data source from scratch, see <a class="reference external" href="https://github.com/cal-itp/data-infra/pull/2376">data infra PR #2376</a>.</p>
<p>Some of the key attributes of our approach:</p>
<ul class="simple">
<li><p>We generate an <a class="reference external" href="https://github.com/cal-itp/data-infra/blob/main/packages/calitp-data-infra/calitp_data_infra/storage.py#L418"><code class="docutils literal notranslate"><span class="pre">outcomes</span></code></a> file describing whether scrape, parse, or validate operations were successful. This makes operation outcomes visible in BigQuery, so they can be analyzed (for example: how long has the download operation for X feed been failing?)</p></li>
<li><p>We try to limit the amount of manipulation in Airflow tasks to the bare minimum to make the data legible to BigQuery (for example, replace illegal column names that would break the external tables.) We use gzipped JSONL files in GCS as our default parsed data format.</p></li>
<li><p><a class="reference external" href="https://cloud.google.com/bigquery/docs/external-data-sources#external_tables">External tables</a> provide the interface between ingested data and BigQuery modeling/transformations.</p></li>
</ul>
<p>While many of the key elements of our architecture are common to most of our data sources, each data source has some unique aspects as well. <a class="reference external" href="https://docs.google.com/spreadsheets/d/1bv1K5lZMnq1eCSZRy3sPd3MgbdyghrMl4u8HvjNjWPw/edit#gid=0">This spreadsheet</a> details overviews by data source, outlining the specific code/resources that correspond to each step in the general data flow shown below.</p>
<div class="section" id="data-ingest-diagram">
<span id="id1"></span><h2>Data ingest diagram<a class="headerlink" href="#data-ingest-diagram" title="Permalink to this headline">¶</a></h2>
<div class="mermaid">
            flowchart TD

raw_data((Raw data  &lt;br&gt; in external source))
airflow_scrape{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; scraper}
airflow_parse{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; parser}
airflow_validate{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; GTFS validator}
airflow_external_tables{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; create&lt;br&gt;external tables}
dbt([&lt;br&gt;&lt;b&gt;dbt&lt;/b&gt;&lt;br&gt;&lt;br&gt;])
airflow_dbt{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; run dbt}

subgraph first_bq[ ]
    bq_label1[BigQuery&lt;br&gt;External tables dataset]
    ext_raw_outcomes[(Scrape outcomes&lt;br&gt;external table)]
    ext_parse_data[(Parsed data&lt;br&gt;external table)]
    ext_parse_outcomes[(Parse outcomes&lt;br&gt;external table)]
    ext_validations[(Validations&lt;br&gt;external table)]
    ext_validation_outcomes[(Validation outcomes&lt;br&gt;external table)]
end

subgraph second_bq[ ]
    bq_label2[BigQuery&lt;br&gt;Staging, mart, etc. datasets]
    bq_table_example[(staging_*.table_names)]
    bq_table_example2[(mart_*.table_names)]
    bq_table_example3[(etc.)]
end

subgraph first_gcs[ ]
    gcs_label1[Google Cloud Storage:&lt;br&gt;Raw bucket]
    raw_gcs[Raw data]
    raw_outcomes_gcs[Scrape outcomes file]
end

subgraph second_gcs[ ]
    gcs_label2[Google Cloud Storage:&lt;br&gt;Parsed bucket]
    parse_gcs[Parsed data]
    parse_outcomes_gcs[Parse outcomes file]
end

subgraph validated_gcs[ ]
    gcs_label3[&lt;i&gt;GTFS ONLY&lt;/i&gt; &lt;br&gt; Google Cloud Storage:&lt;br&gt;Validation bucket]
    validation_gcs[Validations data]
    validation_outcomes_gcs[Validation outcomes file]
end

raw_data -- read by--&gt; airflow_scrape
airflow_scrape -- writes data to--&gt; raw_gcs
airflow_scrape -- writes operation outcomes to--&gt; raw_outcomes_gcs
raw_gcs -- read by--&gt; airflow_parse
airflow_parse -- writes data to--&gt; parse_gcs
airflow_parse -- writes operation outcomes to--&gt; parse_outcomes_gcs

raw_gcs -- if GTFS then read by--&gt; airflow_validate
airflow_validate -- writes data to--&gt; validation_gcs
airflow_validate -- writes operation outcomes to--&gt; validation_outcomes_gcs

parse_outcomes_gcs -- external tables  defined by--&gt; airflow_external_tables
parse_gcs -- external tables  defined by--&gt; airflow_external_tables
raw_outcomes_gcs -- external tables  defined by--&gt; airflow_external_tables
validation_outcomes_gcs -- external tables  defined by--&gt; airflow_external_tables
validation_gcs -- external tables  defined by--&gt; airflow_external_tables


airflow_external_tables -- defines--&gt; ext_raw_outcomes
airflow_external_tables -- defines--&gt; ext_parse_data
airflow_external_tables -- defines--&gt; ext_parse_outcomes
airflow_external_tables -- defines--&gt; ext_validation_outcomes
airflow_external_tables -- defines--&gt; ext_validations

airflow_dbt -- runs--&gt; dbt
ext_raw_outcomes -- read as source by--&gt;dbt
ext_parse_data -- read as source by--&gt;dbt
ext_parse_outcomes -- read as source by--&gt;dbt
ext_validations -- read as source by--&gt;dbt
ext_validation_outcomes -- read as source by--&gt;dbt


dbt -- orchestrates transformations to create--&gt;second_bq

classDef default fill:white, color:black, stroke:black, stroke-width:1px

classDef gcs_group_boxstyle fill:lightblue, color:black, stroke:black, stroke-width:1px

classDef bq_group_boxstyle fill:lightgreen, color:black, stroke:black, stroke-width:1px

classDef raw_datastyle fill:yellow, color:black, stroke:black, stroke-width:1px

classDef dbtstyle fill:darkgreen, color:white, stroke:black, stroke-width:1px

classDef group_labelstyle fill:lightgray, color:black, stroke-width:0px

class raw_data raw_datastyle
class dbt dbtstyle
class first_gcs,second_gcs,validated_gcs gcs_group_boxstyle
class first_bq,second_bq bq_group_boxstyle
class gcs_label1,gcs_label2,gcs_label3,bq_label1,bq_label2 group_labelstyle
        </div></div>
<div class="section" id="adding-a-new-data-source">
<h2>Adding a new data source<a class="headerlink" href="#adding-a-new-data-source" title="Permalink to this headline">¶</a></h2>
<p>Adding a new data source based on the architecture described above involves several steps, outlined below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’re bringing in data that is similar to existing data (for example, a new subset of an existing dataset like a new Airtable or Littlepay table), you should follow the existing pattern for that dataset. <a class="reference external" href="https://docs.google.com/spreadsheets/d/1bv1K5lZMnq1eCSZRy3sPd3MgbdyghrMl4u8HvjNjWPw/edit#gid=0">This spreadsheet</a> gives overviews of some prominent existing data sources, outlining the specific code/resources that correspond to each step in the <a class="reference internal" href="#data-ingest-diagram"><span class="std std-ref">general data flow</span></a> for that data source.</p>
</div>
<div class="section" id="determine-upstream-source-type">
<h3>Determine upstream source type<a class="headerlink" href="#determine-upstream-source-type" title="Permalink to this headline">¶</a></h3>
<p>To determine the best storage location for your raw data (especially if it requires manual curation), consult the <a class="reference external" href="https://docs.google.com/document/d/1-l6c99UUZ0o3Ln9S_CAt7iitGHvriewWhKDftESE2Dw/edit">Data Collection and Storage Guidance within the Cal-ITP Data Pipeline Google Doc</a>.</p>
<p>The <a class="reference internal" href="../warehouse/developing_dbt_models.html#tool-choice"><span class="std std-ref">Should it be a dbt model?</span></a> docs section also has some guidance about when a data pipeline should be created.</p>
</div>
<div class="section" id="bring-data-into-google-cloud-storage">
<h3>Bring data into Google Cloud Storage<a class="headerlink" href="#bring-data-into-google-cloud-storage" title="Permalink to this headline">¶</a></h3>
<p>We store our raw, un-transformed data in Google Cloud Storage, usually in perpetuity, to ensure that we can always recover the raw data if needed.</p>
<p>We store data in <a class="reference external" href="https://cloud.google.com/bigquery/docs/hive-partitioned-queries#supported_data_layouts">hive-partitioned buckets</a> so that data is clearly labeled and partitioned for better performance. We use UTC dates and timestamps in hive paths (for example, for the timestamp of the data extract) for consistency.</p>
<p>You will need to set up a way to bring your raw data into the Cal-ITP Google Cloud Storage environment. Most commonly, we use <a class="reference external" href="https://airflow.apache.org/">Airflow</a> for this.</p>
<p>The <a class="reference external" href="https://github.com/cal-itp/data-infra/tree/main/airflow#readme">Airflow README in the data-infra repo</a> has information about how to set up Airflow locally for testing and how the Airflow project is structured.</p>
<p>We often bring data into our environment in two steps, created as two separate Airflow <a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html">DAGs</a>:</p>
<ul class="simple">
<li><p><strong>Sync the fully-raw data in its original format:</strong> See for example the changes in the <code class="docutils literal notranslate"><span class="pre">airflow/dags/sync_elavon</span></code> directory in <a class="reference external" href="https://github.com/cal-itp/data-infra/pull/2376/files">data-infra PR #2376</a> (note: this example is typical in terms of its overall structure and use of Cal-ITP storage classes and methods, but the specifics of how to access and request the upstream data source will vary). We do this to preserve the raw data in its original form. This data might be saved in a <code class="docutils literal notranslate"><span class="pre">calitp-&lt;your-data-source&gt;-raw</span></code> bucket.</p></li>
<li><p><strong>Convert the saved raw data into a BigQuery-readable gzipped JSONL file:</strong> See for example the changes in the <code class="docutils literal notranslate"><span class="pre">airflow/dags/parse_elavon</span></code> directory in <a class="reference external" href="https://github.com/cal-itp/data-infra/pull/2376/files">data-infra PR #2376</a>. This prepares the data is to be read into BigQuery. <strong>Conversion here should be limited to the bare minimum needed to make the data BigQuery-compatible, for example converting column names that would be invalid in BigQuery and changing the file type to gzipped JSONL.</strong> This data might be saved in a <code class="docutils literal notranslate"><span class="pre">calitp-&lt;your-data-source&gt;-parsed</span></code> bucket.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When you merge a pull request creating a new Airflow DAG, that DAG will be paused by default. To start the DAG, someone will need to log into <a class="reference external" href="https://o1d2fa0877cf3fb10p-tp.appspot.com/home">the Airflow UI (requires Composer access in Cal-ITP Google Cloud Platform instance)</a> and unpause the DAG.</p>
</div>
</div>
<div class="section" id="create-external-tables">
<h3>Create external tables<a class="headerlink" href="#create-external-tables" title="Permalink to this headline">¶</a></h3>
<p>We use <a class="reference external" href="https://cloud.google.com/bigquery/docs/external-data-sources#external_tables">external tables</a> to allow BigQuery to query data stored in Google Cloud Storage. External tables do not move data into BigQuery; they simply define the data schema which BigQuery can then use to access the data still stored in Google Cloud Storage.</p>
<p>External tables are created by the <a class="reference external" href="https://github.com/cal-itp/data-infra/tree/main/airflow/dags/create_external_tables"><code class="docutils literal notranslate"><span class="pre">create_external_tables</span></code> Airflow DAG</a> using the <a class="reference external" href="https://github.com/cal-itp/data-infra/blob/main/airflow/plugins/operators/external_table.py">ExternalTable custom operator</a>. Testing guidance and example YAML for how to create your external table is provided in the <a class="reference external" href="https://github.com/cal-itp/data-infra/tree/main/airflow/dags/create_external_tables#create_external_tables">Airflow DAG documentation</a>.</p>
</div>
<div class="section" id="dbt-modeling">
<h3>dbt modeling<a class="headerlink" href="#dbt-modeling" title="Permalink to this headline">¶</a></h3>
<p>Considerations for dbt modeling are outlined on the <a class="reference internal" href="../warehouse/developing_dbt_models.html#developing-dbt-models"><span class="std std-ref">Developing models in dbt</span></a> page.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./architecture"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="images_and_packages.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Published Images and Packages</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../airflow/dags-maintenance.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Airflow Operational Considerations</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Cal-ITP<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>