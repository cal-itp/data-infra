
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Data pipelines &#8212; Cal-ITP Data Services</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=1d5f98c3" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-SZB618VNBZ"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-SZB618VNBZ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-SZB618VNBZ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'architecture/data';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Airflow Operational Considerations" href="../airflow/dags-maintenance.html" />
    <link rel="prev" title="Published Images and Packages" href="images_and_packages.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/calitp_logo_MAIN.png" class="logo__image only-light" alt="Cal-ITP Data Services - Home"/>
    <script>document.write(`<img src="../_static/calitp_logo_MAIN.png" class="logo__image only-dark" alt="Cal-ITP Data Services - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Data Services Documentation
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Analysts</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../analytics_welcome/overview.html">Welcome!</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../analytics_welcome/what_is_calitp.html">Cal-ITP Project Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_welcome/how_we_work.html">How We Work</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../analytics_onboarding/overview.html">Technical Onboarding</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../analytics_tools/overview.html">Introduction to Analytics Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/tools_quick_links.html">Tools Quick Links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/bi_dashboards.html">Business Insights &amp; Dashboards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/jupyterhub.html">JupyterHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/local_oracle_db_connections.html">Local Oracle Database Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/python_libraries.html">Useful Python Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/scripts.html">Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/rt_analysis.html">RT Analysis Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/saving_code.html">Saving Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/storing_data.html">Storing Data During Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/data_catalogs.html">Using Data Catalogs</a></li>

<li class="toctree-l2"><a class="reference internal" href="../analytics_tools/knowledge_sharing.html">Helpful Links</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../analytics_new_analysts/overview.html">Tutorials for New Python Users</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../analytics_new_analysts/01-data-analysis-intro.html">Data Analysis: Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_new_analysts/02-data-analysis-intermediate.html">Data Analysis: Intermediate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_new_analysts/03-data-management.html">Data Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_new_analysts/04-notebooks.html">Working with Jupyter notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_new_analysts/05-spatial-analysis-basics.html">Working with Geospatial Data: Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_new_analysts/06-spatial-analysis-intro.html">Working with Geospatial Data: Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_new_analysts/07-spatial-analysis-intermediate.html">Working with Geospatial Data: Intermediate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analytics_new_analysts/08-spatial-analysis-advanced.html">Working with Geospatial Data: Advanced</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../warehouse/overview.html">Introduction to the Warehouse</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../warehouse/warehouse_starter_kit.html">Warehouse: Where to Begin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../warehouse/navigating_dbt_docs.html">Navigating the dbt Docs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../warehouse/what_is_agency.html">What is an <code class="docutils literal notranslate"><span class="pre">agency</span></code>?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../warehouse/developing_dbt_models.html">Developing models in dbt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../warehouse/adding_oneoff_data.html">Adding Ad-Hoc Data to the Warehouse</a></li>
<li class="toctree-l2"><a class="reference internal" href="../warehouse/what_is_gtfs.html">What is GTFS, anyway?</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../publishing/overview.html">Where can I publish data?</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../publishing/sections/1_publishing_principles.html">Data Publishing Principles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../publishing/sections/2_static_files.html">Static Visualizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../publishing/sections/3_github_pages.html">HTML Visualizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../publishing/sections/4_notebooks_styling.html">Getting Notebooks Ready for the Portfolio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../publishing/sections/5_analytics_portfolio_site.html">The Cal-ITP Analytics Portfolio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../publishing/sections/6_metabase.html">Metabase</a></li>
<li class="toctree-l2"><a class="reference internal" href="../publishing/sections/7_gcs.html">GCS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../publishing/sections/8_ckan.html">Publishing data to California Open Data aka CKAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../publishing/sections/9_geoportal.html">Publishing data to California State Geoportal</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Developers</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="architecture_overview.html">Architecture Overview</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="services.html">Deployed Services and Sites</a></li>
<li class="toctree-l2"><a class="reference internal" href="images_and_packages.html">Published Images and Packages</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Data pipelines</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../airflow/dags-maintenance.html">Airflow Operational Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transit_database/transitdatabase.html">Transit Database (Airtable)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contribute to the Docs!</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../contribute/overview.html">Getting Started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contribute/contribute-best-practices.html">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/submitting_changes.html">Submitting Changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/content_types.html">Common Content</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cal-itp/data-infra" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cal-itp/data-infra/edit/main/docs/architecture/data.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cal-itp/data-infra/issues/new?title=Issue%20on%20page%20%2Farchitecture/data.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/architecture/data.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Data pipelines</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-ingest-diagram">Data ingest diagram</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-new-data-source">Adding a new data source</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decide-on-an-approach">0. Decide on an approach</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bring-data-into-google-cloud-storage">1. Bring data into Google Cloud Storage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-external-tables">2. Create external tables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dbt-modeling">3. dbt modeling</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="data-pipelines">
<span id="architecture-data"></span><h1>Data pipelines<a class="headerlink" href="#data-pipelines" title="Link to this heading">#</a></h1>
<p>In general, our data ingest follows customized versions of a consistent pattern:</p>
<ol class="arabic simple">
<li><p>Sync raw data into Google Cloud Storage (GCS), and parse it into a BigQuery-readable form</p></li>
<li><p>Create <a class="reference external" href="https://cloud.google.com/bigquery/docs/external-tables">external tables</a> in BigQuery that read the parsed data from GCS</p></li>
<li><p>Model and transform the resulting tables using <a class="reference external" href="https://docs.getdbt.com/docs/introduction">dbt</a></p></li>
</ol>
<p>That pattern is diagrammed and discussed in more detail below. For an example PR that ingests a brand new data source from scratch, see <a class="reference external" href="https://github.com/cal-itp/data-infra/pull/2376">data infra PR #2376</a>.</p>
<p>Some of the key attributes of our approach, shared across data sources:</p>
<ul class="simple">
<li><p>We generate an <a class="reference external" href="https://github.com/cal-itp/data-infra/blob/main/packages/calitp-data-infra/calitp_data_infra/storage.py#L372"><code class="docutils literal notranslate"><span class="pre">outcomes</span></code></a> file at each ingestion step describing whether scrape, parse, or validate operations were successful. This makes operation outcomes visible in BigQuery, so they can be analyzed (for example: how long has the download operation for X feed been failing?)</p></li>
<li><p>We try to limit the amount of data manipulation in Airflow tasks to the bare minimum required to make the data legible to BigQuery (for example, replace illegal column names that would break the external tables.) We use gzipped JSONL files in GCS as our default parsed data format. Data transformation is generally handled downstream via dbt, rather than as part of the initial pipeline.</p></li>
<li><p><a class="reference external" href="https://cloud.google.com/bigquery/docs/external-data-sources#external_tables">External tables</a> provide the interface between ingested data and BigQuery modeling/transformations.</p></li>
</ul>
<p>While many of the key elements of our architecture are common to most of our data sources, each data source has some unique aspects as well. <a class="reference external" href="https://docs.google.com/spreadsheets/d/1bv1K5lZMnq1eCSZRy3sPd3MgbdyghrMl4u8HvjNjWPw/edit#gid=0">This spreadsheet</a> details overviews by data source, outlining the specific code/resources that correspond to each step in the general data flow shown below.</p>
<section id="data-ingest-diagram">
<span id="id1"></span><h2>Data ingest diagram<a class="headerlink" href="#data-ingest-diagram" title="Link to this heading">#</a></h2>
<div class="mermaid">
            flowchart TD

raw_data((Raw data  &lt;br&gt; in external source))
airflow_scrape{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; scraper}
airflow_parse{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; parser}
airflow_validate{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; GTFS validator}
airflow_external_tables{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; create&lt;br&gt;external tables}
dbt([&lt;br&gt;&lt;b&gt;dbt&lt;/b&gt;&lt;br&gt;&lt;br&gt;])
airflow_dbt{&lt;b&gt;Airflow&lt;/b&gt;: &lt;br&gt; run dbt}

subgraph first_bq[ ]
    bq_label1[BigQuery&lt;br&gt;External tables dataset]
    ext_raw_outcomes[(Scrape outcomes&lt;br&gt;external table)]
    ext_parse_data[(Parsed data&lt;br&gt;external table)]
    ext_parse_outcomes[(Parse outcomes&lt;br&gt;external table)]
    ext_validations[(Validations&lt;br&gt;external table)]
    ext_validation_outcomes[(Validation outcomes&lt;br&gt;external table)]
end

subgraph second_bq[ ]
    bq_label2[BigQuery&lt;br&gt;Staging, mart, etc. datasets]
    bq_table_example[(staging_*.table_names)]
    bq_table_example2[(mart_*.table_names)]
    bq_table_example3[(etc.)]
end

subgraph first_gcs[ ]
    gcs_label1[Google Cloud Storage:&lt;br&gt;Raw bucket]
    raw_gcs[Raw data]
    raw_outcomes_gcs[Scrape outcomes file]
end

subgraph second_gcs[ ]
    gcs_label2[Google Cloud Storage:&lt;br&gt;Parsed bucket]
    parse_gcs[Parsed data]
    parse_outcomes_gcs[Parse outcomes file]
end

subgraph validated_gcs[ ]
    gcs_label3[&lt;i&gt;GTFS ONLY&lt;/i&gt; &lt;br&gt; Google Cloud Storage:&lt;br&gt;Validation bucket]
    validation_gcs[Validations data]
    validation_outcomes_gcs[Validation outcomes file]
end

raw_data -- read by--&gt; airflow_scrape
airflow_scrape -- writes data to--&gt; raw_gcs
airflow_scrape -- writes operation outcomes to--&gt; raw_outcomes_gcs
raw_gcs -- read by--&gt; airflow_parse
airflow_parse -- writes data to--&gt; parse_gcs
airflow_parse -- writes operation outcomes to--&gt; parse_outcomes_gcs

raw_gcs -- if GTFS then read by--&gt; airflow_validate
airflow_validate -- writes data to--&gt; validation_gcs
airflow_validate -- writes operation outcomes to--&gt; validation_outcomes_gcs

parse_outcomes_gcs -- external tables  defined by--&gt; airflow_external_tables
parse_gcs -- external tables  defined by--&gt; airflow_external_tables
raw_outcomes_gcs -- external tables  defined by--&gt; airflow_external_tables
validation_outcomes_gcs -- external tables  defined by--&gt; airflow_external_tables
validation_gcs -- external tables  defined by--&gt; airflow_external_tables


airflow_external_tables -- defines--&gt; ext_raw_outcomes
airflow_external_tables -- defines--&gt; ext_parse_data
airflow_external_tables -- defines--&gt; ext_parse_outcomes
airflow_external_tables -- defines--&gt; ext_validation_outcomes
airflow_external_tables -- defines--&gt; ext_validations

airflow_dbt -- runs--&gt; dbt
ext_raw_outcomes -- read as source by--&gt;dbt
ext_parse_data -- read as source by--&gt;dbt
ext_parse_outcomes -- read as source by--&gt;dbt
ext_validations -- read as source by--&gt;dbt
ext_validation_outcomes -- read as source by--&gt;dbt


dbt -- orchestrates transformations to create--&gt;second_bq

classDef default fill:white, color:black, stroke:black, stroke-width:1px

classDef gcs_group_boxstyle fill:lightblue, color:black, stroke:black, stroke-width:1px

classDef bq_group_boxstyle fill:lightgreen, color:black, stroke:black, stroke-width:1px

classDef raw_datastyle fill:yellow, color:black, stroke:black, stroke-width:1px

classDef dbtstyle fill:darkgreen, color:white, stroke:black, stroke-width:1px

classDef group_labelstyle fill:lightgray, color:black, stroke-width:0px

class raw_data raw_datastyle
class dbt dbtstyle
class first_gcs,second_gcs,validated_gcs gcs_group_boxstyle
class first_bq,second_bq bq_group_boxstyle
class gcs_label1,gcs_label2,gcs_label3,bq_label1,bq_label2 group_labelstyle
        </div></section>
<section id="adding-a-new-data-source">
<h2>Adding a new data source<a class="headerlink" href="#adding-a-new-data-source" title="Link to this heading">#</a></h2>
<p>Adding a new data source based on the architecture described above involves several steps, outlined below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’re bringing in data that is similar to existing data (for example, a new subset of an existing dataset like a new Airtable or Littlepay table), you should follow the existing patterns for that dataset. <a class="reference external" href="https://docs.google.com/spreadsheets/d/1bv1K5lZMnq1eCSZRy3sPd3MgbdyghrMl4u8HvjNjWPw/edit#gid=0">This spreadsheet</a> gives overviews of some prominent existing data sources, outlining the specific code/resources that correspond to each step in the <a class="reference internal" href="#data-ingest-diagram"><span class="std std-ref">general data flow</span></a> for that data source.</p>
</div>
<section id="decide-on-an-approach">
<h3>0. Decide on an approach<a class="headerlink" href="#decide-on-an-approach" title="Link to this heading">#</a></h3>
<p>To determine the most appropriate ingest approach and storage location for your raw data (especially if that data requires manual curation), consult the <a class="reference external" href="https://docs.google.com/document/d/1-l6c99UUZ0o3Ln9S_CAt7iitGHvriewWhKDftESE2Dw/edit">Data Collection and Storage Guidance within the Cal-ITP Data Pipeline Google Doc</a>.</p>
<p>The <a class="reference internal" href="../warehouse/developing_dbt_models.html#tool-choice"><span class="std std-ref">Should it be a dbt model?</span></a> docs section also has some guidance about when a data pipeline should be created.</p>
</section>
<section id="bring-data-into-google-cloud-storage">
<h3>1. Bring data into Google Cloud Storage<a class="headerlink" href="#bring-data-into-google-cloud-storage" title="Link to this heading">#</a></h3>
<p>We store our raw, un-transformed data in Google Cloud Storage, usually in perpetuity, to ensure that we can always recover the raw data if needed. This allows us to fully re-process and re-transform historical data as needed rather than relying solely on old dashboards and reports, a powerful tool to create new uses for old data over time.</p>
<p>We store data in <a class="reference external" href="https://cloud.google.com/bigquery/docs/hive-partitioned-queries#supported_data_layouts">hive-partitioned buckets</a> so that data is clearly labeled and partitioned for better performance - discussed more in the next section. We use UTC dates and timestamps in hive paths (for example, for the timestamp of the data extract) for consistency across all data sources in the ecosystem.</p>
<p>You will need to set up a way to bring your raw data into the Cal-ITP Google Cloud Storage environment. Most commonly, we use <a class="reference external" href="https://airflow.apache.org/">Airflow</a> for this.</p>
<p>The <a class="reference external" href="https://github.com/cal-itp/data-infra/tree/main/airflow#readme">Airflow README in the data-infra repo</a> has information about how to set up Airflow locally for testing and how the Cal-ITP Airflow project is structured.</p>
<p>We often bring data into our environment in two steps, created as two separate Airflow <a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html">DAGs</a>:</p>
<ul class="simple">
<li><p><strong>Sync the fully-raw data in its original format:</strong> See for example the changes in the <code class="docutils literal notranslate"><span class="pre">airflow/dags/sync_elavon</span></code> directory in <a class="reference external" href="https://github.com/cal-itp/data-infra/pull/2376/files">data-infra PR #2376</a> (note: this example is typical in terms of its overall structure and use of Cal-ITP storage classes and methods, but the specifics of how to access and request the upstream data source will vary). We do this to preserve the raw data in its original form. This data might be saved in a <code class="docutils literal notranslate"><span class="pre">calitp-&lt;your-data-source&gt;-raw</span></code> bucket.</p></li>
<li><p><strong>Convert the saved raw data into a BigQuery-readable gzipped JSONL file:</strong> See for example the changes in the <code class="docutils literal notranslate"><span class="pre">airflow/dags/parse_elavon</span></code> directory in <a class="reference external" href="https://github.com/cal-itp/data-infra/pull/2376/files">data-infra PR #2376</a>. This prepares the data is to be read into BigQuery. <strong>Conversion here should be limited to the bare minimum needed to make the data BigQuery-compatible - converting column names that would be invalid in BigQuery, changing the file type to gzipped JSONL, etc.</strong> Note that conversion to JSONL is widespread across Cal-ITP pipelines because that data format is easy to read by BigQuery external tables in the next step of the ingest process, while also supporting complex or nested data structures. This data might be saved in a <code class="docutils literal notranslate"><span class="pre">calitp-&lt;your-data-source&gt;-parsed</span></code> bucket.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When you merge a pull request creating a new Airflow DAG, that DAG will be paused by default. To start the DAG, someone will need to log into <a class="reference external" href="https://b2062ffca77d44a28b4e05f8f5bf4996-dot-us-west2.composer.googleusercontent.com/home">the Airflow UI (requires Composer access in Cal-ITP Google Cloud Platform instance)</a> and unpause the DAG.</p>
</div>
</section>
<section id="create-external-tables">
<h3>2. Create external tables<a class="headerlink" href="#create-external-tables" title="Link to this heading">#</a></h3>
<p>We use <a class="reference external" href="https://cloud.google.com/bigquery/docs/external-data-sources#external_tables">external tables</a> to allow BigQuery to query data stored in Google Cloud Storage. External tables do not move data into BigQuery; they simply define the data schema which BigQuery can then use to access the data still stored in Google Cloud Storage. Because we used Hive-partitioned file naming conventions in the previous step, BigQuery can save significant resources when querying external tables by targeting only a subset of the simulated subfolders in a given GCS bucket when corresponding filters are applied (like a filter on a “dt” field represented in a partition).</p>
<p>External tables are created by the <a class="reference external" href="https://github.com/cal-itp/data-infra/tree/main/airflow/dags/create_external_tables"><code class="docutils literal notranslate"><span class="pre">create_external_tables</span></code> Airflow DAG</a> using the <a class="reference external" href="https://github.com/cal-itp/data-infra/blob/main/airflow/plugins/operators/external_table.py">ExternalTable custom operator</a>. Testing guidance and example YAML for how to create your external table is provided in the <a class="reference external" href="https://github.com/cal-itp/data-infra/tree/main/airflow/dags/create_external_tables#create_external_tables">Airflow DAG documentation</a>.</p>
</section>
<section id="dbt-modeling">
<h3>3. dbt modeling<a class="headerlink" href="#dbt-modeling" title="Link to this heading">#</a></h3>
<p>After reading the parsed raw files into external tables, those external tables are generally not queried directly by analysts or by dashboards. Instead, they are made useful through modeling and transformations managed by dbt, a tool that enhances SQL-based workflows with concepts from software engineering, like version control. Guidance for dbt modeling is outlined on the <a class="reference internal" href="../warehouse/developing_dbt_models.html#developing-dbt-models"><span class="std std-ref">Developing models in dbt</span></a> page of this docs site.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./architecture"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="images_and_packages.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Published Images and Packages</p>
      </div>
    </a>
    <a class="right-next"
       href="../airflow/dags-maintenance.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Airflow Operational Considerations</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-ingest-diagram">Data ingest diagram</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-new-data-source">Adding a new data source</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decide-on-an-approach">0. Decide on an approach</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bring-data-into-google-cloud-storage">1. Bring data into Google Cloud Storage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-external-tables">2. Create external tables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dbt-modeling">3. dbt modeling</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cal-ITP
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>