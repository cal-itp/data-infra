
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DAGs Maintenance &#8212; Cal-ITP Data Services</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Kubernetes" href="../kubernetes/README.html" />
    <link rel="prev" title="Production Maintenance" href="production-maintenance.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SZB618VNBZ"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-SZB618VNBZ');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/calitp_logo_MAIN.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Cal-ITP Data Services</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Data Services Documentation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Analysts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_welcome/overview.html">
   Welcome!
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_welcome/what_is_calitp.html">
     Cal-ITP Project Information (WIP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_welcome/about_our_team.html">
     Team Members (WIP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_welcome/how_we_work.html">
     How We Work (WIP)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analytics_onboarding/overview.html">
   Technical Onboarding
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_tools/overview.html">
   Introduction to Analytics Tools
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/tools_quick_links.html">
     Tools Quick Links
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/bi_dashboards.html">
     Business Insights &amp; Dashboards
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/notebooks.html">
     Notebooks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/python_libraries.html">
     Python Libraries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/saving_code.html">
     Saving Code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/storing_data.html">
     Storing New Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/data_catalogs.html">
     Using Data Catalogs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../warehouse/overview.html">
   Introduction to the Warehouse (WIP)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/table_naming.html">
     Table Naming
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/agencies.html">
     Agency GTFS Feeds
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/views.html">
     Creating New Tables (Views)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/metrics.html">
     Metric Views
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/sql_snippets.html">
     SQL Snippets (WIP)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../datasets_and_tables/overview.html">
   Datasets &amp; Tables (WIP)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/gtfs_schedule.html">
     GTFS Schedule (WIP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/gtfs_rt.html">
     GTFS Realtime
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/mst_payments.html">
     MST Payments (WIP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/transitdatabase.html">
     Transit Database
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/views.html">
     Views (WIP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/tables.html">
     Tables (WIP)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_examples/overview.html">
   Analysis Examples
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_examples/warehouse_tutorial.html">
     Tutorial - Querying the Data Warehouse
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_examples/new_tutorial.html">
     More Complex Queries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_examples/sample-catalog-viewer.html">
     Sample Data Catalog
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_publishing/overview.html">
   How to Publish Analyses (WIP)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_publishing/how_to_publish.html">
     Publishing Reports with Pull Requests (WIP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_publishing/where_reports_live.html">
     Where Reports Live (WIP)
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Developers
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="overview.html">
   Airflow
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="local-setup.html">
     Local Airflow
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="static-schedule-pipeline.html">
     Static Schedule Pipeline
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="production-maintenance.html">
     Production Maintenance
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     DAGs Maintenance
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../kubernetes/README.html">
   Kubernetes
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../kubernetes/JupyterHub.html">
     JupyterHub
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ci/README.html">
   CI
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/Git-Flow-Services.html">
     Git Flow for Services
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/Pipeline-Variables.html">
     Pipeline Variables
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/build-docker-image.html">
     build-docker-image
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/build-git-notes.html">
     build-git-notes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/build-git-tag.html">
     build-git-tag
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/configure-build-git-notes.html">
     configure-build-git-notes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/configure-docker-login.html">
     configure-docker-login
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/configure-git-remote.html">
     configure-git-remote
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/release-kube-overlay.html">
     release-kube-overlay
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/validate-build-git-tag.html">
     validate-build-git-tag
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/validate-clean-worktree.html">
     validate-clean-worktree
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../services/overview.html">
   Services
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../services/gtfs-ckan-uploader.html">
     GTFS CKAN Uploader
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../services/gtfs-rt-archive.html">
     gtfs-rt-archive
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contribute to the Docs!
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../contribute/overview.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/contribute-best-practices.html">
     Best Practices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/submitting_changes.html">
     Submitting Changes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/content_types.html">
     Common Content
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/airflow/dags-maintenance.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/cal-itp/data-infra/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/cal-itp/data-infra//issues/new?title=Issue%20on%20page%20%2Fairflow/dags-maintenance.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/cal-itp/data-infra/edit/main/docs/airflow/dags-maintenance.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gtfs-schedule-dags-maintenance">
   GTFS Schedule - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dags-overview">
     DAGs Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#common-issues">
     Common Issues
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#backfilling">
     Backfilling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gtfs-realtime-dags-maintenance">
   GTFS Realtime - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     DAGs Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extraction">
     Extraction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#logging">
     Logging
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validation">
     Validation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Backfilling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mst-payments-dags-maintenance">
   MST Payments - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     DAGs Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-new-tables-in-payments-loader">
     Adding New Tables in payments_loader
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-new-table-to-payments-views">
     Adding a New Table to payments_views
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Backfilling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transit-database-dags-maintenance">
   Transit Database - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     DAGs Overview
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#views-dags-maintenance">
   Views - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     DAGs Overview
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>DAGs Maintenance</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gtfs-schedule-dags-maintenance">
   GTFS Schedule - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dags-overview">
     DAGs Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#common-issues">
     Common Issues
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#backfilling">
     Backfilling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gtfs-realtime-dags-maintenance">
   GTFS Realtime - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     DAGs Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extraction">
     Extraction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#logging">
     Logging
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validation">
     Validation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Backfilling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mst-payments-dags-maintenance">
   MST Payments - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     DAGs Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-new-tables-in-payments-loader">
     Adding New Tables in payments_loader
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-new-table-to-payments-views">
     Adding a New Table to payments_views
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Backfilling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transit-database-dags-maintenance">
   Transit Database - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     DAGs Overview
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#views-dags-maintenance">
   Views - DAGs Maintenance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     DAGs Overview
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="dags-maintenance">
<h1>DAGs Maintenance<a class="headerlink" href="#dags-maintenance" title="Permalink to this headline">¶</a></h1>
<p>Use this page to find information on maintenance of the DAGs that support our data pipelines.</p>
<ol class="simple">
<li><p><a class="reference internal" href="#gtfs-schedule-dags"><span class="std std-ref">GTFS Schedule DAGs</span></a></p></li>
<li><p><a class="reference internal" href="#gtfs-realtime-dags"><span class="std std-ref">GTFS Realtime DAGs</span></a></p></li>
<li><p><a class="reference internal" href="#mst-payments-dags"><span class="std std-ref">MST Payments DAGs</span></a></p></li>
<li><p><a class="reference internal" href="#transit-database-dags"><span class="std std-ref">Transit Database DAGs</span></a></p></li>
<li><p><a class="reference internal" href="#views-dags"><span class="std std-ref">Views DAGs</span></a></p></li>
</ol>
<div class="section" id="gtfs-schedule-dags-maintenance">
<span id="gtfs-schedule-dags"></span><h2>GTFS Schedule - DAGs Maintenance<a class="headerlink" href="#gtfs-schedule-dags-maintenance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dags-overview">
<h3>DAGs Overview<a class="headerlink" href="#dags-overview" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="common-issues">
<h3>Common Issues<a class="headerlink" href="#common-issues" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="backfilling">
<h3>Backfilling<a class="headerlink" href="#backfilling" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="gtfs-realtime-dags-maintenance">
<span id="gtfs-realtime-dags"></span><h2>GTFS Realtime - DAGs Maintenance<a class="headerlink" href="#gtfs-realtime-dags-maintenance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>DAGs Overview<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Currently, 3 DAGs are used with GTFS RT data:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rt_loader_files</span></code>: Populates a table called <code class="docutils literal notranslate"><span class="pre">gtfs_rt.calitp_files</span></code> that has one row per
sample of GTFS RT data. For example, a vehicle positions file downloaded at a specific point in time.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rt_loader</span></code>: handles the rectangling and loading of GTFS RT and validation data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rt_views</span></code>: exposes user-friendly views for analysis.</p></li>
</ul>
<p>Internal data should live in the <code class="docutils literal notranslate"><span class="pre">gtfs_rt</span></code> dataset on bigquery, while those that are
broadly useful across the org should live in <code class="docutils literal notranslate"><span class="pre">views</span></code>.</p>
</div>
<div class="section" id="extraction">
<h3>Extraction<a class="headerlink" href="#extraction" title="Permalink to this headline">¶</a></h3>
<p>Extraction of GTFS RT feeds is handled by the <a class="reference internal" href="../services/gtfs-rt-archive.html"><span class="doc std std-doc">gtfs-rt-archive service</span></a>. Within the service, <code class="docutils literal notranslate"><span class="pre">agencies.yml</span></code> is read into separate threads and each RT feed is uploaded to a GCPBucketWriter via a post request. This data is stored in a kubernetes cluster <code class="docutils literal notranslate"><span class="pre">data-infra-apps</span></code>.</p>
</div>
<div class="section" id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h3>
<p>Within the gtfs-rt-archive service, A logger channel is set up with the <code class="docutils literal notranslate"><span class="pre">logging</span></code> facility for Python. If an error is raised within the service, the log messages are also uploaded and stored in the cluster <code class="docutils literal notranslate"><span class="pre">data-infra-apps</span></code>. Within this logger object some of the errors we are currently logging and their associated error levels:</p>
<ul class="simple">
<li><p>missing feeds (Warning)</p></li>
<li><p>missing itp_id (Warning)</p></li>
<li><p>event dropped (Warning)</p></li>
<li><p>ticker (Debug)</p></li>
<li><p>error fetching URL (Info)</p></li>
</ul>
<p>Google cloud automatically creates specific buckets called ‘logging buckets’ when a kubernetes cluster is stood up, these are called <code class="docutils literal notranslate"><span class="pre">_Default</span></code> and <code class="docutils literal notranslate"><span class="pre">_Required</span></code>. Cloud Logging provides these two predefined sinks for each Cloud Project. All logs that are generated in a resource are automatically processed through those two sinks and then are stored either in the <code class="docutils literal notranslate"><span class="pre">_Required</span></code> or <code class="docutils literal notranslate"><span class="pre">_Default</span></code> Buckets. <code class="docutils literal notranslate"><span class="pre">_Required</span></code> has retention for 400 days and appears to have mostly audit log functionality for data compliance. We are mostly using _Default which has a retention of 30 days to log all of our cloud services. <code class="docutils literal notranslate"><span class="pre">_Default</span></code> gets updated from the kubernetes cluster in hourly batches. We created a log sink called <code class="docutils literal notranslate"><span class="pre">rt-extract-to-bigquery</span></code> that filters the logs within <code class="docutils literal notranslate"><span class="pre">_Default</span></code> for the namespace <code class="docutils literal notranslate"><span class="pre">resource.labels.namespace_name=&quot;gtfs-rt&quot;</span></code>. To reliably route logs, the log router stores the logs temporarily, which buffers against temporary disruptions on any sink. According to this documentation, the log logging frequency between Cloud Logging and Bigquery is <a class="reference external" href="https://cloud.google.com/logging/docs/export/using_exported_logs#bigquery-frequency">near real-time</a>.</p>
<p>Within The BigQuery table, the error messages are stored within the stdout table. The table names are generated automatically through the cloud router and cannot be renamed. The stout table is a partitioned table that does not have any limits on storage size currently. See <a class="reference external" href="https://cloud.google.com/logging/docs/routing/overview">Google Cloud Log Router docs</a> for more information. The raw logs may be browsed in the <a class="reference external" href="https://console.cloud.google.com/logs/query?project=cal-itp-data-infra">Logs Explorer</a>.</p>
</div>
<div class="section" id="validation">
<h3>Validation<a class="headerlink" href="#validation" title="Permalink to this headline">¶</a></h3>
<p>Validation of GTFS RT uses the <a class="reference external" href="https://github.com/cal-itp/gtfs-rt-validator-api">gtfs-rt-validator-api</a>.
This repo publishes a docker image on every release, so that it can used from a KubernetesPodOperator.
It allows for fetching GTFS RT and schedule data from our cloud storage, validating, and putting the results
back into cloud storage.</p>
<p>Note that the validation process requires two pieces per feed:</p>
<ul class="simple">
<li><p>a zipped GTFS Schedule</p></li>
<li><p>realtime feed data (e.g. vehicle positions, trip updates, service alerts)</p></li>
</ul>
</div>
<div class="section" id="id2">
<h3>Backfilling<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>This DAG does not have any tasks that <code class="docutils literal notranslate"><span class="pre">depends_on_past</span></code>, so you should be able to
clear and re-run tasks as needed.</p>
</div>
</div>
<div class="section" id="mst-payments-dags-maintenance">
<span id="mst-payments-dags"></span><h2>MST Payments - DAGs Maintenance<a class="headerlink" href="#mst-payments-dags-maintenance" title="Permalink to this headline">¶</a></h2>
<p>The ETL is currently a scheduled Google Data Transfer job that transfers all files to <code class="docutils literal notranslate"><span class="pre">gcs://littlepay-data-extract-prod</span></code></p>
<p>From there, tables are loaded into BigQuery as external tables in the <code class="docutils literal notranslate"><span class="pre">transaction_data</span></code> buclet.</p>
<div class="section" id="id3">
<h3>DAGs Overview<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The payments data is loaded and transformed in the payments_loader and payments_views dags.</p>
<p>The payments_loader dag has three kinds of tasks:</p>
<ul class="simple">
<li><p>ExternalTable operator tasks (e.g. <code class="docutils literal notranslate"><span class="pre">customer_funding_source</span></code>). These define the underlying data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calitp_included_payments_data</span></code> - a table of underlying payments table names defined in the task above.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">preprocessing_columns</span></code> - move data from <code class="docutils literal notranslate"><span class="pre">gs://littlepay-data-extract-prod</span></code> to <code class="docutils literal notranslate"><span class="pre">gs://gtfs-data</span></code>,
then process to keep only columns defined in external tables.</p></li>
</ul>
<p>The payments_views is made of SQL queries that transform the loaded tables above.</p>
</div>
<div class="section" id="adding-new-tables-in-payments-loader">
<h3>Adding New Tables in payments_loader<a class="headerlink" href="#adding-new-tables-in-payments-loader" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">customer_funding_source</span></code> task. The new task name should match the table it creates.</p></li>
<li><p>Alter <code class="docutils literal notranslate"><span class="pre">destination_project_dataset_table</span></code> and <code class="docutils literal notranslate"><span class="pre">source_objects</span></code> to match the new table name.</p></li>
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">schema_fields</span></code> to be the columns in the new table. If you are unsure of a column type,
specify it as “STRING”.</p>
<ul>
<li><p>Keep a <code class="docutils literal notranslate"><span class="pre">calitp_extracted_at</span></code> column at the end of the table. This column contains the execution date of the load task, and is added automatically by the <code class="docutils literal notranslate"><span class="pre">preprocess_columns</span></code> task.</p></li>
</ul>
</li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">calitp_included_payments_data</span></code> task,</p>
<ul>
<li><p>add a row for this new table.</p></li>
<li><p>add a depedency in yaml header to this new table.</p></li>
</ul>
</li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">docs/datasets/mst_payments.md</span></code> file, add an entry into the <code class="docutils literal notranslate"><span class="pre">Tables</span></code> table describing the new data set.</p></li>
</ul>
</div>
<div class="section" id="adding-a-new-table-to-payments-views">
<h3>Adding a New Table to payments_views<a class="headerlink" href="#adding-a-new-table-to-payments-views" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure your task is given the same name as the table it creates.</p></li>
<li><p>Be sure to include an <code class="docutils literal notranslate"><span class="pre">external_dependency</span></code> on payments_loader (see other views in payments_views).</p></li>
</ul>
</div>
<div class="section" id="id4">
<h3>Backfilling<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Clear the <code class="docutils literal notranslate"><span class="pre">preprocessing_columns</span></code> task for every day you want to re-run.
These tasks do not depend on past. However, because the extracted data in the littlepay bucket
can be mutated by littlepay, so if you clear a past task, you should clear them all!</p>
</div>
</div>
<div class="section" id="transit-database-dags-maintenance">
<span id="transit-database-dags"></span><h2>Transit Database - DAGs Maintenance<a class="headerlink" href="#transit-database-dags-maintenance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<h3>DAGs Overview<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="views-dags-maintenance">
<span id="views-dags"></span><h2>Views - DAGs Maintenance<a class="headerlink" href="#views-dags-maintenance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id6">
<h3>DAGs Overview<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./airflow"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="production-maintenance.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Production Maintenance</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../kubernetes/README.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Kubernetes</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Cal-ITP<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>