operator: operators.SqlToWarehouseOperator
dst_table_name: "views.validation_code_metrics"
dependencies:

  - warehouse_loaded
  - dim_date

sql: |
  WITH
  date_range AS (
      SELECT
          *
          , t2.full_date AS metric_date
      FROM `{{ "cal-itp-data-infra.gtfs_schedule_type2.validation_notices" | table }}` t1
      JOIN `{{ "cal-itp-data-infra.views.dim_date" | table }}` t2
      ON t1.calitp_extracted_at <= t2.full_date
          AND COALESCE(t1.calitp_deleted_at, DATE("2099-01-01")) > t2.full_date
          AND t2.full_date >= "2021-05-01" AND t2.full_date <= "2021-06-01"
  ),
  unique_codes AS (
        SELECT DISTINCT code FROM `{{ "cal-itp-data-infra.gtfs_schedule_type2.validation_notices" | table }}`
    ),
    agency_by_code AS (
        SELECT t3.*, t4.*,
        FROM `{{ "cal-itp-data-infra.views.gtfs_agency_names" | table }}` t3
        CROSS JOIN unique_codes t4
    ),
      code_metrics_partial AS (
        SELECT
        calitp_itp_id
        , calitp_url_number
        , metric_date
        , code
        , severity
        , COUNT(*) AS n_notices
    FROM date_range
    GROUP BY 1, 2, 3, 4, 5 
      )
   SELECT * EXCEPT (n_notices),
   COALESCE(n_notices, 0) as n_notices
   FROM agency_by_code 
   JOIN `code_metrics_partial` USING (calitp_itp_id,calitp_url_number,code)
