operator: 'operators.PodOperator'
name: 'publish-california-open-data'
image: 'ghcr.io/cal-itp/data-infra/warehouse:{{ image_tag() }}'

cmds:
  - python3
arguments:
  - '/app/scripts/publish.py'
  - 'publish-exposure'
  - 'california_open_data'
  - '{% if is_development() %}--no-publish{% else %}--publish{% endif %}'
  - '--bucket'
  - "{{ env_var('CALITP_BUCKET__PUBLISH') }}"
  - '--manifest'
  - "{{ env_var('CALITP_BUCKET__DBT_ARTIFACTS') }}/latest/manifest.json"

is_delete_operator_pod: true
get_logs: true
is_gke: true
pod_location: us-west1
cluster_name: data-infra-apps
namespace: airflow-jobs

env_vars:
  GOOGLE_APPLICATION_CREDENTIALS: /secrets/jobs-data/service_account.json

secrets:
  - deploy_type: volume
    deploy_target: /secrets/jobs-data/
    secret: jobs-data
    key: service-account.json
  - deploy_type: env
    deploy_target: CALITP_CKAN_GTFS_SCHEDULE_KEY
    secret: jobs-data
    key: calitp-ckan-gtfs-schedule-key

resources:
  request_memory: 2.0Gi
  request_cpu: 1

tolerations:
  - key: pod-role
    operator: Equal
    value: computetask
    effect: NoSchedule

affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: pod-role
          operator: In
          values:
          - computetask
