name: Generate diff of Kubernetes changes

on:
  pull_request:
    branches:
      - 'main'
    paths:
      - '.holo/config.toml'
      - '.holo/sources/jarvus-cluster-template.toml'
      - '.holo/branches/releases/**'
      - '.github/workflows/service-*'
      - 'ci/**'
      - 'kubernetes/apps/**'
      - 'kubernetes/system/**'

env:
  GITHUB_TOKEN: ${{ secrets.GH_ACTIONS_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      CLOUDSDK_CORE_PROJECT: cal-itp-data-infra
      GKE_NAME: data-infra-apps
      GKE_REGION: us-west1
      USE_GKE_GCLOUD_AUTH_PLUGIN: True
    steps:
      # Setup
      - uses: actions/checkout@v4

      - uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud components install gke-gcloud-auth-plugin
      - uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.GKE_NAME }}
          location: ${{ env.GKE_REGION }}
      - run: curl -sSL https://install.python-poetry.org | python -
      - name: Set up hologit
        env:
          BIO_RELEASE: 1.6.821
        run: |
          curl -LO "https://github.com/biome-sh/biome/releases/download/$BIO_RELEASE/bio-$BIO_RELEASE-x86_64-linux.tar.gz"
          tar xzvf "bio-$BIO_RELEASE-x86_64-linux.tar.gz"
          sudo mv bio /usr/local/bin/bio
          sudo bio pkg install --binlink jarvus/hologit

      # Render Kubernetes content with parent underlay and checkout
      - run: git holo project release-candidate --commit-to=kubernetes
      - run: git checkout kubernetes

      # Diff and write back to PR
      - id: diff
        name: Run poetry invoke
        shell: bash
        working-directory: ci
        run: |
          export RELEASE_CHANNEL=${GITHUB_BASE_REF#releases/}
          printf 'WORKFLOW: service-release-diff; RELEASE_CHANNEL=%s\n' "$RELEASE_CHANNEL"
          poetry install
          poetry run invoke diff -f "./channels/$RELEASE_CHANNEL.yaml" --outfile=diff.md

      - uses: peter-evans/find-comment@v2
        id: fc
        with:
          issue-number: ${{ github.event.number }}
          comment-author: 'github-actions[bot]'
          direction: last
      - uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.number }}
          body-file: "ci/diff.txt"
          edit-mode: replace
