name: Generate diff of Kubernetes changes

on:
  pull_request:
    branches:
      - 'main'
    paths:
      - '.holo/config.toml'
      - '.holo/sources/jarvus-cluster-template.toml'
      - '.holo/branches/kubernetes-workspace/**'
      - '.github/workflows/*-kubernetes.yml'
      - 'ci/**'
      - 'kubernetes/apps/**'
      - 'kubernetes/system/**'

env:
  GITHUB_TOKEN: ${{ secrets.GH_ACTIONS_TOKEN }}

jobs:
  preview-kubernetes:
    runs-on: ubuntu-latest
    env:
      CLOUDSDK_CORE_PROJECT: cal-itp-data-infra
      GKE_NAME: data-infra-apps
      GKE_REGION: us-west1
      USE_GKE_GCLOUD_AUTH_PLUGIN: True
    steps:
      # Setup
      - uses: actions/checkout@v4

      - uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud components install gke-gcloud-auth-plugin
      - uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.GKE_NAME }}
          location: ${{ env.GKE_REGION }}
      - run: curl -sSL https://install.python-poetry.org | python -
      - name: Set up hologit
        run: npm install -g hologit
      - name: Configure git identity
        run: |
          git config user.name "Github Action $GITHUB_JOB"
          git config user.email "$(whoami)@$(uname -n)"

      # Render Kubernetes content with parent underlay and checkout
      - run: git holo project kubernetes-workspace --commit-to=kubernetes
      - run: git checkout kubernetes

      # Diff and write back to PR
      - run: poetry install
        working-directory: ci
      - run: poetry run invoke diff -f "./kubernetes-workloads.yaml" --outfile=diff.md
        working-directory: ci
      - uses: peter-evans/find-comment@v2
        id: fc
        with:
          issue-number: ${{ github.event.number }}
          comment-author: 'github-actions[bot]'
          direction: last
      - uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.number }}
          body-file: "ci/diff.md"
          edit-mode: replace

  validate-container-images:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract and validate JupyterHub images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          VALUES_FILE="kubernetes/apps/charts/jupyterhub/values.yaml"
          IMAGES=()
          MISSING=()

          # Extract default image (name + tag format)
          DEFAULT_NAME=$(yq '.jupyterhub.singleuser.image.name' "$VALUES_FILE")
          DEFAULT_TAG=$(yq '.jupyterhub.singleuser.image.tag' "$VALUES_FILE")
          if [[ "$DEFAULT_NAME" != "null" && "$DEFAULT_TAG" != "null" ]]; then
            IMAGES+=("${DEFAULT_NAME}:${DEFAULT_TAG}")
          fi

          # Extract profileList images (full image:tag format)
          PROFILE_IMAGES=$(yq eval '.jupyterhub.singleuser.profileList[].kubespawner_override.image' "$VALUES_FILE" 2>/dev/null | grep -v '^null$' | sort -u)
          while IFS= read -r img; do
            if [[ -n "$img" ]]; then
              IMAGES+=("$img")
            fi
          done <<< "$PROFILE_IMAGES"

          # Deduplicate
          readarray -t UNIQUE_IMAGES < <(printf '%s\n' "${IMAGES[@]}" | sort -u)

          echo "Found ${#UNIQUE_IMAGES[@]} unique images to validate:"
          printf '  - %s\n' "${UNIQUE_IMAGES[@]}"
          echo ""

          # Validate each image
          for image in "${UNIQUE_IMAGES[@]}"; do
            if [[ "$image" =~ ^ghcr\.io/([^/]+)/(.+):(.+)$ ]]; then
              ORG="${BASH_REMATCH[1]}"
              PACKAGE="${BASH_REMATCH[2]}"
              TAG="${BASH_REMATCH[3]}"
              PACKAGE_ENCODED="${PACKAGE//\//%2F}"

              echo "Checking: $image"

              # Query GitHub API for package versions
              if ! API_RESPONSE=$(gh api \
                -H "Accept: application/vnd.github+json" \
                "/orgs/${ORG}/packages/container/${PACKAGE_ENCODED}/versions" \
                --paginate 2>&1); then
                echo "  ✗ API error: $API_RESPONSE"
                MISSING+=("$image (API error)")
              else
                TAG_COUNT=$(echo "$API_RESPONSE" | jq -r "[.[].metadata.container.tags[] | select(. == \"$TAG\")] | length")
                if [[ "$TAG_COUNT" -gt 0 ]]; then
                  echo "  ✓ Image exists"
                else
                  echo "  ✗ Tag '$TAG' not found"
                  MISSING+=("$image")
                fi
              fi
            else
              echo "Skipping non-ghcr.io image: $image"
            fi
          done

          echo ""
          if [[ ${#MISSING[@]} -gt 0 ]]; then
            echo "========================================"
            echo "ERROR: The following images are missing:"
            echo "========================================"
            printf '  - %s\n' "${MISSING[@]}"
            echo ""
            echo "Ensure images are built and pushed before merging."
            exit 1
          else
            echo "========================================"
            echo "SUCCESS: All images validated"
            echo "========================================"
          fi
