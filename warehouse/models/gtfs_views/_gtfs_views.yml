version: 2

sources:
  - name: gtfs_schedule_history
    description: Data in the gtfs_schedule_history dataset in BigQuery
    database: cal-itp-data-infra
    schema: gtfs_schedule_history
    tables:
      - name: calitp_files_updates
      - name: calitp_included_gtfs_tables

models:
  - name: dim_date
    description: |
      Each row is a date.
    columns:
      - name: id
        description: Date formatted as string for identification, in "YYYY-MM-DD" format, ex. "2022-03-31".
        tests:
          - not_null
          - unique
      - name: full_date
        description: Date formatted as a date; formatted as YYYY-MM-DD, ex. 2022-03-31.
        tests:
          - not_null
      - name: year
        description: Year portion of date as an integer, ex. 2022.
        tests:
          - not_null
      - name: year_week
        description: Week number within the year (integer between 0 and 53 -- see BigQuery date function EXTRACT WEEK documentation for details)
        tests:
          - not_null
      - name: Day number within the year (integer between 1 and 366)
        description: '{{ doc("column_schedule_file_key") }}'
        tests:
          - not_null
          - unique
      - name: fiscal_year
        description: Year portion of date as an integer, ex. 2022.
        tests:
          - not_null
      - name: fiscal_qtr
        description: Date's quarter (string "1", "2", "3", or "4"; see BigQuery FORMAT DATE %Q documentation for details)
        tests:
          - not_null
      - name: month
        description: Date's month number (integer from 1 to 12; see BigQuery date function EXTRACT MONTH documentation for details)
        tests:
          - not_null
      - name: month_name
        description: Date's month name (string ex. "January"; see BigQuery FORMAT DATE %B documentation for details)
        tests:
          - not_null
      - name: week_day
        description: Date's day number within the week (string value from "0" to "6" with "0" corresponding to Sunday; see BigQuery FORMAT DATE %w documentation for details)
        tests:
          - not_null
      - name: day_name
        description: Date's day name (string ex. "Monday"; see BigQuery FORMAT DATE %A documentation for details)
        tests:
          - not_null
      - name: day_is_weekday
        description: Integer value 1 when day_name is "Saturday" or "Sunday", else integer value 0.
        tests:
          - not_null
      - name: is_quarter_start
        description: Boolean indicator for whether the date is first day of quarter (true indicates one of January 1, April 1, July 1, October 1)
        tests:
          - not_null
      - name: is_month_start
        description: Boolean indicator for whether the date is first day of its month (true indicates 1st day of month)
        tests:
          - not_null
      - name: is_in_past
        description: |
          Boolean indicator for whether the given date was earlier than
          the date that the table was most recently generated;
          true indicates that given date is before the date on which the table was last generated.
        tests:
          - not_null
      - name: is_in_past_or_present
        description: |
          Boolean indicator for whether the given date was earlier than or equal to
          the date that the table was most recently generated;
          true indicates that given date is before or equal to the date on which the table was last generated.
        tests:
          - not_null
      - name: is_in_future
        description: |
          Boolean indicator for whether the given date was later than
          the date that the table was most recently generated;
          true indicates that given date is after the date on which the table was last generated.
        tests:
          - not_null
      - name: is_gtfs_schedule_range
        description: |
          Boolean indicator for whether the given date is after 2021-04-15
          (the date that Cal-ITP started collecting GTFS schedule data) and
          before or equal to the date that the table was most recently generate;
          true indicates that given date is strictly after 2021-04-15 and
          earlier than or equal to the date on which the table was last generated.
        tests:
          - not_null
  - name: dim_metric_date
    description: |
      Each row is a date range (for example, daily, monthly, rolling 7 day period) over which a metric can be calculated.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - metric_period
            - metric_date
    columns:
      - name: metric_period
        description: The specific range of dates used (e.g. rolling_7, rolling_28, day, month, quarter)
        tests:
          - not_null
      - name: metric_date
        description: The date the metric_period describes. For example, rolling_7 goes from metric_date to 7 days earlier.
        tests:
          - not_null
      - name: metric_type
        description: The category of metric_period (rolling, daily, calendar)
        tests:
          - not_null
      - name: start_date
        description: The beginning of the metric_period (inclusive). Note that for daily this is NULL, so data for the same day isn't selected twice
      - name: end_date
        description: The end of the metric_period (inclusive). For rolling windows, this is the metric_date. For calendar, this is metric_date - 1 day (E.g. Jan 1st describes December, etc..)
        tests:
          - not_null
  - name: gtfs_schedule_dim_feeds
    description: |
      Slowly-changing dimension table of all Cal-ITP feeds.
      Contents are a combination of Cal-ITP metadata and, where available,
      data from feed_info.txt.
    columns:
      - name: feed_key
        tests:
          - not_null
          - unique
  - name: gtfs_schedule_dim_files
    description: |
      Dimension table of all files that have been encountered in Cal-ITP
      GTFS downloads, with indicators for whether they are loaded into a
      table in the warehouse and whether they are required by the GTFS
      specification.
    columns:
      - name: file_key
        tests:
          - not_null
          - unique
