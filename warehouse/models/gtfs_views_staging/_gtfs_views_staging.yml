version: 2

sources:
  - name: gtfs_rt_raw
    description: Data in the gtfs_rt dataset in BigQuery, generally produced by the rt_loader and rt_loader_files Airflow DAGs.
    database: cal-itp-data-infra
    schema: gtfs_rt
    tables:
      - name: calitp_files
        description: List of RT files produced by rt_loader_files.calitp_files_process Airflow DAG task, loaded into BigQuery via rt_loader_files.external_calitp_files DAG task (defines external table).


models:
  - name: gtfs_rt_fact_files
    description: |
      Each row is a GTFS realtime file that was downloaded.
      Note that presence of a file is not a guarantee that the downloaded file is complete or valid.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - calitp_extracted_at
            - calitp_itp_id
            - calitp_url_number
            - name
    columns:
      - name: calitp_extracted_at
        description: Timestamp when this file was extracted
        tests:
          - not_null
      - name: calitp_itp_id
        description: '{{ doc("field_calitp_itp_id") }}'
        tests:
          - not_null
      - name: calitp_url_number
        description: '{{ doc("field_calitp_url_number") }}'
        tests:
          - not_null
      - name: name
        description: File type (service_alerts, trip_updates, or vehicle_positions)
        tests:
          - not_null
      - name: size
        description: File size in bytes
        tests:
          - not_null
      - name: md5_hash
        description: Hash of file contents
        tests:
          - not_null
      - name: date_extracted
        description: Date extracted from calitp_extracted_at
        tests:
          - not_null
      - name: hour_extracted
        description: Hour extracted from calitp_extracted_at
        tests:
          - not_null
      - name: minute_extracted
        description: Minute extracted from calitp_extracted_at
        tests:
          - not_null

  - name: gtfs_rt_fact_files_wide_hourly
    description: |
      Each row is one day of realtime data for a given feed (ITP ID + URL number + realtime type), with count of files downloaded by hour.
      Note that presence of a file is not a guarantee that the downloaded file is complete or valid.
      Hours here are in UTC.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date_extracted
            - calitp_itp_id
            - calitp_url_number
            - name
    columns:
      - name: date_extracted
        description: Date extracted from calitp_extracted_at
        tests:
          - not_null
      - name: calitp_itp_id
        description: '{{ doc("field_calitp_itp_id") }}'
        tests:
          - not_null
      - name: calitp_url_number
        description: '{{ doc("field_calitp_url_number") }}'
        tests:
          - not_null
      - name: name
        description: File type (service_alerts, trip_updates, or vehicle_positions)
        tests:
          - not_null
      - name: file_count_hr_0
        description: Count of files extracted during hour 0 UTC
