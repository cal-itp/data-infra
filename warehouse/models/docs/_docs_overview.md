{% docs __calitp_warehouse__ %}
# Cal-ITP Data Warehouse

The Cal-ITP Data Warehouse contains four core types of data (a few other data sources are available, but the primary data models are composed of the following):

* **GTFS pipeline data, generally in `mart_gtfs`**: This is [GTFS data](https://gtfs.org/) (both schedule and realtime) scraped by the Cal-ITP pipeline. The raw data here is produced by transit agencies and is of variable quality and completeness. To understand the GTFS data format and terms (for example, "trips", "stops", "routes"), the GTFS specification documentation at [gtfs.org](https://gtfs.org/) may be helpful.

* **GTFS quality data, generally in `mart_gtfs_quality`**: This is data about the *quality* of the raw GTFS data described above: how well it conforms to the GTFS specification (which is assessed based on the outputs of the canonical GTFS validators for [schedule](https://github.com/MobilityData/gtfs-validator) and [realtime](https://github.com/MobilityData/gtfs-realtime-validator)) and how well it adheres to the [California Transit Data Guidelines](https://dot.ca.gov/cal-itp/california-transit-data-guidelines).

* **Transit Database data, generally in `mart_transit_database`**: This is data hand-collected by Cal-ITP about transit in California, including things like organizations (whether they are transit providers, vendors, or other participants in the transit ecosystem); transit services; GTFS datasets; contracts; components of a transit technology stack; etc. For additional documentation of the Transit Database data model, see the [Airtable Data Documentation](https://docs.google.com/document/d/1KvlYRYB8cnyTOkT1Q0BbBmdQNguK_AMzhSV5ELXiZR4/edit#heading=h.u7y2eosf0i1d) or the older [Transit Database docs](https://docs.calitp.org/data-infra/datasets_and_tables/transitdatabase.html).

* **Payments data, further docs to come after v2 migration**

## Naming and types of models

Data models (tables and views) are usually of one of the following types:

* **Dimensions:** These tables are prefixed with `dim_` and are ["typically likened to nouns"](https://docs.getdbt.com/terms/dimensional-modeling#dimensions), i.e., the entity associated with an event. Many of our dimension tables are [type-2 slowly changing dimensions](https://en.wikipedia.org/wiki/Slowly_changing_dimension#Type_2:_add_new_row) will have `_valid_from` and `_valid_to` columns that indicate the period of time that that version of a record was in effect.

* **Facts:** These tables are prefixed with `fct_` and ["typically refer to an action, event, or result of a business process"](https://docs.getdbt.com/terms/dimensional-modeling#facts), i.e., a thing that happened (or was scheduled to happen) at a specific time or at a specific temporal granularity.

* **Bridges:** Bridge tables are prefixed with `bridge_` and represent a mapping between two dimension tables where 1. The relationship itself is many to many and/or 2. Because both dimensions are versioned (slowly-changing), the relationship becomes many to many because of overlapping record versions. In case #2, bridge tables must be joined with reference to a specific date (so, you must select the relationship between Organization A and Service B *as of January 1, 2023*, because if you just look for the relationship between Organization A and Service B, you will get multiple rows representing the different iterations of that relationship over time.) These versioned bridge tables will have `_valid_from` and `_valid_to` dates like a dimension table.

## Joins and keys

Columns called `key` are unique*, synthetic (i.e., semantically meaningless hashes), non-null primary keys for the given table (*except, occasionally, in GTFS data where there are duplicates in the raw data, which we attempt to identify through warning columns). For versioned dimension tables, the `key` column will be a **versioned** primary key, and there may be an unversioned natural key from the source system also present on the table. Foreign keys will be prefixed with the entity name of the other table. `key` columns should generally only be used for joins or getting distinct counts of entities.

So, for example, the primary key for `mart_transit_database.dim_gtfs_datasets` is called `key`. The unversioned natural key is `source_record_id`, which is specific to and generated by the Transit Database source system. Then in the `mart_gtfs.fct_daily_scheduled_trips` table, the foreign key referencing `mart_transit_database.dim_gtfs_datasets.key` is called `gtfs_dataset_key`.

Similarly, the primary key for `mart_gtfs.dim_trips` is called `key`. The unversioned natural key is `trip_id`, which is assigned in the original GTFS feed (this means `trip_id` is only unique within a given feed, so within our warehouse you would only expect the `trip_id + feed_key` combination to be unique). Because some GTFS datasets erroneously contain duplicate `trip_id` values, there is an additional column called `warning_duplicate_primary_key`, which flag cases where `trip_id + feed_key` and thus the synthetic `key` column, are not unique.  Then in the `mart_gtfs.fct_daily_scheduled_trips` table, the foreign key referencing `mart_gtfs.dim_trips` is called `trip_key` and the `warning_duplicate_primary_key` column is also provided to flag the duplicates.

{% enddocs %}
