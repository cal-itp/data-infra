Documentation related to Littlepay data schema
In many cases, taken or adapted directly from Littlepay documentation: https://docs.littlepay.io/data/

-------------------------------- COMMON FIELDS INCLUDING KEYS --------------------------------

{% docs lp_micropayment_id %}
Uniquely identifies a micropayment.
When a foreign key, identifies the micropayment associated with this entity.
{% enddocs %}

{% docs lp_aggregation_id %}
Identifies an aggregation of one or more micropayments that can be authorised/settled.
{% enddocs %}

{% docs lp_participant_id %}
Littlepay identifier for the participant (transit agency) associated with this entity or event.
{% enddocs %}

{% docs lp_customer_id %}
Identifies the customer associated with this payment activity or entity.
A customer ID does not necessarily uniquely identify an individual person
or payment card.
These IDs can appear across `participant_id`s, so there may be cases where you need to use both `participant_id` and `customer_id` to join to the correct instance.
{% enddocs %}

{% docs lp_funding_source_vault_id %}
Identifies the funding source (for example, card) that a micropayment will be charged to. This is always the card that was tapped.
A registered customer can have multiple funding sources linked to them.
These IDs can appear across `participant_id`s, so there may be cases where you need to use both `participant_id` and `funding_source_vault_id` to join to the correct instance.
{% enddocs %}

{% docs lp_adjustment_id %}
Uniquely identifies the adjustment.
Adjustments are things like fare caps that adjust the amount of a micropayment.
Individual adjustments apply a specific product to an individual micropayment.
{% enddocs %}

{% docs lp_product_id %}
Uniquely identifies a product.
Products can adjust the amount of a fare micropayment.
For example, a 10 day fare cap could be a product.
{% enddocs %}

{% docs lp_littlepay_transaction_id %}
Unique tap ID generated by Littlepay upon receipt of a tap to the Device API.
{% enddocs %}


-------------------------------- AGGREGATIONS/SUMMARIES --------------------------------

{% docs lp_net_micropayment_amount_dollars %}
Sum of the `charge_amount` values for all micropayments in this aggregation.
If there are credit (pre-settlement refund) micropayments in the aggregation,
the value of those will have been subtracted from this total because they have
negative `charge_amount` values.
Post-settlement refunds will not be reflected since they are not recorded in the micropayments table.
{% enddocs %}

{% docs lp_total_nominal_amount_dollars %}
Sum of the `nominal_amount` (unadjusted) values for all micropayments in this aggregation.
This will not reflect pre-settlement refunds or micropayment adjustments.
{% enddocs %}

{% docs lp_mp_latest_transaction_time %}
Maximum (latest) transaction time for micropayments in this aggregation.
{% enddocs %}

{% docs lp_num_micropayments %}
Number of distinct micropayment ID values for micropayments in this aggregation.
{% enddocs %}

{% docs lp_contains_pre_settlement_refund %}
If "true", this aggregation contains a pre-settlement refund (i.e., contains a micropayment with `charge_type` "refund").
{% enddocs %}

{% docs lp_contains_variable_fare %}
If "true", this aggregation contains at least one micropayment with a variable fare charge type.
{% enddocs %}

{% docs lp_contains_flat_fare %}
If "true", this aggregation contains at least one micropayment with a `flat_fare` charge type.
{% enddocs %}

{% docs lp_contains_pending_charge %}
If "true", this aggregation contains at least one micropayment with a pending charge type.
{% enddocs %}

{% docs lp_contains_adjusted_micropayment %}
If "true", this aggregation contains at least one micropayment that had a micropayment adjustment applied. For example, micropayments that were reduced due to a fare cap being applied will have a "true" in this column.
{% enddocs %}

{% docs lp_settlement_contains_imputed_type %}
Some settlements are missing `settlement_type` (i.e., `DEBIT` vs. `CREDIT` designation).
We impute those missing values on the heuristic that first updates tend to be the debit
and any subsequent updates are credits (refunds).
Rows with "true" in this column indicate that at least one input row had its settlement type imputed.
These rows could potentially (though we believe it is unlikely) be sources of error if the imputation
assumptions were incorrect.
{% enddocs %}

{% docs lp_settlement_contains_refund %}
If `true`, this aggregation settlement included at least one row with settlement_type = `CREDIT`.
{% enddocs %}

{% docs lp_settlement_latest_update_timestamp %}
Most recent `record_updated_timestamp_utc` value for this aggregation settlement.
If a credit (refund) was issued after the initial debit, this will be the timestamp of the credit.
{% enddocs %}

{% docs lp_net_settled_amount_dollars %}
Net dollar amount of this aggregation settlement; if a refund (credit) has been issued,
that will be reflected. So for example if $20 was debited and then $8 was credited,
the value in this column will be `12` (= 20 - 8).
{% enddocs %}

{% docs lp_settlement_debit_amount %}
Total dollar amount associated with debit settlements in this aggregation.
Numbers in this column are positive because they represent amounts debited (charged) by the participant to the customer (rider);
i.e., these values represent income for the participant (agency).
{% enddocs %}

{% docs lp_settlement_credit_amount %}
Total dollar amount associated with credit (refund) settlements in this aggregation.
Numbers in this column are negative because they represent amounts credited (refunded) by the participant (agency) to the customer (rider);
i.e., these values represent costs for the participant (agency).
{% enddocs %}

{% docs lp_aggregation_is_settled %}
Boolean indicating whether all settlements in this aggregation have `settlement_status = SETTLED`.
`settlement_status` is only available for all agencies starting on November 28, 2023 so
this field does not account for activity before that date and aggregations that only contain activity before that date have nulls in this field. If `false`, there was a settlement present that has a `settlement_status` other than `SETTLED` (i.e., `PENDING`, `REJECTED`, or `FAILED`.)

When this column appears in models where not all aggregations have settlements at all, this field is also null for aggregations
that don't have any settlements. So, this field can be null if there are no settlements or if all settlement activity occurred before November 28, 2023.
{% enddocs %}

{% docs lp_debit_is_settled %}
Same as `aggregation_is_settled` but only includes the aggregation's debit (fare payment) settlements.
{% enddocs %}

{% docs lp_credit_is_settled %}
Same as `aggregation_is_settled` but only includes the aggregation's credit (refund) settlements.
If there is no credit activity for the aggregation, this field is null.
(So, a null in this field can mean either that there was no credit activity at all or that all credit
activity was prior to November 28, 2023.)
{% enddocs %}

{% docs lp_micropayment_refund_amount %}
Refunded amount for this specific micropayment.
Null if no refund for this micropayment.
{% enddocs %}

{% docs lp_aggregation_refund_amount %}
Total refunded amount associated with this aggregation.
(The aggregation may contain more than one micropayment.)
{% enddocs %}

-------------------------------- SETTLEMENTS TABLE --------------------------------

{% docs lp_settlement_id %}
A unique identifier for each settlement.
{% enddocs %}

{% docs lp_funding_source_id %}
Identifies the funding source (for example, card) that the micropayment will be charged to. This is always the card that was tapped.

A registered customer can have multiple funding sources linked to it. This field can be used to join to the `customer_funding_source` feed.
{% enddocs %}

{% docs lp_settlement_type %}
Type of settlement that occurred. Possible values are `DEBIT` or `CREDIT`.

If refunding a micropayment that has already been settled, the value will be `CREDIT`.
{% enddocs %}

{% docs lp_transaction_amount %}
The settlement amount.
{% enddocs %}

{% docs lp_retrieval_reference_number %}
Uniquely identifies a card transaction, based on the ISO 8583 standard.

If the acquirer is Elavon, this value will be split between `littlepay_reference_number` and `external_reference_number`.
{% enddocs %}

{% docs lp_littlepay_reference_number %}
Uniquely identifies a card transaction.

If the acquirer is Elavon, then this key will contain the first part of the string from `retrieval_reference_number`.
{% enddocs %}

{% docs lp_external_reference_number %}
Uniquely identifies a card transaction.

If the acquirer is Elavon, then this key will contain the second part of the string from `retrieval_reference_number`.
{% enddocs %}

{% docs lp_record_updated_timestamp_utc %}
Settlement last updated timestamp.
Formerly known as settlement_requested_date_time_utc.
{% enddocs %}

{% docs lp_acquirer %}
Identifies the acquirer used to settle the transaction.
{% enddocs %}

{% docs lp_acquirer_response_rrn %}
When returned by supported acquirers, uniquely identifies a card transaction as supplied by the acquirer in the settlement response, based on the ISO 8583 standard.

This field is supported for when the acquirer is Nets DK. When not supported or in use, this field will be empty.
{% enddocs %}

{% docs lp_settlement_status %}
The status of the settlement. Options are:
* `PENDING` - for settlements that have had a request but no response
* `REJECTED`
* `SETTLED`
* `FAILED` - an error occurred during processing
This field was not added for all agencies until late November 2023, so
this field will be missing (null) for most rows before then. 
{% enddocs %}

{% docs lp_request_created_timestamp_utc %}
Time settlement request was created.
{% enddocs %}

{% docs lp_response_created_timestamp_utc %}
Time settlement response was created.
{% enddocs %}

{% docs lp_refund_id %}
Populated if the settlement is a refund; can be used when linking to the refunds table.
{% enddocs %}

-------------------------------- MICROPAYMENTS TABLE --------------------------------

{% docs lp_transaction_time %}
The date and time when the micropayment was created.

For variable fare (tap on/tap off), the micropayment will not be created until the tap off occurs.

The date reflects the processing time by Littlepay, rather than the event time; that is, when the related taps occurred.
{% enddocs %}

{% docs lp_payment_liability %}
Indicates who would be liable to absorb the cost if the micropayment was declined by the issuer when an authorisation is attempted.

Possible values are `ISSUER` or `OPERATOR`.
{% enddocs %}

{% docs lp_charge_amount %}
The amount that will be credited to or debited from the funding source. This may be lower than the nominal amount if adjustments have been applied.
{% enddocs %}

{% docs lp_nominal_amount %}
The amount that would be charged if no adjustments were to be applied.
{% enddocs %}

{% docs lp_currency_code %}
ISO 4217 numeric code representing the currency that the `charge_amount` and `nominal_amount` are denominated in.
{% enddocs %}

{% docs lp_mp_type %}
Transaction type. Possible values are `CREDIT` or `DEBIT`. The value Will be `DEBIT` if `charge_amount >= 0.00`
{% enddocs %}

{% docs lp_charge_type %}
Indicates the type of fare that the micropayment charge represents.

Possible values:
* `RETAIL_FARE`
* `FLAT_FARE`
* `COMPLETE_VARIABLE_FARE`
* `INCOMPLETE_VARIABLE_FARE`
* `REFUND`
{% enddocs %}

-------------------------------- MICROPAYMENT ADJUSTMENTS TABLE --------------------------------

{% docs lp_adj_type %}
The type of product / rule that created the adjustment. Additional values may be added over time.

Possible values:
* `MULTI_DAY_CAP`
* `DAILY_CAP`
* `WEEKLY_CAP`
{% enddocs %}

{% docs lp_adj_time_period_type %}
Indicates whether the travel was determined to have occurred during a peak or off-peak period for the purposes of capping.

Possible values are `PEAK` and `OFFPEAK`.
{% enddocs %}

{% docs lp_adj_description %}
General description of the reason the adjustment was created.
{% enddocs %}

{% docs lp_adj_amount %}
The amount deducted from the `nominal_amount` to arrive at the `charge_amount` for the micropayment being adjusted.
{% enddocs %}

-------------------------------- PRODUCT DATA TABLE --------------------------------

{% docs lp_product_code %}
The code specified in the Merchant Portal against the product.
{% enddocs %}

{% docs lp_product_description %}
The description specified in the Merchant Portal during the product creation.
{% enddocs %}

{% docs lp_product_type %}
The name of the product type.

Possible values:
* `CAPPING`
* `DISCOUNT`
* `PURCHASE`
{% enddocs %}

-------------------------------- PAIRED DEVICE TRANSACTIONS TABLE --------------------------------

{% docs lp_paired_first_transaction_id %}
The littlepay_transaction_id of the first tap transaction
{% enddocs %}

{% docs lp_paired_transaction_route_id %}
The route_id of the first tap transaction with a non-empty route_id. 'Route Z' indicates route is unknown.
{% enddocs %}

{% docs lp_paired_first_direction %}
The direction of (the vehicle for) the first tap transaction
{% enddocs %}

{% docs lp_paired_first_vehicle_id %}
The vehicle_id of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_device_id %}
The device_id of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_transaction_type %}
The transaction_type of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_transaction_outcome %}
The transaction_outcome of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_transaction_date_time_utc %}
The transaction_date_time_utc of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_transaction_date_time_pacific %}
The transaction_date_time_pacific of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_location_id %}
The location_id of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_location_name %}
The location_name of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_latitude %}
The latitude of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_longitude %}
The longitude of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_geography %}
First tap transaction's latitude and longitude combined into a GEOGRAPHY data type.
{% enddocs %}

{% docs lp_paired_second_transaction_id %}
The littlepay_transaction_id of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_device_id %}
The device_id of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_transaction_type %}
The transaction_type of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_transaction_outcome %}
The transaction_outcome of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_transaction_date_time_utc %}
The transaction_date_time_utc of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_transaction_date_time_pacific %}
The transaction_date_time_pacific of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_location_id %}
The location_id of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_location_name %}
The location_name of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_latitude %}
The latitude of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_longitude %}
The longitude of the second tap transaction (if there is one)
{% enddocs %}

{% docs lp_paired_second_geography %}
Second tap transaction's latitude and longitude combined into a GEOGRAPHY data type (if second tap present and latitude and longitude are populated).
{% enddocs %}

{% docs lp_paired_duration %}
For variable fare journeys with two taps, the duration in minutes between the first (on) and second (off) taps.
{% enddocs %}

{% docs lp_paired_distance %}
For variable fare journeys with two taps where geography information is populated, the distance in meters between the first (on) and second (off) taps. This is a "shortest distance" calculation modeled on a perfect sphere using BigQuery's built-in [ST_DISTANCE function](https://cloud.google.com/bigquery/docs/reference/standard-sql/geography_functions#st_distance) and does not reflect the path that the vehicle actually followed.
{% enddocs %}

{% docs lp_paired_first_transaction_date %}
The date (Pacific Time) of the first tap transaction
{% enddocs %}

{% docs lp_paired_first_day_of_week %}
Pacific Time day of week value of the first tap transaction represented as an integer in the range [1,7] with `Sunday = 1`.
{% enddocs %}
