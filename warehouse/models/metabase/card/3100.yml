version: 2
exposures:
  - name: multi_day_cap_taps_by_rider
    label: Multi-Day Cap Taps by Rider
    description: "### Visualization: Table\n\nNo description provided in Metabase\n\
      \n#### Query\n\n```\nWith multi_cap_riders AS (\n  SELECT principal_customer_id\n\
      \        ,funding_source_vault_id\n        ,MAX(transaction_date_time_pacific)\
      \ AS multi_cap_end_date\n    FROM `cal-itp-data-infra.mart_payments.fct_payments_rides_v2`\
      \ AS payments_rides\n   WHERE participant_id = 'sbmtd'\n     AND adjustment_type\
      \ = 'MULTI_DAY_CAP'\n     AND 0 = (SELECT COUNT(1)\n                FROM `cal-itp-data-infra.mart_payments.fct_payments_rides_v2`\
      \ AS payments_rides_filter\n               WHERE payments_rides_filter.participant_id\
      \ = 'sbmtd'\n                 AND payments_rides_filter.adjustment_type = 'MULTI_DAY_CAP'\n\
      \                 AND payments_rides_filter.principal_customer_id = payments_rides.principal_customer_id\n\
      \                 AND payments_rides_filter.transaction_date_pacific BETWEEN\
      \ DATE_ADD(payments_rides.transaction_date_pacific, INTERVAL 1 DAY) AND DATE_ADD(payments_rides.transaction_date_pacific,\
      \ INTERVAL 10 DAY))\n   GROUP BY principal_customer_id\n           ,DATE_TRUNC(transaction_date_time_pacific,\
      \ DAY)\n           ,funding_source_vault_id\n), multi_cap_payments AS (\n  SELECT\
      \ multi_cap_riders.principal_customer_id\n        ,(CASE WHEN payments.adjustment_type\
      \ = 'MULTI_DAY_CAP' THEN NULL ELSE transaction_date_time_pacific END) AS start_date_pacific\n\
      \        ,multi_cap_riders.multi_cap_end_date\n        ,payments.funding_source_vault_id\n\
      \    FROM multi_cap_riders\n   INNER JOIN `cal-itp-data-infra.mart_payments.fct_payments_rides_v2`\
      \ AS payments \n      ON payments.principal_customer_id = multi_cap_riders.principal_customer_id\n\
      \     AND payments.funding_source_vault_id = multi_cap_riders.funding_source_vault_id\n\
      \     AND payments.transaction_date_time_pacific BETWEEN DATETIME_SUB(multi_cap_riders.multi_cap_end_date,\
      \ INTERVAL 30 DAY) AND multi_cap_riders.multi_cap_end_date\n     AND payments.participant_id\
      \ = 'sbmtd'\n   GROUP BY multi_cap_riders.principal_customer_id\n          \
      \ ,payments.transaction_date_time_pacific\n           ,multi_cap_riders.multi_cap_end_date\n\
      \           ,payments.funding_source_vault_id \n           ,payments.charge_amount\n\
      \           ,payments.adjustment_type\n   QUALIFY SUM(charge_amount) OVER (PARTITION\
      \ BY multi_cap_riders.principal_customer_id, multi_cap_riders.multi_cap_end_date\
      \ ORDER BY transaction_date_time_pacific DESC ROWS BETWEEN UNBOUNDED PRECEDING\
      \ AND CURRENT ROW) <= 52\n), multi_cap_ranges AS (\n  SELECT principal_customer_id\n\
      \        ,MIN(start_date_pacific) AS multi_cap_start_date\n        ,multi_cap_end_date\n\
      \        ,funding_source_vault_id \n  FROM multi_cap_payments\n  GROUP BY principal_customer_id,\
      \ multi_cap_end_date, funding_source_vault_id\n)\nSELECT multi_cap_ranges.principal_customer_id\n\
      \      ,multi_cap_ranges.multi_cap_start_date\n      ,multi_cap_ranges.multi_cap_end_date\n\
      \      ,payments_rides.transaction_date_time_pacific\n      ,payments_rides.charge_amount\n\
      \      ,payments_rides.nominal_amount\n      ,payments_rides.adjustment_type\n\
      \      ,payments_rides.funding_source_vault_id \n  FROM multi_cap_ranges\n INNER\
      \ JOIN `cal-itp-data-infra.mart_payments.fct_payments_rides_v2` AS payments_rides\n\
      \    ON payments_rides.principal_customer_id = multi_cap_ranges.principal_customer_id\n\
      \   AND payments_rides.funding_source_vault_id = multi_cap_ranges.funding_source_vault_id\n\
      \   AND payments_rides.transaction_date_time_pacific BETWEEN multi_cap_ranges.multi_cap_start_date\
      \ AND multi_cap_ranges.multi_cap_end_date\n   AND payments_rides.participant_id\
      \ = 'sbmtd'\n```\n\n#### Metadata\n\nMetabase ID: __3100__\n\nCreated On: __2024-09-12T18:53:28.52381Z__"
    type: analysis
    url: https://dashboards.calitp.org/card/3100
    maturity: medium
    owner:
      name: Erika Pacheco
      email: erika@ministryofvelocity.com
    depends_on: []
    config:
      meta:
        average_query_time: '0:01.954'
        last_used_at: '2025-07-21T23:49:22.213243Z'
