version: 2
exposures:
  - name: agencies____warnings_daily
    label: Agencies || Warnings Daily
    description: "### Visualization: Combo\n\nDaily counts for agencies with warnings,\
      \ both for the current day, as well as distinct agencies with warnings over\
      \ the past 30 days of a given date.\n\n#### Query\n\n```\nWITH \n    severity_daily\
      \ AS (\n        SELECT\n            metric_date,\n            COALESCE(severity,\
      \ 'UNKNOWN') AS severity,\n            calitp_itp_id,\n            n_notices\n\
      \        FROM views.validation_code_metrics\n        WHERE metric_date IS NOT\
      \ NULL AND metric_date >= '2021-04-15'\n        ORDER BY 1 DESC\n    ),\n  \
      \  dates AS (\n       SELECT date\n        FROM UNNEST(\n            GENERATE_DATE_ARRAY(DATE('2021-04-01'),\
      \ CURRENT_DATE(), INTERVAL 1 DAY)\n        ) as date\n    ),\n    daily_metrics\
      \ AS (\n        SELECT *\n        FROM (\n            SELECT\n             \
      \   date,\n                severity,\n                COUNT(DISTINCT date_calitp_id)\
      \ AS n_agencies,\n                COUNT(DISTINCT calitp_itp_id) AS n_agencies_30,\n\
      \                SUM(DISTINCT date_n_notices) AS n_notices\n            FROM\
      \ (\n                SELECT \n                    *,\n                    CASE\
      \ WHEN date = metric_date THEN calitp_itp_id END AS date_calitp_id,\n      \
      \              CASE WHEN date = metric_date THEN calitp_itp_id END AS date_n_notices\n\
      \                FROM dates\n                CROSS JOIN severity_daily\n   \
      \             WHERE date >= metric_date AND date < metric_date + 30\n      \
      \          ORDER BY date, metric_date\n            )\n            GROUP BY 1,\
      \ 2\n        )\n        WHERE date >= '2021-05-15'\n    )\nSELECT *\nFROM (\n\
      \    SELECT \n        date AS Date,\n        severity AS Severity,\n       \
      \ 'Agency Count (Past 30)' AS Metric,\n        n_agencies_30 AS Value\n    FROM\
      \ daily_metrics\n    WHERE Severity = 'WARNING'\n)\nUNION ALL\nSELECT *\nFROM\
      \ (\n    SELECT \n        date AS Date,\n        severity AS Severity,\n   \
      \     'Agency Count (Current Date)' AS Metric,\n        n_agencies AS Value\n\
      \    FROM daily_metrics\n    WHERE Severity = 'WARNING'\n)\n```\n\n#### Metadata\n\
      \nMetabase ID: __68__\n\nCreated On: __2021-08-17T13:06:31.257173Z__"
    type: analysis
    url: https://dashboards.calitp.org/card/68
    maturity: medium
    owner:
      name: Chris Cardillo
      email: chris.c@jarv.us
    depends_on: []
    config:
      meta:
        average_query_time: '0:00.918'
        last_used_at: '2024-09-20T17:54:54.131902Z'
