version: 2
exposures:
  - name: top_issuers_for_each_transit_agency___details
    label: Top issuers for each transit agency - details
    description: "### Visualization: Table\n\nNo description provided in Metabase\n\
      \n#### Query\n\n```\nWITH ranked_issuers AS (\r\n  SELECT\r\n    `mart_payments.fct_payments_rides_v2`.`participant_id`\
      \ AS `participant_id`,\r\n    `mart_payments.fct_payments_rides_v2`.`issuer`\
      \ AS `issuer`,\r\n    COUNT(*) AS `count`,\r\n    COUNT(*) * 100.0 / SUM(COUNT(*))\
      \ OVER (PARTITION BY `participant_id`) AS `percentage_of_total`,\r\n    ROW_NUMBER()\
      \ OVER (PARTITION BY `participant_id` ORDER BY COUNT(*) DESC) AS `rank`\r\n\
      \  FROM\r\n    `mart_payments.fct_payments_rides_v2`\r\n  WHERE\r\n    `mart_payments.fct_payments_rides_v2`.`transaction_date_pacific`\
      \ >= DATE '2023-01-01'\r\n  GROUP BY\r\n    `participant_id`,\r\n    `issuer`\r\
      \n),\r\nlabeled_issuers AS (\r\n  SELECT\r\n    `participant_id`,\r\n    CASE\r\
      \n      WHEN `rank` <= 10 THEN \r\n        CASE \r\n          WHEN `issuer`\
      \ IS NULL OR `issuer` = '' THEN '(empty)'\r\n          ELSE `issuer`\r\n   \
      \     END\r\n      ELSE 'Other'\r\n    END AS `issuer_label`,\r\n    `count`,\r\
      \n    `percentage_of_total`\r\n  FROM\r\n    ranked_issuers\r\n)\r\nSELECT\r\
      \n  `participant_id`,\r\n  `issuer_label`,\r\n  SUM(`count`) AS `total_count`,\r\
      \n  SUM(`percentage_of_total`) AS `total_percentage_of_total`\r\nFROM\r\n  labeled_issuers\r\
      \nGROUP BY\r\n  `participant_id`,\r\n  `issuer_label`\r\nORDER BY\r\n  `participant_id`,\
      \ `total_count` DESC;\r\n```\n\n#### Metadata\n\nMetabase ID: __3225__\n\nCreated\
      \ On: __2024-12-03T10:48:56.325399Z__"
    type: analysis
    url: https://dashboards.calitp.org/card/3225
    maturity: medium
    owner:
      name: Akos Matzon
      email: akos.matzon@rebelgroup.com
    depends_on: []
    config:
      meta:
        average_query_time: '0:00.986'
        last_used_at: '2025-07-09T23:59:42.373184Z'
