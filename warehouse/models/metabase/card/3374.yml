version: 2
exposures:
  - name: _filter_question__distinct_ca_agencies__ntd_id
    label: (Filter Question) Distinct CA Agencies, ntd_id
    description: "### Visualization: Table\n\nNo description provided in Metabase\n\
      \n#### Query\n\n```\nWITH all_annual_reporting_agencies AS (\n  -- Tables using\
      \ 'agency'\n  SELECT DISTINCT agency, state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_breakdowns`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_capital_expenses_by_capital_use`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_employees_by_mode_and_employee_type`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_fuel_and_energy` WHERE state\
      \ = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_funding_sources_by_expense_type`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_funding_sources_directly_generated`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_funding_sources_federal`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_funding_sources_local` WHERE\
      \ state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_funding_sources_state`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_funding_sources_taxes_levied_by_agency`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_maintenance_facilities`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_metrics` WHERE state = 'CA'\n\
      \  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_operating_expenses_by_function`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_operating_expenses_by_type`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, _5_digit_ntd_id\
      \ AS ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_service_by_mode_and_time_period`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_stations_and_facilities_by_agency_and_facility_type`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_track_and_roadway_by_mode`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_vehicles_age_distribution`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, state, ntd_id FROM\
      \ `cal-itp-data-infra.mart_ntd_annual_reporting.fct_vehicles_type_count_by_agency`\
      \ WHERE state = 'CA'\n  UNION ALL\n  SELECT DISTINCT agency, max_state, _5_digit_ntd_id\
      \ AS ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_service_by_agency`\
      \ WHERE max_state = 'CA'\n  UNION ALL\n  -- Tables using 'max_agency'\n  SELECT\
      \ DISTINCT max_agency as agency, max_state AS state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_breakdowns_by_agency`\
      \ WHERE max_state = 'CA'\n  UNION ALL\n  SELECT DISTINCT max_agency as agency,\
      \ max_state AS state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_capital_expenses_by_mode`\
      \ WHERE max_state = 'CA'\n  UNION ALL\n  SELECT DISTINCT max_agency as agency,\
      \ max_state AS state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_capital_expenses_for_existing_service`\
      \ WHERE max_state = 'CA'\n  UNION ALL\n  SELECT DISTINCT max_agency as agency,\
      \ max_state AS state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_capital_expenses_for_expansion_of_service`\
      \ WHERE max_state = 'CA'\n  UNION ALL\n  SELECT DISTINCT max_agency as agency,\
      \ max_state AS state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_fuel_and_energy_by_agency`\
      \ WHERE max_state = 'CA'\n  UNION ALL\n  SELECT DISTINCT max_agency as agency,\
      \ max_state AS state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_maintenance_facilities_by_agency`\
      \ WHERE max_state = 'CA'\n  UNION ALL\n  SELECT DISTINCT max_agency as agency,\
      \ max_state AS state, _5_digit_ntd_id AS ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_service_by_mode`\
      \ WHERE max_state = 'CA'\n  UNION ALL\n  SELECT DISTINCT max_agency as agency,\
      \ max_state AS state, ntd_id FROM `cal-itp-data-infra.mart_ntd_annual_reporting.fct_track_and_roadway_by_agency`\
      \ WHERE max_state = 'CA'\n),\nannual_reporting_distinct AS (\nSELECT\n    agency,\n\
      \    state,\n    ntd_id\nFROM all_annual_reporting_agencies\nWHERE ntd_id IS\
      \ NOT NULL\nGROUP BY agency, state, ntd_id\n), \n enrich_safety_security_with_state\
      \ AS (\n    select\n        sands.agency,\n        sands._5_digit_ntd_id AS\
      \ ntd_id,\n        ann.state\n    FROM `cal-itp-data-infra.mart_ntd_safety_and_security.fct_monthly_modal_time_series_safety_and_service`\
      \ AS sands\n    LEFT JOIN annual_reporting_distinct AS ann ON sands._5_digit_ntd_id\
      \ = ann.ntd_id\n),\nunion_annual_and_safety AS (\n  SELECT agency, ntd_id FROM\
      \ annual_reporting_distinct\n  UNION ALL\n  SELECT DISTINCT agency, ntd_id FROM\
      \ enrich_safety_security_with_state WHERE state = 'CA'\n)\nSELECT\n    agency,\
      \ \n    ntd_id\nFROM union_annual_and_safety\nWHERE ntd_id IS NOT NULL\nGROUP\
      \ BY agency, ntd_id\nORDER BY agency;\n```\n\n#### Metadata\n\nMetabase ID:\
      \ __3374__\n\nCreated On: __2025-02-03T23:07:42.836931Z__"
    type: analysis
    url: https://dashboards.calitp.org/card/3374
    maturity: medium
    owner:
      name: Charlie Costanzo
      email: charlie.c@jarv.us
    depends_on: []
    config:
      meta:
        average_query_time: '0:00.783'
        last_used_at: '2025-04-23T05:23:34.087689Z'
