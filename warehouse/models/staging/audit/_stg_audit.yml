version: 2

# note: much of these models are derived from blog posts
# https://towardsdatascience.com/bigquery-3-simple-ways-to-audit-and-monitor-your-dabatase-1cf09027f0de
# https://dataform.co/blog/exporting-bigquery-usage-logs
# https://towardsdatascience.com/monitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa

models:
  - name: stg_audit__cloudaudit_googleapis_com_activity
    description: |
      Does not exist yet.
      https://cloud.google.com/bigquery/docs/reference/auditlogs/#admin_activity_activity

  - name: stg_audit__cloudaudit_googleapis_com_data_access
    description: |
      Parsed/unnested record of all data access from a log sink. See
      https://cloud.google.com/bigquery/docs/reference/auditlogs/#data_access_data_access
      for more details.
    columns:
      - name: timestamp
        tests:
          - not_null
      - name: date
        tests:
          - not_null
      - name: severity
        tests:
          - not_null
      - name: resource_name
        tests:
          - not_null
      - name: principal_email
        tests:
          - not_null
      - name: job_name
        tests:
          - not_null
          - unique:
              # the only known dupe, with unclear origin
              where: job_name != 'projects/cal-itp-data-infra/jobs/job_whFNQ0oGxCM2ejXkfMAk5QA41Vcv'
      - name: job_type
        tests:
          - not_null
      - name: dbt_invocation_id
      - name: create_disposition
      - name: destination_table
      - name: priority
      - name: query
      - name: statement_type
      - name: write_disposition
      - name: duration_in_seconds
        tests:
          - not_null
      - name: referenced_tables
        tests:
          - not_null
      - name: total_billed_bytes
      - name: estimated_cost_usd
        tests:
          - not_null:
              where: duration_in_seconds > 0 and job_type != 'IMPORT' and statement_type != 'CREATE_EXTERNAL_TABLE'
      - name: total_slots_seconds
        tests:
          - not_null:
              where: duration_in_seconds > 0 and job_type != 'IMPORT' and statement_type != 'CREATE_EXTERNAL_TABLE'
      - name: table_data_read_job_name
      - name: dbt_header
      - name: dbt_node
      - name: payload
      - name: metadata
      - name: job
        tests:
          - not_null
