version: 2

models:
  - name: stg_gtfs_schedule__download_outcomes
    description: Outcomes from download attempts of GTFS schedule data.
    tests:
      - &schedule_outcome_uniqueness
        dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
    columns:
      - name: dt
      - name: name
      - name: url
      - name: feed_type
      - name: config_extracted_at
      - name: schedule_url_for_validation
      - name: download_success
      - name: download_exception
      - name: download_response_code
      - name: download_response_headers
      - name: base64_url
      - name: ts
  - name: stg_gtfs_schedule__unzip_outcomes
    description: Outcomes from unzip attempts on downloaded GTFS schedule data.
    tests:
      - *schedule_outcome_uniqueness
    columns:
      - name: dt
      - name: name
      - name: url
      - name: feed_type
      - name: config_extracted_at
      - name: unzip_success
      - name: unzip_exception
      - name: zipfile_extract_md5hash
        description: '{{ doc("column_zipfile_md5_hash") }}'
      - name: zipfile_files
        description: '{{ doc("column_zipfile_files") }}'
      - name: zipfile_dirs
        description: '{{ doc("column_zipfile_dirs") }}'
      - name: base64_url
      - name: ts
  - name: stg_gtfs_schedule__file_parse_outcomes
    description: Outcomes from parse (.txt --> .jsonl conversion) attempts on files within GTFS feeds.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - filename
  - name: stg_gtfs_rt__vehicle_positions
    description: |
      Vehicle positions realtime data.
      See https://gtfs.org/realtime/reference/ for specification.
    tests:
      # ideally base64_url, _extract_ts, id would be sufficient
      # but this is not the case in the MTC 511 feed, so adding position
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - _extract_ts
            - id
            - position_latitude
            - position_longitude
          # test hour = 0 UTC because that's 5pm Pacific = PM peak, good sample of data
          where: dt >= DATE_SUB(CURRENT_DATE(), INTERVAL 2 DAY) AND (EXTRACT(HOUR FROM _extract_ts)) = 0
    columns:
      - name: dt
      - name: hour
      - name: base64_url
      - name: _extract_ts
      - name: _config_extracted_at
      - name: _name
      - name: header_timestamp
      - name: header_incrementality
      - name: header_version
      - name: id
      - name: current_stop_sequence
      - name: stop_id
      - name: current_status
      - name: vehicle_timestamp
      - name: congestion_level
      - name: occupancy_status
      - name: occupancy_percentage
      - name: vehicle_id
      - name: vehicle_label
      - name: vehicle_license_plate
      - name: trip_id
      - name: trip_route_id
      - name: trip_direction_id
      - name: trip_start_time
      - name: trip_start_date
      - name: trip_schedule_relationship
      - name: latitude
      - name: longitude
      - name: bearing
      - name: odometer
      - name: speed
  - name: stg_gtfs_schedule__agency
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from an agency.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#agencytxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - agency_id
    columns:
      - name: base64_url
      - name: ts
      - name: agency_id
        description: '{{ doc("gtfs_agency__agency_id") }}'
      - name: agency_name
        description: '{{ doc("gtfs_agency__agency_name") }}'
        tests:
        - not_null
      - name: agency_url
        description: '{{ doc("gtfs_agency__agency_url") }}'
        tests:
        - not_null
      - name: agency_timezone
        description: '{{ doc("gtfs_agency__agency_timezone") }}'
        tests:
        - not_null
      - name: agency_lang
        description: '{{ doc("gtfs_agency__agency_lang") }}'
      - name: agency_phone
        description: '{{ doc("gtfs_agency__agency_phone") }}'
      - name: agency_fare_url
        description: '{{ doc("gtfs_agency__agency_fare_url") }}'
      - name: agency_email
        description: '{{ doc("gtfs_agency__agency_email") }}'
  - name: stg_gtfs_schedule__attributions
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from an attributions.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#attributionstxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - attribution_id
    columns:
      - name: base64_url
      - name: ts
      - name: attribution_id
        description: '{{ doc("gtfs_attributions__attribution_id") }}'
      - name: agency_id
        description: '{{ doc("gtfs_attributions__agency_id") }}'
      - name: route_id
        description: '{{ doc("gtfs_attributions__route_id") }}'
      - name: trip_id
        description: '{{ doc("gtfs_attributions__trip_id") }}'
      - name: organization_name
        description: '{{ doc("gtfs_attributions__organization_name") }}'
        tests:
        - not_null
      - name: is_producer
        description: '{{ doc("gtfs_attributions__is_producer") }}'
      - name: is_operator
        description: '{{ doc("gtfs_attributions__is_operator") }}'
      - name: is_authority
        description: '{{ doc("gtfs_attributions__is_authority") }}'
      - name: attribution_url
        description: '{{ doc("gtfs_attributions__attribution_url") }}'
      - name: attribution_email
        description: '{{ doc("gtfs_attributions__attribution_email") }}'
      - name: attribution_phone
        description: '{{ doc("gtfs_attributions__attribution_phone") }}'
  - name: stg_gtfs_schedule__fare_attributes
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a fare_attributes.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#fare_attributestxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - fare_id
    columns:
      - name: base64_url
      - name: ts
      - name: fare_id
        description: '{{ doc("gtfs_fare_attributes__fare_id") }}'
        tests:
        - not_null
      - name: price
        description: '{{ doc("gtfs_fare_attributes__price") }}'
        tests:
        - not_null
      - name: currency_type
        description: '{{ doc("gtfs_fare_attributes__currency_type") }}'
        tests:
        - not_null
      - name: payment_method
        description: '{{ doc("gtfs_fare_attributes__payment_method") }}'
        tests:
        - not_null
      - name: transfers
        description: '{{ doc("gtfs_fare_attributes__transfers") }}'
        tests:
        - not_null
      - name: agency_id
        description: '{{ doc("gtfs_fare_attributes__agency_id") }}'
      - name: transfer_duration
        description: '{{ doc("gtfs_fare_attributes__transfer_duration") }}'
  - name: stg_gtfs_schedule__fare_rules
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a fare_rules.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#fare_rulestxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - fare_id
            - route_id
            - origin_id
            - destination_id
            - contains_id
    columns:
      - name: base64_url
      - name: ts
      - name: fare_id
        description: '{{ doc("gtfs_fare_rules__fare_id") }}'
        tests:
        - not_null
      - name: route_id
        description: '{{ doc("gtfs_fare_rules__route_id") }}'
      - name: origin_id
        description: '{{ doc("gtfs_fare_rules__origin_id") }}'
      - name: destination_id
        description: '{{ doc("gtfs_fare_rules__destination_id") }}'
      - name: contains_id
        description: '{{ doc("gtfs_fare_rules__contains_id") }}'
  - name: stg_gtfs_schedule__feed_info
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a feed_info.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#feed_infotxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - feed_publisher_name
            - feed_publisher_url
            - feed_lang
            - default_lang
            - feed_version
            - feed_contact_email
            - feed_contact_url
            - feed_start_date
            - feed_end_date
    columns:
      - name: base64_url
      - name: ts
      - name: feed_publisher_name
        description: '{{ doc("gtfs_feed_info__feed_publisher_name") }}'
        tests:
        - not_null
      - name: feed_publisher_url
        description: '{{ doc("gtfs_feed_info__feed_publisher_url") }}'
        tests:
        - not_null
      - name: feed_lang
        description: '{{ doc("gtfs_feed_info__feed_lang") }}'
        tests:
        - not_null
      - name: default_lang
        description: '{{ doc("gtfs_feed_info__default_lang") }}'
      - name: feed_start_date
        description: '{{ doc("gtfs_feed_info__feed_start_date") }}'
      - name: feed_end_date
        description: '{{ doc("gtfs_feed_info__feed_end_date") }}'
      - name: feed_version
        description: '{{ doc("gtfs_feed_info__feed_version") }}'
      - name: feed_contact_email
        description: '{{ doc("gtfs_feed_info__feed_contact_email") }}'
      - name: feed_contact_url
        description: '{{ doc("gtfs_feed_info__feed_contact_url") }}'
  - name: stg_gtfs_schedule__frequencies
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a frequencies.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#frequenciestxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - trip_id
            - start_time
    columns:
      - name: base64_url
      - name: ts
      - name: trip_id
        description: '{{ doc("gtfs_frequencies__trip_id") }}'
        tests:
        - not_null
      - name: start_time
        description: '{{ doc("gtfs_frequencies__start_time") }}'
        tests:
        - not_null
      - name: end_time
        description: '{{ doc("gtfs_frequencies__end_time") }}'
        tests:
        - not_null
      - name: headway_secs
        description: '{{ doc("gtfs_frequencies__headway_secs") }}'
        tests:
        - not_null
      - name: exact_times
        description: '{{ doc("gtfs_frequencies__exact_times") }}'
  - name: stg_gtfs_schedule__levels
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a levels.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#levelstxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - level_id
    columns:
      - name: base64_url
      - name: ts
      - name: level_id
        description: '{{ doc("gtfs_levels__level_id") }}'
        tests:
        - not_null
      - name: level_index
        description: '{{ doc("gtfs_levels__level_index") }}'
        tests:
        - not_null
      - name: level_name
        description: '{{ doc("gtfs_levels__level_name") }}'
  - name: stg_gtfs_schedule__pathways
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a pathways.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#pathwaystxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - pathway_id
    columns:
      - name: base64_url
      - name: ts
      - name: pathway_id
        description: '{{ doc("gtfs_pathways__pathway_id") }}'
        tests:
        - not_null
      - name: from_stop_id
        description: '{{ doc("gtfs_pathways__from_stop_id") }}'
        tests:
        - not_null
      - name: to_stop_id
        description: '{{ doc("gtfs_pathways__to_stop_id") }}'
        tests:
        - not_null
      - name: pathway_mode
        description: '{{ doc("gtfs_pathways__pathway_mode") }}'
        tests:
        - not_null
      - name: is_bidirectional
        description: '{{ doc("gtfs_pathways__is_bidirectional") }}'
        tests:
        - not_null
      - name: length
        description: '{{ doc("gtfs_pathways__length") }}'
      - name: traversal_time
        description: '{{ doc("gtfs_pathways__traversal_time") }}'
      - name: stair_count
        description: '{{ doc("gtfs_pathways__stair_count") }}'
      - name: max_slope
        description: '{{ doc("gtfs_pathways__max_slope") }}'
      - name: min_width
        description: '{{ doc("gtfs_pathways__min_width") }}'
      - name: signposted_as
        description: '{{ doc("gtfs_pathways__signposted_as") }}'
      - name: reversed_signposted_as
        description: '{{ doc("gtfs_pathways__reversed_signposted_as") }}'
  - name: stg_gtfs_schedule__routes
    description: |
      Cleaned GTFS schedule route data.
      See https://gtfs.org/schedule/reference/#routestxt for specification.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - route_id
    columns:
      - name: base64_url
      - name: ts
      - name: route_id
        description: '{{ doc("gtfs_routes__route_id") }}'
        tests:
        - not_null
      - name: agency_id
        description: '{{ doc("gtfs_routes__agency_id") }}'
      - name: route_short_name
        description: '{{ doc("gtfs_routes__route_short_name") }}'
      - name: route_long_name
        description: '{{ doc("gtfs_routes__route_long_name") }}'
      - name: route_desc
        description: '{{ doc("gtfs_routes__route_desc") }}'
      - name: route_type
        description: '{{ doc("gtfs_routes__route_type") }}'
        tests:
        - not_null
      - name: route_url
        description: '{{ doc("gtfs_routes__route_url") }}'
      - name: route_color
        description: '{{ doc("gtfs_routes__route_color") }}'
      - name: route_text_color
        description: '{{ doc("gtfs_routes__route_text_color") }}'
      - name: route_sort_order
        description: '{{ doc("gtfs_routes__route_sort_order") }}'
      - name: continuous_pickup
        description: '{{ doc("gtfs_routes__continuous_pickup") }}'
      - name: continuous_drop_off
        description: '{{ doc("gtfs_routes__continuous_drop_off") }}'
  - name: stg_gtfs_schedule__shapes
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a shapes.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#shapestxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - shape_id
            - shape_pt_sequence
    columns:
      - name: base64_url
      - name: ts
      - name: shape_id
        description: '{{ doc("gtfs_shapes__shape_id") }}'
        tests:
        - not_null
      - name: shape_pt_lat
        description: '{{ doc("gtfs_shapes__shape_pt_lat") }}'
        tests:
        - not_null
        meta:
          metabase.semantic_type: type/Latitude
          ckan.type: FLOAT
          ckan.length: 6
          ckan.precision: 3
      - name: shape_pt_lon
        description: '{{ doc("gtfs_shapes__shape_pt_lon") }}'
        tests:
        - not_null
        meta:
          metabase.semantic_type: type/Longitude
          ckan.type: FLOAT
          ckan.length: 7
          ckan.precision: 3
      - name: shape_pt_sequence
        description: '{{ doc("gtfs_shapes__shape_pt_sequence") }}'
        tests:
        - not_null
      - name: shape_dist_traveled
        description: '{{ doc("gtfs_shapes__shape_dist_traveled") }}'
  - name: stg_gtfs_schedule__stops
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a stops.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#stopstxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - stop_id
    columns:
      - name: base64_url
      - name: ts
      - name: stop_id
        description: '{{ doc("gtfs_stops__stop_id") }}'
        tests:
        - not_null
      - name: stop_code
        description: '{{ doc("gtfs_stops__stop_code") }}'
      - name: stop_name
        description: '{{ doc("gtfs_stops__stop_name") }}'
      - name: tts_stop_name
        description: '{{ doc("gtfs_stops__tts_stop_name") }}'
      - name: stop_desc
        description: '{{ doc("gtfs_stops__stop_desc") }}'
      - name: stop_lat
        description: '{{ doc("gtfs_stops__stop_lat") }}'
        meta:
          metabase.semantic_type: type/Latitude
          ckan.type: FLOAT
          ckan.length: 6
          ckan.precision: 3
      - name: stop_lon
        description: '{{ doc("gtfs_stops__stop_lon") }}'
        meta:
          metabase.semantic_type: type/Longitude
          ckan.type: FLOAT
          ckan.length: 7
          ckan.precision: 3
      - name: zone_id
        description: '{{ doc("gtfs_stops__zone_id") }}'
      - name: stop_url
        description: '{{ doc("gtfs_stops__stop_url") }}'
      - name: location_type
        description: '{{ doc("gtfs_stops__location_type") }}'
      - name: parent_station
        description: '{{ doc("gtfs_stops__parent_station") }}'
      - name: stop_timezone
        description: '{{ doc("gtfs_stops__stop_timezone") }}'
      - name: wheelchair_boarding
        description: '{{ doc("gtfs_stops__wheelchair_boarding") }}'
      - name: level_id
        description: '{{ doc("gtfs_stops__level_id") }}'
      - name: platform_code
        description: '{{ doc("gtfs_stops__platform_code") }}'
  - name: stg_gtfs_schedule__transfers
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a transfers.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#transferstxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - from_stop_id
            - to_stop_id
            - from_trip_id
            - to_trip_id
            - from_route_id
            - to_route_id
    columns:
      - name: base64_url
      - name: ts
      - name: from_stop_id
        description: '{{ doc("gtfs_transfers__from_stop_id") }}'
        tests:
        - not_null
      - name: to_stop_id
        description: '{{ doc("gtfs_transfers__to_stop_id") }}'
        tests:
        - not_null
      - name: transfer_type
        description: '{{ doc("gtfs_transfers__transfer_type") }}'
        tests:
        - not_null
      - name: min_transfer_time
        description: '{{ doc("gtfs_transfers__min_transfer_time") }}'
      - name: from_route_id
      - name: to_route_id
      - name: from_trip_id
      - name: to_trip_id
  - name: stg_gtfs_schedule__translations
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a translations.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#translationstxt.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - table_name
            - field_name
            - language
            - record_id
            - record_sub_id
            - field_value
    columns:
      - name: base64_url
      - name: ts
      - name: table_name
        description: '{{ doc("gtfs_translations__table_name") }}'
        tests:
        - not_null
      - name: field_name
        description: '{{ doc("gtfs_translations__field_name") }}'
        tests:
        - not_null
      - name: language
        description: '{{ doc("gtfs_translations__language") }}'
        tests:
        - not_null
      - name: translation
        description: '{{ doc("gtfs_translations__translation") }}'
        tests:
        - not_null
      - name: record_id
        description: '{{ doc("gtfs_translations__record_id") }}'
      - name: record_sub_id
        description: '{{ doc("gtfs_translations__record_sub_id") }}'
      - name: field_value
        description: '{{ doc("gtfs_translations__field_value") }}'
  - name: stg_gtfs_schedule__trips
    description: |
      Cleaned GTFS schedule trip data.
      See https://gtfs.org/schedule/reference/#tripstxt for specification.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - ts
            - trip_id
          severity: warn
    columns:
      - name: base64_url
      - name: ts
      - name: route_id
        description: '{{ doc("gtfs_trips__route_id") }}'
        tests:
        - not_null
      - name: service_id
        description: '{{ doc("gtfs_trips__service_id") }}'
        tests:
        - not_null
      - name: trip_id
        description: '{{ doc("gtfs_trips__trip_id") }}'
        tests:
        - not_null
      - name: trip_headsign
        description: '{{ doc("gtfs_trips__trip_headsign") }}'
      - name: trip_short_name
        description: '{{ doc("gtfs_trips__trip_short_name") }}'
      - name: direction_id
        description: '{{ doc("gtfs_trips__direction_id") }}'
      - name: block_id
        description: '{{ doc("gtfs_trips__block_id") }}'
      - name: shape_id
        description: '{{ doc("gtfs_trips__shape_id") }}'
      - name: wheelchair_accessible
        description: '{{ doc("gtfs_trips__wheelchair_accessible") }}'
      - name: bikes_allowed
        description: '{{ doc("gtfs_trips__bikes_allowed") }}'
