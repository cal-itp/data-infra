WITH source AS (
    SELECT * FROM {{ source('external_enghouse', 'taps') }}
),

clean_columns AS (
    SELECT
        {{ trim_make_empty_string_null('tap_id') }} AS tap_id,
        {{ trim_make_empty_string_null('mapping_terminal_id') }} AS mapping_terminal_id,
        {{ trim_make_empty_string_null('mapping_merchant_id') }} AS mapping_merchant_id,
        {{ trim_make_empty_string_null('terminal') }} AS terminal,
        {{ trim_make_empty_string_null('token') }} AS token,
        {{ trim_make_empty_string_null('masked_pan') }} AS masked_pan,
        {{ safe_cast('expiry', type_int()) }} AS expiry,
        {{ safe_cast('server_date', type_timestamp()) }} AS server_date,
        {{ safe_cast('terminal_date', type_timestamp()) }} AS terminal_date,
        {{ safe_cast('tx_number', type_int()) }} AS tx_number,
        {{ trim_make_empty_string_null('tx_status') }} AS tx_status,
        {{ trim_make_empty_string_null('payment_reference') }} AS payment_reference,
        {{ safe_cast('Operator_Id', type_int()) }} AS Operator_Id,
        {{ safe_cast('terminal_spdh_code', type_int()) }} AS terminal_spdh_code,
        {{ trim_make_empty_string_null('denylist_version') }} AS denylist_version,
        {{ trim_make_empty_string_null('transit_data') }} AS transit_data,
        {{ trim_make_empty_string_null('currency') }} AS currency,
        {{ trim_make_empty_string_null('par') }} AS par,
        {{ trim_make_empty_string_null('Fare_Mode') }} AS Fare_Mode,
        {{ trim_make_empty_string_null('Fare_Type') }} AS Fare_Type,
        {{ safe_cast('Fare_Value', type_int()) }} AS Fare_Value,
        {{ trim_make_empty_string_null('Fare_Description') }} AS Fare_Description,
        {{ trim_make_empty_string_null('Fare_Linked_Id') }} AS Fare_Linked_Id,
        {{ trim_make_empty_string_null('ID') }} AS ID,
        {{ safe_cast('Gps_Latitude', type_numeric()) }} AS Gps_Latitude,
        {{ safe_cast('Gps_Altitude', type_numeric()) }} AS Gps_Altitude,
        {{ safe_cast('Vehicle_Public_Number', type_int()) }} AS Vehicle_Public_Number,
        {{ trim_make_empty_string_null('Vehicle_Name') }} AS Vehicle_Name,
        {{ safe_cast('Stop_Id', type_int()) }} AS Stop_Id,
        {{ trim_make_empty_string_null('Stop_Name') }} AS Stop_Name,
        {{ trim_make_empty_string_null('Platform_Id') }} AS Platform_Id,
        {{ trim_make_empty_string_null('Platform_Name') }} AS Platform_Name,
        {{ safe_cast('Zone_Id', type_int()) }} AS Zone_Id,
        {{ trim_make_empty_string_null('Zone_Name') }} AS Zone_Name,
        {{ safe_cast('Line_Public_Number', type_int()) }} AS Line_Public_Number,
        {{ trim_make_empty_string_null('Line_Name') }} AS Line_Name,
        {{ trim_make_empty_string_null('Line_Direction') }} AS Line_Direction,
        {{ trim_make_empty_string_null('Trip_Public_Number') }} AS Trip_Public_Number,
        {{ trim_make_empty_string_null('Trip_Name') }} AS Trip_Name,
        {{ trim_make_empty_string_null('Service_Public_Number') }} AS Service_Public_Number,
        {{ trim_make_empty_string_null('Service_Name') }} AS Service_Name,
        {{ trim_make_empty_string_null('Driver_ID') }} AS Driver_ID,

        -- CAST(_line_number AS INTEGER) AS _line_number,
        -- `instance`,
        -- extract_filename,
        -- revisit the use of this littlepay-specific macro
        -- {{ extract_littlepay_filename_ts() }} AS enghouse_export_ts,
        -- {{ extract_littlepay_filename_date() }} AS enghouse_export_date,
        -- ts,
        -- hash all content not generated by us to enable deduping full dup rows
        -- hashing at this step will preserve distinction between nulls and empty strings in case that is meaningful upstream
        -- {{ dbt_utils.generate_surrogate_key(['tap_id', 'mapping_terminal_id', 'mapping_merchant_id', 'terminal',
        --     'token', 'masked_pan', 'expiry', 'server_date', 'terminal_date', 'tx_number', 'tx_status',
        --     'payment_reference', 'terminal_spdh_code', 'denylist_version', 'transit_data',
        --     'currency', 'par']) }} AS _content_hash,
    FROM source
),

stg_enghouse__taps AS (
    SELECT
        tap_id,
        mapping_terminal_id,
        mapping_merchant_id,
        terminal,
        token,
        masked_pan,
        expiry,
        server_date,
        terminal_date,
        tx_number,
        tx_status,
        payment_reference,
        Operator_Id,
        terminal_spdh_code,
        denylist_version,
        transit_data,
        currency,
        par,
        Fare_Mode,
        Fare_Type,
        Fare_Value,
        Fare_Description,
        Fare_Linked_Id,
        ID,
        Gps_Latitude,
        Gps_Altitude,
        Vehicle_Public_Number,
        Vehicle_Name,
        Stop_Id,
        Stop_Name,
        Platform_Id,
        Platform_Name,
        Zone_Id,
        Zone_Name,
        Line_Public_Number,
        Line_Name,
        Line_Direction,
        Trip_Public_Number,
        Trip_Name,
        Service_Public_Number,
        Service_Name,
        Driver_ID,
        --  _line_number,
        -- `instance`,
        -- extract_filename,
        -- enghouse_export_ts,
        -- enghouse_export_date,
        -- ts,
        -- _key,
        -- _payments_key,
        -- _content_hash,
    FROM clean_columns
)

SELECT * FROM stg_enghouse__taps
