version: 2

models:
  - name: dim_agency_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from an agency.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#agencytxt.
    meta:
      ckan.authority: https://gtfs.org/schedule/reference/#agencytxt
    columns:
      - &schedule_dim_pk
        name: key
        description: |
          Synthetic primary key constructed from `feed_key` and `_line_number`.
        tests:
          - not_null
          - unique
        meta:
          publish.ignore: true
      - &schedule_dim_gtfs_key
        name: _gtfs_key
        description:
          Synthetic primary natural key constructed from the model's GTFS specification uniqueness.
        tests:
          - not_null
          - unique
        meta:
          publish.ignore: true
      - &schedule_dim_dt
        name: _dt
        tests:
          - not_null
        meta:
          publish.ignore: true
      - &schedule_dim_line_number
        name: _line_number
        tests:
          - not_null
        meta:
          publish.ignore: true
      - &feed_key
        name: feed_key
        description: |
          Foreign key to the `schedule_feeds` table.
        meta:
          publish.ignore: true
      - &base64_url
        name: base64_url
        description: |
          Base 64 encoded URL from which this data was scraped.
      - name: agency_id
        description: '{{ doc("gtfs_agency__agency_id") }}'
      - name: agency_name
        description: '{{ doc("gtfs_agency__agency_name") }}'
      - name: agency_url
        description: '{{ doc("gtfs_agency__agency_url") }}'
      - name: agency_timezone
        description: '{{ doc("gtfs_agency__agency_timezone") }}'
      - name: agency_lang
        description: '{{ doc("gtfs_agency__agency_lang") }}'
      - name: agency_phone
        description: '{{ doc("gtfs_agency__agency_phone") }}'
      - name: agency_fare_url
        description: '{{ doc("gtfs_agency__agency_fare_url") }}'
      - name: agency_email
        description: '{{ doc("gtfs_agency__agency_email") }}'
      - &_feed_valid_from
        name: _feed_valid_from
        meta:
          publish.ignore: true
      - &feed_timezone
        name: feed_timezone
        meta:
          publish.ignore: true

  - name: dim_areas_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from an areas.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/schedule/reference/#areastxt.
    meta:
      ckan.authority: https://gtfs.org/schedule/reference/#areastxt
    columns:
      - *schedule_dim_pk
      - *feed_key
      - *base64_url
      - name: area_id
        description: '{{ doc("gtfs_areas__area_id") }}'
      - name: area_name
        description: '{{ doc("gtfs_areas__area_name") }}'
      - *_feed_valid_from
      - *feed_timezone

  - name: dim_attributions_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from an attributions.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#attributionstxt.
    meta:
      ckan.authority: https://gtfs.org/schedule/reference/#attributionstxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: attribution_id
        description: '{{ doc("gtfs_attributions__attribution_id") }}'
      - name: agency_id
        description: '{{ doc("gtfs_attributions__agency_id") }}'
      - name: route_id
        description: '{{ doc("gtfs_attributions__route_id") }}'
      - name: trip_id
        description: '{{ doc("gtfs_attributions__trip_id") }}'
      - name: organization_name
        description: '{{ doc("gtfs_attributions__organization_name") }}'
      - name: is_producer
        description: '{{ doc("gtfs_attributions__is_producer") }}'
      - name: is_operator
        description: '{{ doc("gtfs_attributions__is_operator") }}'
      - name: is_authority
        description: '{{ doc("gtfs_attributions__is_authority") }}'
      - name: attribution_url
        description: '{{ doc("gtfs_attributions__attribution_url") }}'
      - name: attribution_email
        description: '{{ doc("gtfs_attributions__attribution_email") }}'
      - name: attribution_phone
        description: '{{ doc("gtfs_attributions__attribution_phone") }}'
      - *feed_timezone
      - &warning_duplicate_gtfs_key
        name: warning_duplicate_gtfs_key
        description: |
          Rows with `true` in this column have a duplicate primary key; i.e., the attribute(s) that is meant to
          uniquely identify a row are duplicated within an individual feed instance and `key` will
          also be duplicated as a result. Treat these rows with caution. They will cause fanout in joins.
        meta:
          publish.ignore: true
  - name: dim_calendar_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a calendar.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#calendartxt.
    meta:
      ckan.authority: https://gtfs.org/schedule/reference/#calendartxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: service_id
        description: '{{ doc("gtfs_calendar__service_id") }}'
      - name: monday
        description: '{{ doc("gtfs_calendar__monday") }}'
      - name: tuesday
        description: '{{ doc("gtfs_calendar__tuesday") }}'
      - name: wednesday
        description: '{{ doc("gtfs_calendar__wednesday") }}'
      - name: thursday
        description: '{{ doc("gtfs_calendar__thursday") }}'
      - name: friday
        description: '{{ doc("gtfs_calendar__friday") }}'
      - name: saturday
        description: '{{ doc("gtfs_calendar__saturday") }}'
      - name: sunday
        description: '{{ doc("gtfs_calendar__sunday") }}'
      - name: start_date
        description: '{{ doc("gtfs_calendar__start_date") }}'
      - name: end_date
        description: '{{ doc("gtfs_calendar__end_date") }}'
      - *feed_timezone

  - name: dim_calendar_dates_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a calendar_dates.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#calendar_datestxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#calendar_datestxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: service_id
        description: '{{ doc("gtfs_calendar_dates__service_id") }}'
      - name: date
        description: '{{ doc("gtfs_calendar_dates__date") }}'
      - name: exception_type
        description: '{{ doc("gtfs_calendar_dates__exception_type") }}'
      - *feed_timezone

  - name: dim_fare_attributes_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a fare_attributes.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#fare_attributestxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#fare_attributestxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: fare_id
        description: '{{ doc("gtfs_fare_attributes__fare_id") }}'
      - name: price
        description: '{{ doc("gtfs_fare_attributes__price") }}'
      - name: currency_type
        description: '{{ doc("gtfs_fare_attributes__currency_type") }}'
      - name: payment_method
        description: '{{ doc("gtfs_fare_attributes__payment_method") }}'
      - name: transfers
        description: '{{ doc("gtfs_fare_attributes__transfers") }}'
      - name: agency_id
        description: '{{ doc("gtfs_fare_attributes__agency_id") }}'
      - name: transfer_duration
        description: '{{ doc("gtfs_fare_attributes__transfer_duration") }}'
        meta:
          ckan.units: SECONDS
      - *feed_timezone

  - name: dim_fare_leg_rules_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a fare_leg_rules.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/schedule/reference/#fare_leg_rulestxt.
    meta:
      ckan.authority: https://gtfs.org/schedule/reference/#fare_leg_rulestxt
    columns:
      - *schedule_dim_pk
      - *feed_key
      - *base64_url
      - name: leg_group_id
        description: '{{ doc("gtfs_fare_leg_rules__leg_group_id") }}'
      - name: network_id
        description: '{{ doc("gtfs_fare_leg_rules__network_id") }}'
      - name: from_area_id
        description: '{{ doc("gtfs_fare_leg_rules__from_area_id") }}'
      - name: to_area_id
        description: '{{ doc("gtfs_fare_leg_rules__to_area_id") }}'
      - name: fare_product_id
        description: '{{ doc("gtfs_fare_leg_rules__fare_product_id") }}'
      - *_feed_valid_from
      - *feed_timezone

  - name: dim_fare_media_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a fare_media.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/schedule/reference/#fare_mediatxt.
    meta:
      ckan.authority: https://gtfs.org/schedule/reference/#fare_mediatxt
    columns:
      - *schedule_dim_pk
      - *feed_key
      - *base64_url
      - name: fare_media_id
        description: '{{ doc("gtfs_fare_media__fare_media_id") }}'
      - name: fare_media_name
        description: '{{ doc("gtfs_fare_media__fare_media_name") }}'
      - name: fare_media_type
        description: '{{ doc("gtfs_fare_media__fare_media_type") }}'
      - *_feed_valid_from
      - *feed_timezone

  - name: dim_fare_products_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a fare_products.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/schedule/reference/#fare_productstxt.
    meta:
      ckan.authority: https://gtfs.org/schedule/reference/#fare_productstxt
    columns:
      - *schedule_dim_pk
      - *feed_key
      - *base64_url
      - name: fare_product_id
        description: '{{ doc("gtfs_fare_products__fare_product_id") }}'
      - name: fare_product_name
        description: '{{ doc("gtfs_fare_products__fare_product_name") }}'
      - name: fare_media_id
        description: '{{ doc("gtfs_fare_products__fare_media_id") }}'
      - name: amount
        description: '{{ doc("gtfs_fare_products__amount") }}'
      - name: currency
        description: '{{ doc("gtfs_fare_products__currency") }}'
      - *_feed_valid_from
      - *feed_timezone

  - name: dim_fare_rules_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a fare_rules.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#fare_rulestxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#fare_rulestxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: fare_id
        description: '{{ doc("gtfs_fare_rules__fare_id") }}'
      - name: route_id
        description: '{{ doc("gtfs_fare_rules__route_id") }}'
      - name: origin_id
        description: '{{ doc("gtfs_fare_rules__origin_id") }}'
      - name: destination_id
        description: '{{ doc("gtfs_fare_rules__destination_id") }}'
      - name: contains_id
        description: '{{ doc("gtfs_fare_rules__contains_id") }}'
      - *feed_timezone
      - *warning_duplicate_gtfs_key

  - name: dim_fare_transfer_rules_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a fare_transfer_rules.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/schedule/reference/#fare_transfer_rulestxt.
    meta:
      ckan.authority: https://gtfs.org/schedule/reference/#fare_transfer_rulestxt
    columns:
      - *schedule_dim_pk
      - *feed_key
      - *base64_url
      - name: from_leg_group_id
        description: '{{ doc("gtfs_fare_transfer_rules__from_leg_group_id") }}'
      - name: to_leg_group_id
        description: '{{ doc("gtfs_fare_transfer_rules__to_leg_group_id") }}'
      - name: transfer_count
        description: '{{ doc("gtfs_fare_transfer_rules__transfer_count") }}'
      - name: duration_limit
        description: '{{ doc("gtfs_fare_transfer_rules__duration_limit") }}'
      - name: duration_limit_type
        description: '{{ doc("gtfs_fare_transfer_rules__duration_limit_type") }}'
      - name: fare_transfer_type
        description: '{{ doc("gtfs_fare_transfer_rules__fare_transfer_type") }}'
      - name: fare_product_id
        description: '{{ doc("gtfs_fare_transfer_rules__fare_product_id") }}'
      - *_feed_valid_from
      - *feed_timezone

  - name: dim_feed_info_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a feed_info.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#feed_infotxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#feed_infotxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: feed_publisher_name
        description: '{{ doc("gtfs_feed_info__feed_publisher_name") }}'
      - name: feed_publisher_url
        description: '{{ doc("gtfs_feed_info__feed_publisher_url") }}'
      - name: feed_lang
        description: '{{ doc("gtfs_feed_info__feed_lang") }}'
      - name: default_lang
        description: '{{ doc("gtfs_feed_info__default_lang") }}'
      - name: feed_start_date
        description: '{{ doc("gtfs_feed_info__feed_start_date") }}'
      - name: feed_end_date
        description: '{{ doc("gtfs_feed_info__feed_end_date") }}'
      - name: feed_version
        description: '{{ doc("gtfs_feed_info__feed_version") }}'
      - name: feed_contact_email
        description: '{{ doc("gtfs_feed_info__feed_contact_email") }}'
      - name: feed_contact_url
        description: '{{ doc("gtfs_feed_info__feed_contact_url") }}'
      - *feed_timezone
      - *warning_duplicate_gtfs_key

  - name: dim_frequencies_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a frequencies.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#frequenciestxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#frequenciestxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: trip_id
        description: '{{ doc("gtfs_frequencies__trip_id") }}'
      - name: start_time
        description: '{{ doc("gtfs_frequencies__start_time") }}'
      - name: end_time
        description: '{{ doc("gtfs_frequencies__end_time") }}'
      - name: headway_secs
        description: '{{ doc("gtfs_frequencies__headway_secs") }}'
        meta:
          ckan.units: SECONDS
      - name: exact_times
        description: '{{ doc("gtfs_frequencies__exact_times") }}'
      - *feed_timezone
      - name: start_time_interval
        meta:
          publish.ignore: true
      - name: end_time_interval
        meta:
          publish.ignore: true
      - name: start_time_sec
        meta:
          publish.ignore: true
      - name: end_time_sec
        meta:
          publish.ignore: true

  - name: dim_levels_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a levels.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#levelstxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#levelstxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: level_id
        description: '{{ doc("gtfs_levels__level_id") }}'
      - name: level_index
        description: '{{ doc("gtfs_levels__level_index") }}'
      - name: level_name
        description: '{{ doc("gtfs_levels__level_name") }}'
      - *feed_timezone

  - name: dim_pathways_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a pathways.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#pathwaystxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#pathwaystxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: pathway_id
        description: '{{ doc("gtfs_pathways__pathway_id") }}'
      - name: from_stop_id
        description: '{{ doc("gtfs_pathways__from_stop_id") }}'
      - name: to_stop_id
        description: '{{ doc("gtfs_pathways__to_stop_id") }}'
      - name: pathway_mode
        description: '{{ doc("gtfs_pathways__pathway_mode") }}'
      - name: is_bidirectional
        description: '{{ doc("gtfs_pathways__is_bidirectional") }}'
      - name: length
        description: '{{ doc("gtfs_pathways__length") }}'
        meta:
          ckan.units: METERS
      - name: traversal_time
        description: '{{ doc("gtfs_pathways__traversal_time") }}'
        meta:
          ckan.units: SECONDS
      - name: stair_count
        description: '{{ doc("gtfs_pathways__stair_count") }}'
      - name: max_slope
        description: '{{ doc("gtfs_pathways__max_slope") }}'
      - name: min_width
        description: '{{ doc("gtfs_pathways__min_width") }}'
        meta:
          ckan.units: METERS
      - name: signposted_as
        description: '{{ doc("gtfs_pathways__signposted_as") }}'
      - name: reversed_signposted_as
        description: '{{ doc("gtfs_pathways__reversed_signposted_as") }}'
      - *feed_timezone

  - name: dim_routes_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a routes.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#routestxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#routestxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: route_id
        description: '{{ doc("gtfs_routes__route_id") }}'
      - name: agency_id
        description: '{{ doc("gtfs_routes__agency_id") }}'
      - name: route_short_name
        description: '{{ doc("gtfs_routes__route_short_name") }}'
      - name: route_long_name
        description: '{{ doc("gtfs_routes__route_long_name") }}'
      - name: route_desc
        description: '{{ doc("gtfs_routes__route_desc") }}'
      - name: route_type
        description: '{{ doc("gtfs_routes__route_type") }}'
      - name: route_url
        description: '{{ doc("gtfs_routes__route_url") }}'
      - name: route_color
        description: '{{ doc("gtfs_routes__route_color") }}'
      - name: route_text_color
        description: '{{ doc("gtfs_routes__route_text_color") }}'
      - name: route_sort_order
        description: '{{ doc("gtfs_routes__route_sort_order") }}'
      - name: continuous_pickup
        description: '{{ doc("gtfs_routes__continuous_pickup") }}'
      - name: continuous_drop_off
        description: '{{ doc("gtfs_routes__continuous_drop_off") }}'
      - name: network_id
        description: '{{ doc("gtfs_routes__network_id") }}'
      - *feed_timezone

  - name: dim_shapes_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a shapes.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#shapestxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#shapestxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: shape_id
        description: '{{ doc("gtfs_shapes__shape_id") }}'
      - name: shape_pt_lat
        description: '{{ doc("gtfs_shapes__shape_pt_lat") }}'
        meta:
          metabase.semantic_type: type/Latitude
          ckan.type: FLOAT
          ckan.length: 6
          ckan.precision: 3
      - name: shape_pt_lon
        description: '{{ doc("gtfs_shapes__shape_pt_lon") }}'
        meta:
          metabase.semantic_type: type/Longitude
          ckan.type: FLOAT
          ckan.length: 7
          ckan.precision: 3
      - name: shape_pt_sequence
        description: '{{ doc("gtfs_shapes__shape_pt_sequence") }}'
      - name: shape_dist_traveled
        description: '{{ doc("gtfs_shapes__shape_dist_traveled") }}'
      - *feed_timezone

  - name: dim_stop_areas_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a stop_areas.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/schedule/reference/#stop_areastxt.
    meta:
      ckan.authority: https://gtfs.org/schedule/reference/#stop_areastxt
    columns:
      - *schedule_dim_pk
      - *feed_key
      - *base64_url
      - name: area_id
        description: '{{ doc("gtfs_stop_areas__area_id") }}'
      - name: stop_id
        description: '{{ doc("gtfs_stop_areas__stop_id") }}'
      - *_feed_valid_from
      - *feed_timezone

  - name: dim_stop_times_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a stop_times.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#stop_timestxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#stop_timestxt
      publish.gis_coordinate_system_epsg: WGS84
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: trip_id
        description: '{{ doc("gtfs_stop_times__trip_id") }}'
      - name: arrival_time
        description: '{{ doc("gtfs_stop_times__arrival_time") }}'
      - name: departure_time
        description: '{{ doc("gtfs_stop_times__departure_time") }}'
      - name: stop_id
        description: '{{ doc("gtfs_stop_times__stop_id") }}'
      - name: stop_sequence
        description: '{{ doc("gtfs_stop_times__stop_sequence") }}'
      - name: stop_headsign
        description: '{{ doc("gtfs_stop_times__stop_headsign") }}'
      - name: pickup_type
        description: '{{ doc("gtfs_stop_times__pickup_type") }}'
      - name: drop_off_type
        description: '{{ doc("gtfs_stop_times__drop_off_type") }}'
      - name: continuous_pickup
        description: '{{ doc("gtfs_stop_times__continuous_pickup") }}'
      - name: continuous_drop_off
        description: '{{ doc("gtfs_stop_times__continuous_drop_off") }}'
      - name: shape_dist_traveled
        description: '{{ doc("gtfs_stop_times__shape_dist_traveled") }}'
      - name: timepoint
        description: '{{ doc("gtfs_stop_times__timepoint") }}'
      - *warning_duplicate_gtfs_key
      - name: warning_missing_foreign_key_stop_id
        description: |
          Rows with `true` in this column are missing the required `stop_id` value.
          This means they will fail to join with `stop` related information.
        meta:
          publish.ignore: true
      - name: arrival_sec
        description: |
          This is a calculated field that does not come from GTFS - it is not a timestamp and can't be treated as such.

          Represents `arrival_time` as a total number of seconds after midnight of the first day of the given trip.
          For example, `arrival_time = 21:30:45` would lead to `arrival_sec = 21 * 3,600 + 30 * 60 + 45 * 1 = 77,445`.
          This allows us to perform duration calculations and handle timestamps that wrap past midnight like
          `25:40:00`, which are allowed in GTFS.
        meta:
          ckan.units: SECONDS
      - name: departure_sec
        description: |
          This is a calculated field that does not come from GTFS - it is not a timestamp and can't be treated as such.

          Represents `departure_time` as a total number of seconds after midnight of the first day of the given trip.
          For example, `departure_time = 21:30:45` would lead to `departure_sec = 21 * 3,600 + 30 * 60 + 45 * 1 = 77,445`.
          This allows us to perform duration calculations and handle timestamps that wrap past midnight like
          `25:40:00`, which are allowed in GTFS.
        meta:
          ckan.units: SECONDS
      - *feed_timezone
      - name: arrival_time_interval
        meta:
          publish.ignore: true
      - name: departure_time_interval
        meta:
          publish.ignore: true
      - name: start_pickup_drop_off_window
        description: '{{ doc("gtfs_stop_times__start_pickup_drop_off_window") }}'
      - name: end_pickup_drop_off_window
        description: '{{ doc("gtfs_stop_times__end_pickup_drop_off_window") }}'
      - name: mean_duration_factor
        description: '{{ doc("gtfs_stop_times__mean_duration_factor") }}'
      - name: mean_duration_offset
        description: '{{ doc("gtfs_stop_times__mean_duration_offset") }}'
      - name: safe_duration_factor
        description: '{{ doc("gtfs_stop_times__safe_duration_factor") }}'
      - name: safe_duration_offset
        description: '{{ doc("gtfs_stop_times__safe_duration_offset") }}'
      - name: pickup_booking_rule_id
        description: '{{ doc("gtfs_stop_times__pickup_booking_rule_id") }}'
      - name: drop_off_booking_rule_id
        description: '{{ doc("gtfs_stop_times__drop_off_booking_rule_id") }}'
      - name: start_pickup_drop_off_window_sec
        description: |
          This is a calculated field that does not appear directly in GTFS - it is not a timestamp and can't be treated as such.

          Represents `start_pickup_drop_off_window` as a total number of seconds after twelve hours before noon (usually midnight) on the first day of the given trip.
          For example, `start_pickup_drop_off_window = 21:30:45` would lead to `start_pickup_drop_off_window_sec = 21 * 3,600 + 30 * 60 + 45 * 1 = 77,445`.
          This allows us to perform duration calculations and handle timestamps that wrap past midnight like
          `25:40:00`, which are allowed in GTFS.

          See: https://gtfs.org/schedule/reference/#field-types for how GTFS defines its "Time" type.
        meta:
          publish.ignore: true
      - name: end_pickup_drop_off_window_sec
        description: |
          This is a calculated field that does not appear directly in GTFS - it is not a timestamp and can't be treated as such.

          Represents `end_pickup_drop_off_window` as a total number of seconds after twelve hours before noon (usually midnight) on the first day of the given trip.
          For example, `end_pickup_drop_off_window = 21:30:45` would lead to `end_pickup_drop_off_window_sec = 21 * 3,600 + 30 * 60 + 45 * 1 = 77,445`.
          This allows us to perform duration calculations and handle timestamps that wrap past midnight like
          `25:40:00`, which are allowed in GTFS.

          See: https://gtfs.org/schedule/reference/#field-types for how GTFS defines its "Time" type.
        meta:
          publish.ignore: true
      - name: start_pickup_drop_off_window_interval
        description: |
          This is a calculated field that does not appear directly in GTFS. It converts `start_pickup_drop_off_window`
          to a BigQuery INTERVAL type, which allows us to treat the field as a duration after twelve hours before noon (usually midnight)
          and thus handle times past the following midnight (like `25:40:00`).

          See: https://gtfs.org/schedule/reference/#field-types for how GTFS defines its "Time" type.
        meta:
          publish.ignore: true
      - name: end_pickup_drop_off_window_interval
        description: |
          This is a calculated field that does not appear directly in GTFS. It converts `end_pickup_drop_off_window`
          to a BigQuery INTERVAL type, which allows us to treat the field as a duration after twelve hours before noon (usually midnight)
          and thus handle times past the following midnight (like `25:40:00`).

          See: https://gtfs.org/schedule/reference/#field-types for how GTFS defines its "Time" type.
        meta:
          publish.ignore: true

  - name: dim_stops_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a stops.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#stopstxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#stopstxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: stop_id
        description: '{{ doc("gtfs_stops__stop_id") }}'
      - name: stop_code
        description: '{{ doc("gtfs_stops__stop_code") }}'
      - name: stop_name
        description: '{{ doc("gtfs_stops__stop_name") }}'
      - name: tts_stop_name
        description: '{{ doc("gtfs_stops__tts_stop_name") }}'
      - name: stop_desc
        description: '{{ doc("gtfs_stops__stop_desc") }}'
      - name: stop_lat
        description: '{{ doc("gtfs_stops__stop_lat") }}'
        meta:
          metabase.semantic_type: type/Latitude
          ckan.type: FLOAT
          ckan.length: 6
          ckan.precision: 3
      - name: stop_lon
        description: '{{ doc("gtfs_stops__stop_lon") }}'
        meta:
          metabase.semantic_type: type/Longitude
          ckan.type: FLOAT
          ckan.length: 7
          ckan.precision: 3
      - name: zone_id
        description: '{{ doc("gtfs_stops__zone_id") }}'
      - name: stop_url
        description: '{{ doc("gtfs_stops__stop_url") }}'
      - name: location_type
        description: '{{ doc("gtfs_stops__location_type") }}'
      - name: parent_station
        description: '{{ doc("gtfs_stops__parent_station") }}'
      - name: stop_timezone
        description: '{{ doc("gtfs_stops__stop_timezone") }}'
      - name: wheelchair_boarding
        description: '{{ doc("gtfs_stops__wheelchair_boarding") }}'
      - name: level_id
        description: '{{ doc("gtfs_stops__level_id") }}'
      - name: platform_code
        description: '{{ doc("gtfs_stops__platform_code") }}'
      - *feed_timezone
        # TODO: would be good to actually publish this, with appropriate documentation, next time we are ready to make a round of updates
      - name: warning_missing_schedule_dim_pk
        meta:
          publish.ignore: true
      - name: stop_timezone_coalesced
        meta:
          publish.ignore: true
      - *warning_duplicate_gtfs_key

  - name: dim_transfers_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a transfers.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#transferstxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#transferstxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: from_stop_id
        description: '{{ doc("gtfs_transfers__from_stop_id") }}'
      - name: to_stop_id
        description: '{{ doc("gtfs_transfers__to_stop_id") }}'
      - name: transfer_type
        description: '{{ doc("gtfs_transfers__transfer_type") }}'
      - name: min_transfer_time
        description: '{{ doc("gtfs_transfers__min_transfer_time") }}'
        meta:
          ckan.units: SECONDS
      - name: from_route_id
        description: '{{ doc("gtfs_transfers__from_route_id") }}'
      - name: to_route_id
        description: '{{ doc("gtfs_transfers__to_route_id") }}'
      - name: from_trip_id
        description: '{{ doc("gtfs_transfers__from_trip_id") }}'
      - name: to_trip_id
        description: '{{ doc("gtfs_transfers__to_trip_id") }}'
      - *feed_timezone
      - *warning_duplicate_gtfs_key

  - name: dim_translations_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a translations.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#translationstxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#translationstxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: table_name
        description: '{{ doc("gtfs_translations__table_name") }}'
      - name: field_name
        description: '{{ doc("gtfs_translations__field_name") }}'
      - name: language
        description: '{{ doc("gtfs_translations__language") }}'
      - name: translation
        description: '{{ doc("gtfs_translations__translation") }}'
      - name: record_id
        description: '{{ doc("gtfs_translations__record_id") }}'
      - name: record_sub_id
        description: '{{ doc("gtfs_translations__record_sub_id") }}'
      - name: field_value
        description: '{{ doc("gtfs_translations__field_value") }}'
      - *feed_timezone

  - name: dim_trips_latest
    description: |
      This table is a latest-only cut of the cleaned GTFS data.
      It contains current-only data for agencies we are currently scraping.
      Each row is a cleaned row from a trips.txt file.
      Definitions for the original GTFS fields are available at:
      https://gtfs.org/reference/static#tripstxt.
    meta:
      ckan.authority: https://gtfs.org/reference/static#tripstxt
    columns:
      - *schedule_dim_pk
      - *schedule_dim_gtfs_key
      - *schedule_dim_dt
      - *schedule_dim_line_number
      - *feed_key
      - *base64_url
      - name: route_id
        description: '{{ doc("gtfs_trips__route_id") }}'
      - name: service_id
        description: '{{ doc("gtfs_trips__service_id") }}'
      - name: trip_id
        description: '{{ doc("gtfs_trips__trip_id") }}'
      - name: trip_headsign
        description: '{{ doc("gtfs_trips__trip_headsign") }}'
      - name: trip_short_name
        description: '{{ doc("gtfs_trips__trip_short_name") }}'
      - name: direction_id
        description: '{{ doc("gtfs_trips__direction_id") }}'
      - name: block_id
        description: '{{ doc("gtfs_trips__block_id") }}'
      - name: shape_id
        description: '{{ doc("gtfs_trips__shape_id") }}'
      - name: wheelchair_accessible
        description: '{{ doc("gtfs_trips__wheelchair_accessible") }}'
      - name: bikes_allowed
        description: '{{ doc("gtfs_trips__bikes_allowed") }}'
      - *warning_duplicate_gtfs_key
      - *feed_timezone

exposures:
  - name: california_open_data
    type: application
    maturity: low
    url: https://data.ca.gov/dataset/cal-itp-gtfs-ingest-pipeline-dataset
    description: Latest-only GTFS Schedule data published to Caltrans CKAN instance.

    depends_on:
      - ref("dim_agency_latest")
      - ref("dim_areas_latest")
      - ref("dim_attributions_latest")
      - ref("dim_calendar_latest")
      - ref("dim_calendar_dates_latest")
      - ref("dim_fare_attributes_latest")
      - ref("dim_fare_leg_rules_latest")
      - ref("dim_fare_media_latest")
      - ref("dim_fare_products_latest")
      - ref("dim_fare_rules_latest")
      - ref("dim_fare_transfer_rules_latest")
      - ref("dim_feed_info_latest")
      - ref("dim_frequencies_latest")
      - ref("dim_gtfs_datasets_latest")
      - ref("dim_levels_latest")
      - ref("dim_pathways_latest")
      - ref("dim_routes_latest")
      - ref("dim_shapes_latest")
      - ref("dim_stop_areas_latest")
      - ref("dim_stop_times_latest")
      - ref("dim_stops_latest")
      - ref("dim_transfers_latest")
      - ref("dim_translations_latest")
      - ref("dim_trips_latest")

    owner:
      email: soren.s@jarv.us

    meta:
      methodology: |
        Cal-ITP collects the GTFS feeds from a statewide list every night and aggegrates it into a statewide table
        for analysis purposes only. Do not use for trip planner ingestion, rather is meant to be used for statewide
        analytics and other use cases. Note: These data may or may or may not have passed GTFS-Validation.
      coordinate_system_epsg: "4326"
      destinations:
        - type: ckan
          format: csv
          url: https://data.ca.gov
          resources:
            dim_agency_latest:
              id: e8f9d49e-2bb6-400b-b01f-28bc2e0e7df2
              description: |
                Each row is a cleaned row from an agency.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#agencytxt.
            dim_areas_latest:
              id: e6b684c0-5af1-4012-b7ef-0166808831a6
              description: |
                Each row is a cleaned row from an areas.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#areastxt.
            dim_attributions_latest:
              id: 038b7354-06e8-4082-a4a1-40debd3110d5
              description: |
                Each row is a cleaned row from an attributions.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#attributionstxt.
            dim_calendar_latest:
              id: a79f10b8-b322-43f3-b3f4-ba46a8dbe9ab
              description: |
                Each row is a cleaned row from a calendar.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#calendartxt.
            dim_calendar_dates_latest:
              id: 06a21a8e-dba3-4e7e-8726-f2e992cc1a80
              description: |
                Each row is a Each row is a cleaned rowrow from a calendar_dates.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#calendar_datestxt.
            dim_fare_attributes_latest:
              id: 9db51dfa-fd6d-481b-b655-96e8af722ab5
              description: |
                Each row is a cleaned row from a fare_attributes.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#fare_attributestxt.
            dim_fare_leg_rules_latest:
              id: ea5040fb-de2d-4011-a21e-fcf4a96fa80a
              description: |
                Each row is a cleaned row from an fare_leg_rules.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#fare_leg_rulestxt.
            dim_fare_media_latest:
              id: 7342e023-5855-4923-a3a9-0450eaf8fd17
              description: |
                Each row is a cleaned row from an fare_media.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#fare_mediatxt.
            dim_fare_products_latest:
              id: 060d905b-eda4-476f-98c9-ac5e712e13f6
              description: |
                Each row is a cleaned row from an fare_products.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#fare_productstxt.
            dim_fare_rules_latest:
              id: 4fb1fa39-0ef9-457d-97b1-bb7e9e848312
              description: |
                Each row is a cleaned row from a fare_rules.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#fare_rulestxt.
            dim_fare_transfer_rules_latest:
              id: a1002670-235c-41b2-be63-35f7a643ed92
              description: |
                Each row is a cleaned row from an fare_transfer_rules.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#fare_transfer_rulestxt.
            dim_feed_info_latest:
              id: 50d12559-635e-4222-ac25-3706c066902d
              description: |
                Each row is a cleaned row from a feed_info.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#feed_infotxt.
            dim_frequencies_latest:
              id: 48542c8f-8ce1-43e3-a965-6c68771d6fe5
              description: |
                Each row is a cleaned row from a frequencies.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#frequenciestxt.
            dim_gtfs_datasets_latest:
              id: e4ca5bd4-e9ce-40aa-a58a-3a6d78b042bd
              description: |
                Each record represents a GTFS dataset (feed), and provides
                base64-encoded URLs used to access that feed.
            dim_levels_latest:
              id: 288a08cd-7929-479e-aa88-08b677a08510
              description: |
                Each row is a cleaned row from a levels.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#levelstxt.
            dim_pathways_latest:
              id: a01484af-c460-40a4-ac8a-896b0196e8c2
              description: |
                Each row is a cleaned row from a pathways.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#pathwaystxt.
            dim_routes_latest:
              id: c6bbb637-988f-431c-8444-aef7277297f8
              description: |
                Each row is a cleaned row from a routes.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#routestxt.
            dim_shapes_latest:
              id: 2f5e7bdb-33e8-4633-b163-6bab42ad0951
              description: |
                Each row is a cleaned row from a shapes.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#shapestxt.
            dim_stop_areas_latest:
              id: ebd6109c-3ebb-4d3f-96ba-8d4c20961363
              description: |
                Each row is a cleaned row from an stop_areas.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#stop_areastxt.
            dim_stop_times_latest:
              id: d31eef2f-e223-4ca4-a86b-170acc6b2590
              description: |
                Each row is a cleaned row from a stop_times.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#stop_timestxt.
            dim_stops_latest:
              id: 8c876204-e12b-48a2-8299-10f6ae3d4f2b
              description: |
                Each row is a cleaned row from a stops.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#stopstxt.
            dim_transfers_latest:
              id: f8dcda5d-0c6d-4c70-b5f5-6716adcf6ffc
              description: |
                Each row is a cleaned row from a transfers.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#transferstxt.
            dim_translations_latest:
              id: 7abe9256-6cd2-4c1f-9b6a-72108022a382
              description: |
                Each row is a cleaned row from a translations.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#translationstxt.
            dim_trips_latest:
              id: 0e4da89e-9330-43f8-8de9-305cb7d4918f
              description: |
                Each row is a cleaned row from a trips.txt file.
                Definitions for the original GTFS fields are available at:
                https://gtfs.org/reference/static#tripstxt.


  - name: calitp_map_tile_server
    type: application
    maturity: low
    url: ""
    description: Just the shapes as map tiles
    depends_on:
      - ref("dim_shapes_arrays_latest")
    owner:
      email: andrew.v@jarv.us
    meta:
      destinations:
        - type: tiles
          bucket: gs://calitp-publish
          format: geojsonl # note that this is the intermediary format
          tile_format: mbtiles
          geo_column: pt_array
          layer_names:
            - GTFS Schedule Shapes (Latest)
