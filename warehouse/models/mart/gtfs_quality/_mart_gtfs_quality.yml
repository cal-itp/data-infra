version: 2

models:
  # TODO: once we have checks that occur above the feed level (e.g. organization)
  #   we will need to create additional daily check fact tables at the
  #   appropriate grain
  - name: fct_daily_schedule_feed_guideline_checks
    description: '{{ doc("fct_daily_schedule_feed_guideline_checks") }}'
    columns:
      - &key
        name: key
        tests: &primary_key_tests
          - unique
          - not_null
        meta: &pk_meta
          metabase.semantic_type: type/PK
      - &date
        name: date
        tests:
          - not_null
      - &schedule_feed_key
        name: feed_key
        tests:
          - not_null
          - relationships:
              to: ref('dim_schedule_feeds')
              field: key
      - name: status
      - &check
        name: check
        tests:
          - not_null
          - relationships:
              to: ref('stg_gtfs_quality__intended_checks')
              field: check
      - &status
        name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99

  - name: fct_daily_rt_feed_guideline_checks
    description: '{{ doc("fct_daily_rt_feed_guideline_checks") }}'
    tests:
    columns:
      - *key
      - *date
      - &base64_url
        name: base64_url
        tests:
          - not_null
      - *check
      # Reducing null_proportion minimum due to missing rows in rt_https check, due to missing data before Nov 22
      # This floor can be raised over time, as more data populates
      - name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.90

  - name: fct_daily_schedule_url_guideline_checks
    description: '{{ doc("fct_daily_schedule_url_guideline_checks") }}'
    columns:
      - *key
      - *date
      - *base64_url
      - *check

  - name: fct_daily_rt_feed_validation_notices
    description: |
      A daily model of validation notices found per feed. Data
      is filled in so there is always a count of notices per day
      per feed, even if that count is zero; null counts indicate
      a lack of validation for that feed on that day.
    tests:
      - dbt_utils.expression_is_true:
          expression: 'validated_extracts = validation_successes + validation_exceptions'
    columns:
      - *key
      - *date
      - name: code
        tests:
          - not_null
      - name: is_critical
        tests:
          - not_null
      - name: parsed_files
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
          - dbt_utils.expression_is_true:
              expression: '<= 4320'
      - name: validated_extracts
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
          - dbt_utils.expression_is_true:
              expression: '<= 4320'
      - name: validation_successes
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
          - dbt_utils.expression_is_true:
              expression: '<= 4320'
      - name: validation_exceptions
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
          - dbt_utils.expression_is_true:
              expression: '<= 4320'
      - name: total_notices

  - name: fct_daily_schedule_feed_validation_notices
    description: |
      A daily model of validation notices found per feed. Data
      is filled in so there is always a count of notices per day
      per feed, even if that count is zero; null counts indicate
      a lack of validation for that feed on that day.
    columns:
      - *key
      - *date
      - *schedule_feed_key
      - name: code
        tests:
          - not_null
      - name: severity
        tests:
          - not_null
      - name: validation_success
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
      - name: validation_exception
      - name: total_notices
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99

  - name: fct_implemented_checks
    description: |
      Contains the actually implemented checks, i.e. checks that
      show up in the underlying daily checks model. Tested against
      the "intended checks" to verify checks are actually implemented.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - check
            - feature
      - dbt_utils.equal_rowcount:
          compare_model: ref('stg_gtfs_quality__intended_checks')
      - dbt_utils.expression_is_true:
          expression: "is_implemented"
    columns:
      - name: is_implemented
  - name: fct_daily_guideline_checks
    description: |
      **Documentation coming soon**
    columns:
      - *key
      - *date
      - name: organization_name
        description: |
          Organization name as of date.
      - name: service_name
        description: |
          Service name as of date.
      - name: gtfs_dataset_name
        description: |
          GTFS dataset name as of date.
      - name: gtfs_dataset_type
        description: |
          GTFS dataset type as of date.
      - name: base64_url
        description: |
          GTFS dataset base 64 URL as of date.
      - name: organization_key
        description: |
          Foreign key to `dim_organizations`; note that this is a *historical* key value and
          so joins may result in some unexpected behavior (for example, deleted records will
          fail to join.)
      - name: service_key
        description: |
          Foreign key to `dim_services`; note that this is a *historical* key value and
          so joins may result in some unexpected behavior (for example, deleted records will
          fail to join.)
      - name: gtfs_service_data_key
        description: |
          Foreign key to `dim_gtfs_service_data`; note that this is a *historical* key value and
          so joins may result in some unexpected behavior (for example, deleted records will
          fail to join.)
      - name: gtfs_dataset_key
        description: |
          Foreign key to `dim_gtfs_datasets`; note that this is a *historical* key value and
          so joins may result in some unexpected behavior (for example, deleted records will
          fail to join.)
      - name: schedule_feed_key
        description: |
          Foreign key to `dim_schedule_feeds`. Because `dim_schedule_feeds` is a slowly-
          changing dimension, joins using this key are not subject to the historical
          limitations noted for the other foreign keys in this table.
      - *check
      - name: status
      - name: feature
  - name: fct_daily_organization_combined_guideline_checks
    description: |
      **Documentation coming soon**
    columns:
      - *key
      - *date
      - name: organization_name
        description: |
          Organization name as of date.
      - name: service_names_included_array
        description: |
          Array of service name values (as of date) that are included in this organization's assessment.
      - name: gtfs_dataset_names_included_array
        description: |
          Array of GTFS dataset name values (as of date) that are included in this organization's assessment.
      - name: base64_urls_included_array
        description: |
          Array of base 64 URL values (as of date) that are included in this organization's assessment.
      - name: organization_key
        description: |
          Foreign key to `dim_organizations`; note that this is a *historical* key value and
          so joins may result in some unexpected behavior (for example, deleted records will
          fail to join.)
      - name: service_keys_included_array
        description: |
          Array of service_key values for services included in this organization's assessment;
          note that this is a *historical* key value and so joins may result in some unexpected behavior
          (for example, deleted records will fail to join.)
      - name: gtfs_service_data_keys_included_array
        description: |
          Array of gtfs_service_data_key values for service/GTFS dataset relationships included in this
          organization's assessment; note that this is a *historical* key value and so joins may result in
          some unexpected behavior (for example, deleted records will fail to join.)
      - name: gtfs_dataset_keys_included_array
        description: |
          Array of gtfs_dataset values for GTFS datasets included in this organization's assessment;
          note that this is a *historical* key value and so joins may result in some unexpected behavior
          (for example, deleted records will fail to join.)
      - name: schedule_feed_keys_included_array
        description: |
          Array of schedule_feed_key values for schedule feed versions included in this organization's assessemnt;
          because `dim_schedule_feeds` is a slowly-changing dimension, joins using this key are not subject
          to the historical limitations noted for the other foreign keys in this table.
      - *check
      - name: status
      - name: feature
  - name: fct_daily_service_combined_guideline_checks
    description: |
      **Documentation coming soon**
    columns:
      - *key
      - *date
      - name: service_name
        description: |
          Service name as of date.
      - name: organization_names_included_array
        description: |
          Array of organization name values (as of date) that are included in this service's assessment.
      - name: gtfs_dataset_names_included_array
        description: |
          Array of GTFS dataset name values (as of date) that are included in this service's assessment.
      - name: base64_urls_included_array
        description: |
          Array of base 64 URL values (as of date) that are included in this service's assessment.
      - name: service_key
        description: |
          Foreign key to `dim_services`; note that this is a *historical* key value and
          so joins may result in some unexpected behavior (for example, deleted records will
          fail to join.)
      - name: organization_keys_included_array
        description: |
          Array of organization_key values for organizations included in this service's assessment;
          note that this is a *historical* key value and so joins may result in some unexpected behavior
          (for example, deleted records will fail to join.)
      - name: gtfs_service_data_keys_included_array
        description: |
          Array of gtfs_service_data_key values for service/GTFS dataset relationships included in this
          service's assessment; note that this is a *historical* key value and so joins may result in
          some unexpected behavior (for example, deleted records will fail to join.)
      - name: gtfs_dataset_keys_included_array
        description: |
          Array of gtfs_dataset values for GTFS datasets included in this service's assessment;
          note that this is a *historical* key value and so joins may result in some unexpected behavior
          (for example, deleted records will fail to join.)
      - name: schedule_feed_keys_included_array
        description: |
          Array of schedule_feed_key values for schedule feed versions included in this service's assessemnt;
          because `dim_schedule_feeds` is a slowly-changing dimension, joins using this key are not subject
          to the historical limitations noted for the other foreign keys in this table.
      - *check
      - name: status
      - name: feature

# TODO: This should be filled out once the reports site is actually migrated
#exposures:
#  - name: calitp_reports_site
#    type: application
#    maturity: medium
#    url: "reports.calitp.org"
#    description: Cal-ITP reports site
#    depends_on:
#      - ref(" ")
#    owner:
#      email: eric.d@jarv.us
