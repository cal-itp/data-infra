version: 2

models:
  # TODO: once we have checks that occur above the feed level (e.g. organization)
  #   we will need to create additional daily check fact tables at the
  #   appropriate grain
  - name: fct_daily_feed_guideline_checks
    description: |
      Union of all feed-level daily guideline checks; unique at
      the date/feed/check level.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - feed_key
            - check
    columns:
      - name: key
        tests: &primary_key_tests
          - unique
          - not_null
      - name: date
        tests:
          - not_null
      - name: feed_key
        tests:
          - not_null
      - name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99

  - name: fct_daily_schedule_feed_validation_notices
    description: |
      A daily model of validation notices found per feed. Data
      is filled in so there is always a count of notices per day
      per feed, even if that count is zero; null counts indicate
      a lack of validation for that feed on that day, though
      these can be interpolated for feeds that do not change
      day-to-day.
    columns:
      - name: key
        description: |
          Synthetic primary key constructed from date, feed_key, and code.
        tests: *primary_key_tests
      - name: date
        tests:
          - not_null
      - name: feed_key
        tests:
          - not_null
      - name: code
        tests:
          - not_null
      - name: severity
        tests:
          - not_null
      - name: validation_success
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
      - name: validation_exception
      - name: total_notices
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99

  - name: fct_daily_feed_guideline_checks
    description: |
      Indicates whether a given feed passed or failed a given check
      per day. A row will exist for every check, for every row
      from the index which is driven by fct_daily_schedule_feeds.
      Only contains checks that are performed at the feed level.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - feed_key
            - check
    columns:
      - name: date
        tests:
          - not_null
      - name: feed_key
        tests:
          - not_null
      - name: check
        tests:
          - not_null
      - name: feature
        tests:
          - not_null
      - name: status
        tests:
          - not_null

  - name: fct_implemented_checks
    description: |
      Contains the actually implemented checks, i.e. checks that
      show up in the underlying daily checks model. Tested against
      the "intended checks" to verify checks are actually implemented.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - check
            - feature
      - dbt_utils.equal_rowcount:
          compare_model: ref('stg_gtfs_quality__intended_checks')
      - dbt_utils.expression_is_true:
          expression: "is_implemented"
    columns:
      - name: is_implemented
