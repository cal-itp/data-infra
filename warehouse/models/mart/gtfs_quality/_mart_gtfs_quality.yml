version: 2

models:
  # TODO: once we have checks that occur above the feed level (e.g. organization)
  #   we will need to create additional daily check fact tables at the
  #   appropriate grain
  - name: fct_daily_schedule_feed_guideline_checks
    description: '{{ doc("fct_daily_schedule_feed_guideline_checks") }}'
    columns:
      - &key
        name: key
        tests: &primary_key_tests
          - unique
          - not_null
        meta: &pk_meta
          metabase.semantic_type: type/PK
      - &date
        name: date
        tests:
          - not_null
      - &schedule_feed_key
        name: feed_key
        tests:
          - not_null
          - relationships:
              to: ref('dim_schedule_feeds')
              field: key
      - name: status
      - &check
        name: check
        tests:
          - not_null
          - relationships:
              to: ref('stg_gtfs_quality__intended_checks')
              field: check
        meta:
          metabase.semantic_type: type/Title
      - &status
        name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99

  - name: fct_daily_rt_feed_guideline_checks
    description: '{{ doc("fct_daily_rt_feed_guideline_checks") }}'
    tests:
    columns:
      - *key
      - *date
      - &base64_url
        name: base64_url
        tests:
          - not_null
      - *check
      # Reducing null_proportion minimum due to missing rows in rt_https check, due to missing data before Nov 22
      # This floor can be raised over time, as more data populates
      - name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.90

  - name: fct_daily_schedule_url_guideline_checks
    description: '{{ doc("fct_daily_schedule_url_guideline_checks") }}'
    columns:
      - *key
      - *date
      - *base64_url
      - *check

  - name: fct_daily_rt_url_guideline_checks
    description: '{{ doc("fct_daily_rt_url_guideline_checks") }}'
    columns:
      - *key
      - *date
      - *base64_url
      - *check

  - name: fct_daily_rt_feed_validation_notices
    description: |
      A daily model of validation notices found per feed. Data
      is filled in so there is always a count of notices per day
      per feed, even if that count is zero; null counts indicate
      a lack of validation for that feed on that day.
    tests:
      - dbt_utils.expression_is_true:
          expression: 'validated_extracts = validation_successes + validation_exceptions'
    columns:
      - *key
      - *date
      - name: code
        tests:
          - not_null
      - name: is_critical
        tests:
          - not_null
      - name: parsed_files
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
          - dbt_utils.expression_is_true:
              expression: '<= 4320'
      - name: validated_extracts
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
          - dbt_utils.expression_is_true:
              expression: '<= 4320'
      - name: validation_successes
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
          - dbt_utils.expression_is_true:
              expression: '<= 4320'
      - name: validation_exceptions
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
          - dbt_utils.expression_is_true:
              expression: '<= 4320'
      - name: total_notices

  - name: fct_daily_schedule_feed_validation_notices
    description: |
      A daily model of validation notices found per feed. Data
      is filled in so there is always a count of notices per day
      per feed, even if that count is zero; null counts indicate
      a lack of validation for that feed on that day.
    columns:
      - *key
      - *date
      - *schedule_feed_key
      - name: code
        tests:
          # TODO: this should be 100% populated once backfill flakes are cleared
          - dbt_utils.not_null_proportion:
              at_least: 0.999
      - name: severity
        tests:
          # TODO: this should be 100% populated once backfill flakes are cleared
          - dbt_utils.not_null_proportion:
              at_least: 0.999
      - name: validation_success
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99
      - name: validation_exception
      - name: total_notices
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99

  - name: fct_implemented_checks
    description: |
      Contains the actually implemented checks, i.e. checks that
      show up in the underlying daily checks model. Tested against
      the "intended checks" to verify checks are actually implemented.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - check
            - feature
      - dbt_utils.equal_rowcount:
          compare_model: ref('stg_gtfs_quality__intended_checks')
      - dbt_utils.expression_is_true:
          expression: "is_implemented"
    columns:
      - name: is_implemented
  - name: fct_daily_guideline_checks
    description: '{{ doc("fct_daily_guideline_checks") }}'
    columns:
      - *key
      - *date
      - name: organization_name
        description: |
          Organization name as of date.
        meta:
          metabase.semantic_type: type/Title
      - name: service_name
        description: |
          Service name as of date.
        meta:
          metabase.semantic_type: type/Title
      - name: gtfs_dataset_name
        description: |
          GTFS dataset name as of date.
      - name: gtfs_dataset_type
        description: |
          GTFS dataset type as of date.
      - name: base64_url
        description: |
          GTFS dataset base 64 URL as of date.
      - name: organization_key
        description: |
          Foreign key to `dim_organizations`.
      - name: service_key
        description: |
          Foreign key to `dim_services`.
      - name: gtfs_service_data_key
        description: |
          Foreign key to `dim_gtfs_service_data`.
      - name: gtfs_dataset_key
        description: |
          Foreign key to `dim_gtfs_datasets`.
      - name: schedule_feed_key
        description: |
          Foreign key to `dim_schedule_feeds`.
      - *check
      - name: status
      - name: feature
  - name: fct_daily_organization_combined_guideline_checks
    description: |
      **Documentation coming soon**
    columns:
      - *key
      - *date
      - name: organization_name
        description: |
          Organization name as of date.
      - name: service_names_included_array
        description: |
          Array of service name values (as of date) that are included in this organization's assessment.
      - name: gtfs_dataset_names_included_array
        description: |
          Array of GTFS dataset name values (as of date) that are included in this organization's assessment.
      - name: base64_urls_included_array
        description: |
          Array of base 64 URL values (as of date) that are included in this organization's assessment.
      - name: organization_key
        description: |
          Foreign key to `dim_organizations`.
      - name: service_keys_included_array
        description: |
          Array of service_key values for services included in this organization's assessment.
      - name: gtfs_service_data_keys_included_array
        description: |
          Array of gtfs_service_data_key values for service/GTFS dataset relationships included in this
          organization's assessment.
      - name: gtfs_dataset_keys_included_array
        description: |
          Array of gtfs_dataset values for GTFS datasets included in this organization's assessment.
      - name: schedule_feed_keys_included_array
        description: |
          Array of schedule_feed_key values for schedule feed versions included in this organization's assessment.
      - *check
      - name: status
      - name: feature
  - name: fct_daily_service_combined_guideline_checks
    description: |
      **Documentation coming soon**
    columns:
      - *key
      - *date
      - name: service_name
        description: |
          Service name as of date.
      - name: organization_names_included_array
        description: |
          Array of organization name values (as of date) that are included in this service's assessment.
      - name: gtfs_dataset_names_included_array
        description: |
          Array of GTFS dataset name values (as of date) that are included in this service's assessment.
      - name: base64_urls_included_array
        description: |
          Array of base 64 URL values (as of date) that are included in this service's assessment.
      - name: service_key
        description: |
          Foreign key to `dim_services`.
      - name: organization_keys_included_array
        description: |
          Array of organization_key values for organizations included in this service's assessment.
      - name: gtfs_service_data_keys_included_array
        description: |
          Array of gtfs_service_data_key values for service/GTFS dataset relationships included in this
          service's assessment.
      - name: gtfs_dataset_keys_included_array
        description: |
          Array of gtfs_dataset values for GTFS datasets included in this service's assessment.
      - name: schedule_feed_keys_included_array
        description: |
          Array of schedule_feed_key values for schedule feed versions included in this service's assessment.
      - *check
      - name: status
      - name: feature
  - name: fct_schedule_feed_files
    description: |
      All files found in zipfiles downloaded in the GTFS schedule v2 pipeline.
      This includes files where unzipping failed because of invalid internal directory
      structures. This also includes files we don't ingest in the warehouse, for example
      files that are not part of the GTFS specification (but were present in the zipfile
      anyway.)
      It is possible to have more than one download per day in rare cases where
      an additional download was manually triggered, so note that there are
      cases where the same feed/file combination will appear more than once for a given date.
    columns:
      - *key
      - name: ts
        description: |
          Timestamp of download. Possible to have more than one download per day.
      - name: feed_key
        description:
          Foreign key to `dim_schedule_feeds`.
          This may be null if the unzip operation failed.
        tests:
          - relationships:
              to: ref('dim_schedule_feeds')
              field: key
      - name: original_filepath
        description: |
          The original full file path to this file in the zipfile.
          This may include directory names that were part of
          the zipfile's original internal structure.
        tests:
          - not_null
      - name: original_filename
        description: |
          The file name portion of the original file path
          (i.e., directories have been stripped away.)
        tests:
          - not_null
      - name: gtfs_filename
        description: |
            GTFS file name without extension, ex. "shapes".
            Guaranteed to be a known file type from GTFS specification.
            Null for files not included in specification or where unzipping failed.
      - name: unzip_success
        description: |
          Whether the unzip operation succeeded for this zipfile.
          If false, the associated zipfile's data will not be present in the warehouse.
      - name: unzip_exception
        description: |
          If not `unzip_success`, the exception that was encountered in the unzip operation.
      - name: parse_success
        description: |
          Whether we succeeded in converting the original file to JSONL and ingesting it
          into the warehouse.
          This can be null if the unzip operation failed or if this is not a file type
          that we ingest, for example files that are not part of the GTFS specification.
      - name: parse_exception
        description: |
          If not `parse_success`, the exception that was encountered when
          converting this file to JSONL.
      - name: base64_url
        tests:
          - not_null
      - name: string_url
        description: |
          Human readable string URL.
          Will not contain authorization parameters.
      - name: gtfs_dataset_key
        tests:
          - relationships:
              to: ref('dim_gtfs_datasets')
              field: key
      - name: gtfs_dataset_name
  - name: fct_rt_feed_fetch_errors
    description: |
      TODO
    columns:
      - name: id
      - name: event_type
      - name: groupid
      - name: eventid
      - name: projectid
      - name: message
      - name: title
      - name: location
      - name: culprit
      - name: user
      - name: tags
      - name: platform
      - name: datecreated
      - name: crashfile
      - name: dt
      - name: ts

# TODO: This should be filled out once the reports site is actually migrated
#exposures:
#  - name: calitp_reports_site
#    type: application
#    maturity: medium
#    url: "reports.calitp.org"
#    description: Cal-ITP reports site
#    depends_on:
#      - ref(" ")
#    owner:
#      email: eric.d@jarv.us
