version: 2

models:

  - name: int_transit_database__service_components_unnested
    description: |
      Version of `stg_transit_database__service_components` with all
      service, product, and component keys unnested.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - id
            - service_key
            - product_key
            - component_key
            - dt
      - dbt_utils.unique_combination_of_columns:
          severity: warn
          combination_of_columns:
            - service_key
            - product_key
            - component_key
            - dt
  - name: int_transit_database__urls_to_gtfs_datasets
    description: |
      Creates a 1:N relationship so any given extract/URL in the
      GTFS models can identify its source gtfs_datasets record.
      Because GTFS dataset history from Airtable starts later than GTFS schedule history (feeds downloaded by the pipeline),
      this mapping back-dates the first appearance of a URL in a GTFS dataset record to the beginning
      of history to allow a URL from the GTFS data to map to a dataset record even if that URL
      was being downloaded before that dataset record was created. I.e., if URL
      www.calitp.org/gtfs.zip was downloaded on January 1, 2022, but the first GTFS
      dataset record with that URL is record with key `123` and `123` doesn't appear until July 1, 2022,
      the January 1 download from www.calitp.org/gtfs.zip will still be mapped to GTFS dataset record `123`,
      even though it was downloaded outside the record's validity window, to facilitate some assignment of the
      GTFS feed data to organizations, services, etc.
    tests:
      - dbt_utils.mutually_exclusive_ranges:
          lower_bound_column: _valid_from
          upper_bound_column: _valid_to
          partition_by: base64_url
          gaps: required
    columns:
      - name: base64_url
        tests:
          - not_null
      - name: gtfs_dataset_key
        tests:
          - relationships:
              to: ref('dim_gtfs_datasets')
              field: key
              config:
                # four SMART urls and two test URLs that have been removed
                # will work once the dim is historical
                error_if: ">10"
                warn_if: ">0"
