version: 2

models:
  - name: int_gtfs_quality__schedule_feed_guideline_index
    description: |
      Daily index of v2 schedule feeds. Provides structure for
      individual check models to be joined together by day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - feed_key
            - date

  - name: int_gtfs_quality__schedule_url_guideline_index
    description: |
      Daily index of v2 schedule urls. Provides structure for
      individual check models to be joined together by day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - date

  - name: int_gtfs_quality__rt_feed_guideline_index
    description: |
      Daily index of v2 RT feeds. Provides structure for
      individual check models to be joined together by day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - date

  - name: int_gtfs_quality__rt_url_guideline_index
    description: |
      Daily index of v2 schedule urls. Provides structure for
      individual check models to be joined together by day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - base64_url
            - date

  - name: int_gtfs_quality__rt_validation_outcomes
    description: |
      Unioned, incremental table of RT validation outcomes.
    columns:
      - name: key
        tests:
          - not_null
          - unique

  - name: int_gtfs_quality__schedule_validation_severities
    description: |
      List of codes and their severity in the GTFS validator.
      TODO: this will need additional work when we deploy
      a new GTFS validator version.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - code
            - severity
            - gtfs_validator_version

  - name: int_gtfs_quality__daily_assessment_candidate_entities
    description: |
      A row here is a combination of an organization, service, service / GTFS dataset relationship,
      GTFS dataset, and schedule feed that existed as of the given date. This combined entity
      represents a candidate for GTFS guideline adherence assessment. The `assessed` column
      indicates whether the candidate was actually in scope for assessment on the given date, based on whether:
      * The organization had `reporting_category` = 'Core' or 'Other Public Transit'
      * The service was `currently_operating`
      * The service had `service_type` 'fixed-route'
      * The service/GTFS dataset relationship was `customer_facing` or had `category` = 'primary'
      (i.e., according to our data, was this dataset ingested by trip planners on this date
      to represent this service)

      Entities that fail any of the criteria will *not* be included as `assessed` for the given date.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - key
            - date
    columns:
      - name: key
        description: |
          Synthetic key from `organization_key`, `service_key`, `gtfs_service_data_key`, `gtfs_dataset_key`,
          and `schedule_feed_key`.
        tests:
          - not_null
      - name: date
        description: |
          Date on which this combination of records is present in our data.
      - name: organization_name
      - name: service_name
      - name: gtfs_dataset_name
      - name: gtfs_dataset_type
      - name: assessed
        description: |
          Boolean indicator for whether this combined entity met the criteria to be "assessed"
          on the given date. Applies "and" logic to `organization_assessed`, `service_assessed`,
          and `gtfs_service_data_assessed`.
      - name: organization_assessed
        description: |
          Boolean indicator for whether the given organization record met the criteria to be "assessed"
          on the given date, i.e., had `reporting_category` = 'Core' or 'Other Public Transit'.
      - name: service_assessed
        description: |
          Boolean indicator for whether the given organization record met the criteria to be "assessed"
          on the given date, i.e., was `currently_operating` and had `service_type` 'fixed-route'.
      - name: gtfs_service_data_assessed
        description: |
          Boolean indicator for whether the given service/GTFS dataset (`gtfs_service_data`) record met
          the criteria to be "assessed" on the given date, i.e., was `customer_facing` or had `category` = 'primary'.
      - name: base64_url
      - name: organization_key
        description: |
          Foreign key to `dim_organizations`.
      - name: service_key
        description: |
          Foreign key to `dim_services`.
      - name: gtfs_service_data_key
        description: |
          Foreign key to `dim_gtfs_service_data`.
      - name: gtfs_dataset_key
        description: |
          Foreign key to `dim_gtfs_datasets`.
      - name: schedule_feed_key
        description: |
          Foreign key to `dim_schedule_feeds`. Because `dim_schedule_feeds` is slowly-
          changing dimension, joins using this key are not subject to the historical
          limitations noted for the other foreign keys in this table.

  - name: int_gtfs_quality__feed_version_history
    description: |
      Describes attributes of the previous and following versions of each feed.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - feed_key
            - base64_url
      - dbt_utils.equal_rowcount:
          compare_model: ref('dim_schedule_feeds')

  - name: int_gtfs_quality__outcome_validator_versions
    description: |
      Unique observed validator versions for each extract.
    tests:
    - dbt_utils.unique_combination_of_columns:
        combination_of_columns:
          - dt
          - base64_url
          - ts
          - gtfs_validator_version

  # Schedule feed checks

  - name: int_gtfs_quality__no_schedule_validation_errors
    tests: &stg_gtfs_guideline_tests_schedule
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - feed_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__schedule_feed_guideline_index')
      - extreme_results
    columns: &stg_gtfs_guideline_columns
      - name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99

  - name: int_gtfs_quality__shapes_valid
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__shapes_file_present
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__technical_contact_listed
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__shapes_for_all_trips
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__include_tts
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__pathways_valid
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__complete_wheelchair_accessibility_data
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__no_7_day_feed_expiration
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__no_30_day_feed_expiration
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__passes_fares_validator
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__no_expired_services
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__persistent_ids_schedule
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__lead_time
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__modification_date_present
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__feed_aggregator_schedule
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - feed_key
            - aggregator
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__schedule_feed_guideline_index_aggregator')
      - extreme_results
    columns: *stg_gtfs_guideline_columns

# Schedule URL checks

  - name: int_gtfs_quality__schedule_download_success
    tests: &stg_gtfs_guideline_tests_schedule_url
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__schedule_url_guideline_index')
      - extreme_results
    columns: *stg_gtfs_guideline_columns

# RT feed checks

  - name: int_gtfs_quality__no_rt_validation_errors
    tests: &stg_gtfs_guideline_tests_rt
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__rt_feed_guideline_index')
      - extreme_results
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__trip_id_alignment
    tests: *stg_gtfs_guideline_tests_rt
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__rt_protobuf_error
    tests: *stg_gtfs_guideline_tests_rt
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__modification_date_present_rt
    tests: *stg_gtfs_guideline_tests_rt
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__rt_https
    tests: *stg_gtfs_guideline_tests_rt
    # Reducing null_proportion minimum due to missing rows in rt_https check, due to missing data before Nov 22
    # This floor can be raised over time, as more data populates
    columns:
      - name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.50

  - name: int_gtfs_quality__feed_aggregator_rt
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
            - aggregator
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__rt_feed_guideline_index_aggregator')
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__no_stale_vehicle_positions
    tests: &stale_rt_guideline_check_tests
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
      - extreme_results
    columns: &stale_rt_guideline_check_columns
      - name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.8

  - name: int_gtfs_quality__no_stale_trip_updates
    tests: *stale_rt_guideline_check_tests
    columns: *stale_rt_guideline_check_columns

  - name: int_gtfs_quality__no_stale_service_alerts
    tests: *stale_rt_guideline_check_tests
    columns: *stale_rt_guideline_check_columns

  - name: int_gtfs_quality__rt_20sec_vp
    tests: *stale_rt_guideline_check_tests
    columns: *stale_rt_guideline_check_columns

  - name: int_gtfs_quality__rt_20sec_tu
    tests: *stale_rt_guideline_check_tests
    columns: *stale_rt_guideline_check_columns

# RT URL checks

  - name: int_gtfs_quality__rt_feeds_present
    tests: &stg_gtfs_guideline_tests_rt_url
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__rt_url_guideline_index')
      - extreme_results
    columns: *stg_gtfs_guideline_columns

# MANUAL CHECKS

# --- Organization-level

  - name: int_gtfs_quality__contact_on_website
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - organization_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__organization_guideline_index')
    columns: *stg_gtfs_guideline_columns

# --- Dataset-level
# ----- Schedule only

  - name: int_gtfs_quality__shapes_accurate
    tests: &stg_gtfs_guideline_tests_dataset_schedule
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - gtfs_dataset_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__gtfs_dataset_schedule_guideline_index')
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__data_license
    tests: *stg_gtfs_guideline_tests_dataset_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__grading_scheme_v1
    tests: *stg_gtfs_guideline_tests_dataset_schedule
    columns: *stg_gtfs_guideline_columns

# ----- All 4 feeds

  - name: int_gtfs_quality__authentication_acceptable
    tests: &stg_gtfs_guideline_tests_dataset
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - gtfs_dataset_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__gtfs_dataset_guideline_index')
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__stable_url
    tests: *stg_gtfs_guideline_tests_dataset
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__link_to_dataset_on_website
    tests: *stg_gtfs_guideline_tests_dataset
    columns: *stg_gtfs_guideline_columns

# --- Service-level

  - name: int_gtfs_quality__trip_planner_schedule
    tests: &stg_gtfs_guideline_tests_service
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - service_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__services_guideline_index')
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__trip_planner_rt
    tests: *stg_gtfs_guideline_tests_service
    columns: *stg_gtfs_guideline_columns

# --- GTFS-service-data-level

  - name: int_gtfs_quality__fixed_routes_match
    tests: &stg_gtfs_guideline_tests_gtfs_service_data
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - gtfs_service_data_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__gtfs_service_data_guideline_index')
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__demand_responsive_routes_match
    tests: *stg_gtfs_guideline_tests_gtfs_service_data
    columns: *stg_gtfs_guideline_columns
