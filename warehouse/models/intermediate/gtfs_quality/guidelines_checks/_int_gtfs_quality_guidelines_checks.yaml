version: 2

models:

  # Schedule feed checks

  - name: int_gtfs_quality__no_schedule_validation_errors
    tests: &stg_gtfs_guideline_tests_schedule
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - feed_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__schedule_feed_guideline_index')
      - extreme_results
    columns: &stg_gtfs_guideline_columns
      - name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.99

  - name: int_gtfs_quality__shapes_valid
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__shapes_file_present
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__technical_contact_listed
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__shapes_for_all_trips
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__include_tts
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__pathways_valid
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__complete_wheelchair_accessibility_data
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__no_7_day_feed_expiration
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__no_30_day_feed_expiration
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__passes_fares_validator
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__no_expired_services
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__persistent_ids_schedule
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__lead_time
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__modification_date_present
    tests: *stg_gtfs_guideline_tests_schedule
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__feed_aggregator_schedule
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - feed_key
            - aggregator
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__schedule_feed_guideline_index_aggregator')
      - extreme_results
    columns: *stg_gtfs_guideline_columns

# Schedule URL checks

  - name: int_gtfs_quality__schedule_download_success
    tests: &stg_gtfs_guideline_tests_schedule_url
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__schedule_url_guideline_index')
    columns: *stg_gtfs_guideline_columns


# Schedule URL checks reindexed
# TODO: what kind of yaml do we want for these? specifically what tests

  - name: int_gtfs_quality__schedule_url_download_success

# Schedule + RT combined URL checks reindexed
# TODO: what kind of yaml do we want for these? specifically what tests

  - name: int_gtfs_quality__feed_aggregator

# RT feed checks reindexed
# TODO: what kind of yaml do we want for these? specifically what tests
  - name: int_gtfs_quality__trip_id_alignment

# RT feed checks

  - name: int_gtfs_quality__no_rt_validation_errors
    tests: &stg_gtfs_guideline_tests_rt
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__rt_feed_guideline_index')
      - extreme_results
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__trip_id_alignment
    tests: *stg_gtfs_guideline_tests_rt
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__rt_protobuf_error
    tests: *stg_gtfs_guideline_tests_rt
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__modification_date_present_rt
    tests: *stg_gtfs_guideline_tests_rt
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__rt_https
    tests: *stg_gtfs_guideline_tests_rt
    # Reducing null_proportion minimum due to missing rows in rt_https check, due to missing data before Nov 22
    # This floor can be raised over time, as more data populates
    columns:
      - name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.50

  - name: int_gtfs_quality__feed_aggregator_rt
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
            - aggregator
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__rt_feed_guideline_index_aggregator')
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__no_stale_vehicle_positions
    tests: &stale_rt_guideline_check_tests
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
      - extreme_results
    columns: &stale_rt_guideline_check_columns
      - name: status
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.8

  - name: int_gtfs_quality__no_stale_trip_updates
    tests: *stale_rt_guideline_check_tests
    columns: *stale_rt_guideline_check_columns

  - name: int_gtfs_quality__no_stale_service_alerts
    tests: *stale_rt_guideline_check_tests
    columns: *stale_rt_guideline_check_columns

  - name: int_gtfs_quality__rt_20sec_vp
    tests: *stale_rt_guideline_check_tests
    columns: *stale_rt_guideline_check_columns

  - name: int_gtfs_quality__rt_20sec_tu
    tests: *stale_rt_guideline_check_tests
    columns: *stale_rt_guideline_check_columns

# RT URL checks

  - name: int_gtfs_quality__rt_feeds_present
    tests: &stg_gtfs_guideline_tests_rt_url
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - base64_url
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__rt_url_guideline_index')
      - extreme_results
    columns: *stg_gtfs_guideline_columns

# MANUAL CHECKS

# --- Organization-level

  - name: int_gtfs_quality__contact_on_website
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - organization_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__organization_guideline_index')
    columns: *stg_gtfs_guideline_columns

# --- Dataset-level
# ----- Schedule only

  - name: int_gtfs_quality__shapes_accurate
    tests: &stg_gtfs_guideline_tests_dataset_schedule
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - gtfs_dataset_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__gtfs_dataset_schedule_guideline_index')
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__grading_scheme_v1
    tests: *stg_gtfs_guideline_tests_dataset_schedule
    columns: *stg_gtfs_guideline_columns

# ----- All 4 feeds

  - name: int_gtfs_quality__authentication_acceptable
    tests: &stg_gtfs_guideline_tests_dataset
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - gtfs_dataset_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__gtfs_dataset_guideline_index')
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__stable_url
    tests: *stg_gtfs_guideline_tests_dataset
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__link_to_dataset_on_website
    tests: *stg_gtfs_guideline_tests_dataset
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__data_license
    tests: *stg_gtfs_guideline_tests_dataset
    columns: *stg_gtfs_guideline_columns

# --- Service-level

  - name: int_gtfs_quality__trip_planner_schedule
    tests: &stg_gtfs_guideline_tests_service_manual
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - service_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__services_guideline_index')
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__trip_planner_rt
    tests: *stg_gtfs_guideline_tests_service_manual
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__all_tu_in_vp
    tests: &stg_gtfs_guideline_tests_service
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - service_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__services_guideline_index')
      - extreme_results
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__scheduled_trips_in_tu_feed
    tests: *stg_gtfs_guideline_tests_service
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__feed_listed_schedule
    tests: *stg_gtfs_guideline_tests_service
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__feed_listed_vp
    tests: *stg_gtfs_guideline_tests_service
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__feed_listed_tu
    tests: *stg_gtfs_guideline_tests_service
    columns: *stg_gtfs_guideline_columns

  - name: int_gtfs_quality__feed_listed_sa
    tests: *stg_gtfs_guideline_tests_service
    columns: *stg_gtfs_guideline_columns

# --- GTFS-service-data-level
# ----- Schedule only

  - name: int_gtfs_quality__demand_responsive_routes_match
    tests: &stg_gtfs_guideline_tests_gtfs_service_data_schedule
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - gtfs_service_data_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__gtfs_service_data_schedule_guideline_index')
    columns: *stg_gtfs_guideline_columns

# ----- All 4 feeds
  - name: int_gtfs_quality__fixed_routes_match
    tests: &stg_gtfs_guideline_tests_gtfs_service_data
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - gtfs_service_data_key
      - dbt_utils.equal_rowcount:
          compare_model: ref('int_gtfs_quality__gtfs_service_data_guideline_index')
    columns: *stg_gtfs_guideline_columns
