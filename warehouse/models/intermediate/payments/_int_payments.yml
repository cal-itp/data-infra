version: 2

models:
  - name: int_payments__authorisations_deduped
    description: |
      This model deduplicates authorisations rows with duplicate `_payments_key` values that require additional handling
      beyond what is covered in the staging model, essentially rows that require a join for deduplication.
      Columns have the same meanings as in the upstream staging model.
      The most important test for this model is on the upstream staging model: to ensure that no
      `_payments_key` values are fully dropped betweeen that model and this one (i.e., to ensure
      that all rows dropped do in fact have a duplicate and no authorisations are lost.)
    columns:
      - name: request_type
        tests:
          - accepted_values:
              values: ['AUTHORISATION', 'DEBT_RECOVERY_AUTHCHECK', 'DEBT_RECOVERY_REVERSAL', 'CARD_CHECK']
      - name: aggregation_id
        tests:
          - relationships:
              to: ref('int_payments__latest_authorisations_by_aggregation')
              field: aggregation_id
  - name: int_payments__latest_authorisations_by_aggregation
    description: |
      This model contains only the most recent authorisations data per `aggregation_id`.
      Many aggregations pass through a few different authorisations (for example, perhaps a card check
      before getting authorised, or multiple debt recovery attempts.) This model keeps only the most
      recent row according to `authorisation_date_time_utc`.
    columns:
      - &aggregation_pk
        name: aggregation_id
        description: |
          ID of the aggregation being summarized. An aggregation can contain or be associated with multiple
          micropayment, authorisation, and settlement events. It represents the unit at which settlement occurs
          (so multiple settlement events only occur for a single aggregation if there are refunds against the original settlement.)
        tests:
          - not_null
          - unique
  - name: int_payments__settlements_to_aggregations
    description: |
      This model contains Littlepay settlements aggregated to the `aggregation_id + retrieval_reference_number` level.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - aggregation_id
            - retrieval_reference_number
      - dbt_utils.expression_is_true:
          expression: "debit_amount + credit_amount = net_settled_amount_dollars"
      - dbt_utils.expression_is_true:
          expression: "contains_refund = (credit_amount < 0)"
    columns:
      - *aggregation_pk
      - name: retrieval_reference_number
        tests:
          - not_null
          - unique
      - name: participant_id
        description: '{{ doc("lp_participant_id") }}'
      - name: contains_imputed_type
        description: |
          Some settlements are missing `settlement_type` (i.e., `DEBIT` vs. `CREDIT` designation).
          We impute those missing values on the heuristic that first updates tend to be the debit
          and any subsequent updates are credits (refunds).
          Rows with "true" in this column indicate that at least one input row had its settlement type imputed.
          These rows could potentially (though we believe it is unlikely) be sources of error if the imputation
          assumptions were incorrect.
      - name: contains_refund
        description: |
          If `true`, this aggregation settlement included at least one row with settlement_type = `CREDIT`.
      - name: latest_update_timestamp
        description: |
          Most recent `settlement_requested_date_time_utc` value for this aggregation settlement.
          If a credit (refund) was issued after the initial debit, this will be the timestamp of the credit.
      - name: net_settled_amount_dollars
        description: |
          Net dollar amount of this aggregation settlement; if a refund (credit) has been issued,
          that will be reflected. So for example if $20 was debited and then $8 was credited,
          the value in this column will be `12` (= 20 - 8).
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true
      - name: debit_amount
        description: |
          Total dollar amount associated with debit settlements in this aggregation.
          Numbers in this column are positive because they represent amounts debited (charged) by the participant to the customer (rider);
          i.e., these values represent income for the participant (agency).
      - name: credit_amount
        description: |
          Total dollar amount associated with credit (refund) settlements in this aggregation.
          Numbers in this column are negative because they represent amounts credited (refunded) by the participant (agency) to the customer (rider);
          i.e., these values represent costs for the participant (agency).
  - name: int_payments__micropayments_to_aggregations
    description: |
      Littlepay micropayments grouped to the aggregation (`aggregation_id`) level.
    tests:
      - dbt_utils.expression_is_true:
          expression: "total_nominal_amount_dollars >= net_micropayment_amount_dollars"
    columns:
      - name: participant_id
      - *aggregation_pk
      - name: net_micropayment_amount_dollars
        description: |
          Sum of the `charge_amount` values for all micropayments in this aggregation.
          If there are credit (pre-settlement refund) micropayments in the aggregation,
          the value of those will have been subtracted from this total because they have
          negative `charge_amount` values.
          Post-settlement refunds will not be reflected since they are not recorded in the micropayments table.
      - name: total_nominal_amount_dollars
        description: |
          Sum of the `nominal_amount` values for all micropayments in this aggregation.
      - name: latest_transaction_time
        description: |
          Maximum (latest) transaction time for micropayments in this aggregation.
      - name: num_micropayments
        description: |
          Number of distinct micropayment ID values for micropayments in this aggregation.
      - name: contains_pre_settlement_refund
        description: |
          If "true", this aggregation contains a pre-settlement refund (i.e., contains a micropayment
          with `charge_type` "refund").
      - name: contains_variable_fare
        description: |
          If "true", this aggregation contains at least one micropayment with a variable fare charge type.
      - name: contains_flat_fare
        description: |
          If "true", this aggregation contains at least one micropayment with a `flat_fare` charge type.
      - name: contains_pending_charge
        description: |
          If "true", this aggregation contains at least one micropayment with a pending charge type.
      - name: contains_adjusted_micropayment
        description: |
          If "true", this aggregation contains at least one micropayment that had a micropayment
          adjustment applied. For example, micropayments that were reduced due to a fare cap being applied
          will have a "true" in this column.
